<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sistema de Pedidos - Refeições</title>
    <meta name="theme-color" content="#4f46e5">
    
    <!-- PWA Meta Tags - Configuração Nativa -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Refeições">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Sistema Refeições">
    
    <!-- Remover elementos de navegador no iOS -->
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Configurações para PWA standalone -->
    <meta name="mobile-web-app-title" content="Refeições">
    <meta name="apple-mobile-web-app-orientationlock" content="portrait">
    <meta name="screen-orientation" content="portrait">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon_PR_otimizado.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon_PR_otimizado.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon_PR_otimizado.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon_PR_otimizado.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNpc3RlbWEgZGUgUGVkaWRvcyAtIFJlZmVpw6fDtWVzIiwKICAic2hvcnRfbmFtZSI6ICJSZWZlacOnw7VlcyIsCiAgImRlc2NyaXB0aW9uIjogIlNpc3RlbWEgZGUgcGVkaWRvcyBkZSByZWZlacOnw7VlcyBjb3Jwb3JhdGl2YXMiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzI1NjNlYiIsCiAgInRoZW1lX2NvbG9yIjogIiMyNTYzZWIiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1UUTNJQ0JvWldsbmFIUTlJakUwTnlCMmFXVjNRbTk0UFNJd0lEQWdNVFEzSURFME55SWdabWxzYkQwaWJtOXVaU0lnZUcxc2JuTTlJbWgwZEhBNkx5OTNkM2N1ZHpNdWIzSm5Mekl3TURBdmMzWm5JajRLUEhKbFkzUWdkMmxrZEdnOUlqRTBOeUlnYUdWcFoyaDBQU0l4TkRjaUlHWnBiR3c5SWlNeU5UWXpaV0lpTHo0S1BIUmxlSFFnZUQwaU56TXVOU0lnZVQwaU9ERXVOeUlnWm05dWRDMW1ZVzFwYkhrOUluTmhibk10YzJWeWFXWWlJR1p2Ym5RdGMybDZaVDBpTVRZaUlHWnBiR3c5SW5kb2FYUmxJaUIwWlhoMExXRnVZMmh2Y2owaWJXbGtaR3hsUGlKOEwyUmxlSFErQ2p3dmMzWm5QZz09IiwKICAgICAgInNpemVzIjogIjE0NHgxNDQiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <!-- EmailJS Script -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- 🎯 MÓDULOS DO SISTEMA -->
    <script src="js/app-modules.js"></script>
    
    <!-- Sistema de Controle de Versão e Cache -->
    <script>
        // ⚠️ INCREMENTAR SEMPRE QUE HOUVER MUDANÇAS IMPORTANTES
        const APP_VERSION = '3.0.0'; // 🔥 REFATORAÇÃO COMPLETA: SupplierManager, CacheManager, FECHAMENTO corrigido
        const VERSION_KEY = 'app_version_refeicoes';
        
        // Verificar se precisa forçar atualização
        function checkForUpdates() {
            const storedVersion = localStorage.getItem(VERSION_KEY);
            
            if (!storedVersion || storedVersion !== APP_VERSION) {
                console.log(`🔄 Nova versão detectada: ${APP_VERSION} (anterior: ${storedVersion || 'N/A'})`);
                
                // 🔥 LIMPEZA AGRESSIVA PARA v3.0.0
                console.log('🧹 Limpando TUDO para v3.0.0...');
                
                // 1. Limpar TODOS os caches do Service Worker
                if ('caches' in window) {
                    caches.keys().then(names => {
                        console.log(`🗑️ Limpando ${names.length} caches do Service Worker...`);
                        names.forEach(name => {
                            caches.delete(name);
                            console.log(`   ✅ Cache deletado: ${name}`);
                        });
                    });
                }
                
                // 2. Limpar localStorage (exceto versão)
                const keysToPreserve = [VERSION_KEY];
                Object.keys(localStorage).forEach(key => {
                    if (!keysToPreserve.includes(key)) {
                        localStorage.removeItem(key);
                    }
                });
                console.log('🗑️ localStorage limpo');
                
                // 3. Limpar sessionStorage completamente
                sessionStorage.clear();
                console.log('🗑️ sessionStorage limpo');
                
                // 4. Limpar cookies do sistema
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                console.log('🗑️ Cookies limpos');
                
                // 5. Desregistrar Service Worker antigo
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        registrations.forEach(registration => {
                            registration.unregister();
                            console.log('🗑️ Service Worker desregistrado');
                        });
                    });
                }
                
                // Salvar nova versão
                localStorage.setItem(VERSION_KEY, APP_VERSION);
                
                // Mostrar alerta de atualização (com delay para processar limpeza)
                setTimeout(() => {
                    alert(
                        `🔥 ATUALIZAÇÃO IMPORTANTE - v${APP_VERSION}\n\n` +
                        `⚠️ MUDANÇAS CRÍTICAS:\n` +
                        `• Sistema completamente refatorado\n` +
                        `• Correção do campo FECHAMENTO\n` +
                        `• Cache inteligente implementado\n` +
                        `• Performance melhorada\n\n` +
                        `✅ Cache limpo automaticamente\n` +
                        `✅ Tudo pronto para uso! 🚀\n\n` +
                        `📱 Se tiver problemas, feche e reabra o app.`
                    );
                    
                    // 6. Recarregar página com força total após confirmar
                    setTimeout(() => {
                        window.location.href = window.location.href.split('?')[0] + '?v=' + Date.now();
                    }, 1000);
                }, 1500);
            }
        }
        
        // 🔥 FUNÇÃO DE EMERGÊNCIA - Forçar atualização total
        function forcarAtualizacaoTotal() {
            const confirmar = confirm(
                '🔥 FORÇAR ATUALIZAÇÃO COMPLETA\n\n' +
                'Isso vai:\n' +
                '• Limpar TODO o cache\n' +
                '• Desinstalar Service Worker\n' +
                '• Recarregar com versão nova\n' +
                '• VOCÊ VAI PERDER O LOGIN SALVO\n\n' +
                '⚠️ Use apenas se estiver com problemas!\n\n' +
                'Continuar?'
            );
            
            if (!confirmar) return;
            
            console.log('🔥 FORÇANDO ATUALIZAÇÃO TOTAL...');
            
            // 1. Limpar storage completo
            localStorage.clear();
            sessionStorage.clear();
            
            // 2. Limpar cookies
            document.cookie.split(";").forEach(c => { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            // 3. Limpar caches do SW
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            
            // 4. Desregistrar SW
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(reg => reg.unregister());
                });
            }
            
            alert('✅ Limpeza concluída!\n\nO app vai recarregar agora.');
            
            // 5. Recarregar com força máxima
            setTimeout(() => {
                window.location.href = window.location.href.split('?')[0] + '?force=' + Date.now();
            }, 500);
        }
        
        // Executar verificação ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            checkForUpdates();
            
            // Atualizar versão no display
            const versionDisplay = document.getElementById('appVersionDisplay');
            if (versionDisplay) {
                versionDisplay.textContent = APP_VERSION;
            }
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            /* PWA - Remove seleção de texto e ajustes mobile */
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            /* Suporte para notch e safe area */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Estilos específicos para PWA standalone */
        @media (display-mode: standalone) {
            body {
                background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
                /* Remove barras de rolagem em PWA */
                overflow-x: hidden;
            }
            
            .header {
                /* Ajuste para PWA sem status bar */
                padding-top: calc(20px + env(safe-area-inset-top));
            }
        }
        
        /* iOS PWA específico */
        @media (display-mode: standalone) and (-webkit-min-device-pixel-ratio: 2) {
            .header {
                background: #4f46e5;
                /* Gradiente mais suave para iOS */
                background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            }
            
            body {
                -webkit-touch-callout: none;
                -webkit-tap-highlight-color: transparent;
                overscroll-behavior: none;
            }
        }

        /* PWA - Ajustes para modo standalone */
        @media all and (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .header {
                padding-top: calc(20px + env(safe-area-inset-top));
            }
        }

        /* PWA - Ajustes para iOS */
        @supports (-webkit-appearance: none) {
            .container {
                min-height: 100vh;
                min-height: -webkit-fill-available;
            }
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            width: 100%;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .login-screen, .main-screen {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        /* Estilos para o campo da cidade */
        .btn-sm {
            width: auto;
            padding: 8px 12px;
            font-size: 14px;
            margin: 0;
            min-width: 40px;
        }

        .btn-outline-primary {
            background: transparent;
            border: 2px solid #2563eb;
            color: #2563eb;
        }

        .btn-outline-primary:hover {
            background: #2563eb;
            color: white;
        }

        .btn-outline-secondary {
            background: transparent;
            border: 2px solid #6b7280;
            color: #6b7280;
        }

        .btn-outline-secondary:hover {
            background: #6b7280;
            color: white;
        }

        #serviceCityInput[readonly] {
            background-color: #f9fafb;
            cursor: default;
        }

        .text-muted {
            color: #6b7280;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        /* Estilos para os novos campos */
        .btn-outline-success {
            background: transparent;
            border: 2px solid #059669;
            color: #059669;
        }

        .btn-outline-success:hover {
            background: #059669;
            color: white;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            width: auto;
        }

        .btn-whatsapp:hover {
            background: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }

        .other-participant-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .other-participant-item input {
            flex: 1;
            margin: 0;
        }

        .remove-participant-btn {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .remove-participant-btn:hover {
            background: #b91c1c;
        }

        #hotelFields {
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
            margin-top: 10px;
        }

        /* Estilos do Popup */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-content {
            background: white;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: popupSlideIn 0.3s ease;
        }

        .popup-header {
            background: #059669;
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }

        .popup-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .popup-body {
            padding: 20px;
            text-align: center;
        }

        .popup-body p {
            margin: 10px 0;
            color: #374151;
        }

        .popup-actions {
            padding: 0 20px 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .popup-actions .btn {
            flex: 1;
            margin: 0;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Estilos para o botão de problema com refeição */
        .btn-problem {
            background: #dc2626;
            color: white;
            border: 2px solid #dc2626;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            margin-bottom: 15px;
        }

        .btn-problem:hover {
            background: #b91c1c;
            border-color: #b91c1c;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
        }

        .btn-problem:active {
            transform: translateY(0);
        }

        /* Melhorias na seção de boas-vindas */
        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .welcome-section h2 {
            margin-bottom: 8px;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.025em;
        }

        .welcome-section p {
            margin: 0;
            color: #64748b;
            font-size: 16px;
            font-weight: 500;
        }

        .logout-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        .logout-btn:active {
            transform: translateY(0);
        }

        /* ==========  NOVOS ESTILOS PARA CARDS DA TELA PRINCIPAL ========== */
        .main-buttons-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 0 5px;
        }

        .main-button-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
            animation: slideInUp 0.6s ease-out;
        }

        .main-button-card:nth-child(1) { animation-delay: 0.1s; }
        .main-button-card:nth-child(2) { animation-delay: 0.2s; }
        .main-button-card:nth-child(3) { animation-delay: 0.3s; }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-button-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .main-button-card:hover::before {
            left: 100%;
        }

        .main-button-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #cbd5e1;
        }

        .main-button-card:active {
            transform: translateY(-2px);
        }

        .button-icon {
            font-size: 32px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .main-button-card.update-card .button-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .main-button-card.problem-card .button-icon {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .button-content {
            flex: 1;
            text-align: left;
        }

        .button-content h3 {
            margin: 0 0 4px 0;
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            letter-spacing: -0.025em;
        }

        .button-content p {
            margin: 0;
            font-size: 14px;
            color: #64748b;
            font-weight: 400;
        }

        .button-arrow {
            font-size: 20px;
            color: #94a3b8;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .main-button-card:hover .button-arrow {
            color: #475569;
            transform: translateX(4px);
        }

        /* Estados especiais para cards */
        .main-button-card:disabled,
        .main-button-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .main-button-card:disabled:hover,
        .main-button-card.disabled:hover {
            transform: none !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Loading state para o card de atualizar */
        .main-button-card.loading .button-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive para telas maiores */
        @media (min-width: 768px) {
            .main-buttons-grid {
                grid-template-columns: 1fr 1fr;
                gap: 24px;
            }
            
            .main-button-card:first-child {
                grid-column: 1 / -1;
            }
        }

        @media (min-width: 1024px) {
            .main-buttons-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
            
            .main-button-card:first-child {
                grid-column: auto;
            }
        }

        /* Estilos para áreas de foto */
        .foto-area {
            flex: 1;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f9f9f9;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .foto-area:hover {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .foto-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Estilos para o formulário de problema */
        .problem-photos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            position: relative;
        }

        .photo-upload-area:hover {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .photo-upload-area.has-image {
            padding: 0;
            border: none;
        }

        .photo-upload-area img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
        }

        .photo-upload-text {
            color: #6b7280;
            font-size: 12px;
            margin-top: 8px;
        }

        .photo-upload-icon {
            font-size: 24px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .meal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .meal-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .meal-option:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }

        .meal-option input {
            margin: 0;
            min-width: 16px;
        }

        .meal-option input:checked {
            accent-color: #2563eb;
        }

        .meal-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .meal-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 80px;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 10px;
            gap: 5px;
        }

        .meal-button:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
            transform: translateY(-2px);
        }

        .meal-button.selected {
            border-color: #2563eb;
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .meal-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .meal-text {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }

        .supplier-dropdown {
            flex: 1;
            max-width: 500px; /* Esticou mais o balão */
            animation: slideIn 0.3s ease;
            width: 100%;
        }

        .supplier-row {
            display: flex;
            gap: 15px; /* Aumentou o espaçamento */
            align-items: flex-start;
            margin-top: 10px; /* Espaço do dropdown */
        }

        .supplier-section {
            flex: 2.5; /* Mais espaço para o nome do fornecedor */
            min-width: 0;
        }

        .price-section {
            flex: 1.5; /* Espaço adequado para o valor */
            min-width: 120px;
            display: none; /* Escondido por padrão */
        }

        .price-section.show {
            display: flex; /* Usa flex para manter o alinhamento lado a lado */
            flex-direction: column;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .supplier-dropdown select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
        }

        .supplier-dropdown select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        /* Estilos específicos para iOS/iPhone */
        @supports (-webkit-touch-callout: none) {
            .supplier-dropdown select {
                -webkit-appearance: none;
                appearance: none;
                background-color: white;
                border: 2px solid #d1d5db;
                border-radius: 12px;
                padding: 14px 40px 14px 15px;
                font-size: 16px; /* Evita zoom no iOS */
                color: #374151;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 18px;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .supplier-dropdown select:focus {
                border-color: #2563eb;
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15), 0 4px 12px rgba(0,0,0,0.15);
                outline: none;
            }
        }

        .supplier-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: slideIn 0.3s ease;
        }

        .supplier-input:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            outline: none;
        }

        .supplier-input::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        /* Animações para notificações iOS */
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
        }

        .price-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: right;
            font-weight: 600;
        }

        .price-input:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
            outline: none;
        }

        .price-input::placeholder {
            color: #9ca3af;
            font-style: italic;
            text-align: center;
        }

        @media (max-width: 768px) {
            .meal-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .meal-button {
                width: 100%;
                height: 70px;
                flex-direction: row;
                justify-content: flex-start;
                padding-left: 20px;
                gap: 15px;
            }
            
            .meal-text {
                font-size: 14px;
            }
            
            .supplier-dropdown {
                max-width: none;
            }

            .supplier-row {
                flex-direction: row; /* Mantém lado a lado mesmo no mobile */
                gap: 8px;
                flex-wrap: wrap; /* Permite quebra se necessário */
            }

            .supplier-section, .price-section {
                flex: 1;
                min-width: 120px; /* Garante largura mínima */
            }
        }

        .employees-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
        }

        .employee-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .employee-item:hover {
            background: #f8fafc;
        }

        .employee-item input:checked + span {
            background: #ecfdf5;
            font-weight: 600;
            border-radius: 6px;
            padding: 4px 8px;
        }

        .employee-item input:checked {
            accent-color: #059669;
        }

        .employee-item input {
            margin: 0;
            min-width: 16px;
        }

        .summary {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary h3 {
            margin-bottom: 15px;
            color: #374151;
        }

        .summary-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .summary-total {
            border-top: 2px solid #e5e7eb;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .pending-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #d97706;
            animation: pulse-warning 3s infinite;
        }

        .pending-count {
            background: #dc2626;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            min-width: 30px;
        }

        .blinking {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes pulse-warning {
            0% { 
                background: #fef3c7;
                border-left-color: #d97706;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            50% { 
                background: #fde68a;
                border-left-color: #f59e0b;
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            }
            100% { 
                background: #fef3c7;
                border-left-color: #d97706;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        }

        .pending-item {
            background: white;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse-item 4s infinite;
        }

        .pending-item:hover {
            border-color: #d97706;
            transform: translateY(-1px);
            animation-play-state: paused;
        }

        @keyframes pulse-item {
            0% { 
                border-color: #fbbf24;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            50% { 
                border-color: #f59e0b;
                box-shadow: 0 4px 8px rgba(245, 158, 11, 0.2);
            }
            100% { 
                border-color: #fbbf24;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        }

        .pending-item h4 {
            margin-bottom: 5px;
            color: #92400e;
            font-size: 14px;
        }

        .pending-item p {
            margin: 0;
            font-size: 13px;
            color: #6b7280;
        }

        .sync-status {
            position: absolute;
            top: 10px;
            right: 15px;
            padding: 6px 10px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 600;
            background: #10b981;
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            animation: pulse-green 2s infinite;
            z-index: 10;
        }

        .sync-status.offline {
            background: #ef4444;
            color: white;
            animation: none;
        }

        @keyframes pulse-green {
            0% { 
                background: #10b981;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            50% { 
                background: #059669;
                box-shadow: 0 2px 12px rgba(16, 185, 129, 0.4);
            }
            100% { 
                background: #10b981;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
        }

        @keyframes pulse-orange {
            0% { 
                background: #f59e0b;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            50% { 
                background: #d97706;
                box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);
            }
            100% { 
                background: #f59e0b;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
        }

        @keyframes pulse-purple {
            0% { 
                background: #8b5cf6;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            50% { 
                background: #7c3aed;
                box-shadow: 0 2px 12px rgba(139, 92, 246, 0.4);
            }
            100% { 
                background: #8b5cf6;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
        }

        .temp-info {
            background: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .temp-info h3 {
            margin-bottom: 8px;
            color: #1d4ed8;
            font-size: 16px;
        }

        .temp-phase {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #0ea5e9;
        }

        .temp-phase h4 {
            margin-bottom: 5px;
            color: #0369a1;
            font-size: 14px;
        }

        .temp-next {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .temp-phase-card {
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .temp-phase-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 16px rgba(0,123,255,0.1);
        }

        .temp-phase-card h4 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            font-size: 1.1em;
            font-weight: 600;
        }

        .temp-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .file-preview {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px dashed #dee2e6;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.9em;
        }

        .file-preview.has-file {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .observations-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }

        .temp-phases-container {
            display: block;
            margin-bottom: 25px;
        }

        .temp-phases-container .temp-phase-card {
            margin-bottom: 20px;
            width: 100%;
        }

        .temp-phases-container .temp-phase-card h4 {
            font-size: 1em;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin: -20px -20px 20px -20px;
        }

        .temp-phases-container .form-group label {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .temp-phases-container .form-control {
            font-size: 0.9em;
            padding: 10px;
        }

        .temp-phases-container .file-preview {
            font-size: 0.8em;
            min-height: 35px;
            padding: 8px;
        }
        
        .file-preview canvas {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 10px;
        }
        
        .file-preview.has-image {
            background: #e8f5e8;
            border-color: #10b981;
        }
        
        .file-preview.has-image span {
            color: #10b981;
            font-weight: 500;
        }

        .temp-phases-container .photo-options .btn {
            font-size: 0.8em;
            padding: 8px 16px;
        }

        .photo-options {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .photo-options .btn {
            flex: 1;
            margin-bottom: 0;
            font-size: 14px;
            padding: 12px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .photo-options .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #filePreview img {
            max-width: 100%;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        #filePreview .file-info {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .hidden {
            display: none !important;
        }

        /* Estilos para itens pendentes de sincronização */
        .pending-sync {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%) !important;
            border: 2px solid #f59e0b !important;
            position: relative;
            animation: pendingSyncPulse 2s infinite;
        }

        .pending-sync::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #f59e0b, #d97706, #f59e0b);
            border-radius: 12px;
            z-index: -1;
            animation: pendingSyncBorder 3s infinite;
        }

        @keyframes pendingSyncPulse {
            0%, 100% { 
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            }
            50% { 
                box-shadow: 0 4px 16px rgba(245, 158, 11, 0.6);
            }
        }

        @keyframes pendingSyncBorder {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        .back-btn {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            padding: 5px 0;
        }

        /* RESPONSIVIDADE MOBILE */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
                margin: 0;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 18px;
                margin-right: 70px;
            }
            
            .header p {
                font-size: 12px;
                margin-right: 70px;
            }
            
            .sync-status {
                top: 8px;
                right: 10px;
                padding: 4px 8px;
                font-size: 9px;
                gap: 3px;
            }
            
            .login-screen, .main-screen {
                padding: 15px;
            }
            
            .form-control {
                padding: 10px 12px;
                font-size: 16px;
            }
            
            .btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .meal-option {
                padding: 10px;
                gap: 8px;
            }
            
            .meal-option span {
                font-size: 14px;
            }
            
            .employee-item {
                padding: 10px;
                gap: 8px;
            }
            
            .employee-item span {
                font-size: 13px;
            }
            
            .employees-list {
                max-height: 250px;
                padding: 8px;
            }
            
            .summary {
                padding: 15px;
            }
            
            .summary-line {
                font-size: 12px;
            }
            
            .pending-header {
                padding: 12px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .pending-header h3 {
                font-size: 14px;
                margin: 0;
            }
            
            .pending-item {
                padding: 12px;
            }
            
            .pending-item h4 {
                font-size: 13px;
            }
            
            .pending-item p {
                font-size: 12px;
            }
            
            .temp-info {
                padding: 12px;
            }
            
            .temp-info h3 {
                font-size: 14px;
            }
            
            .temp-phase {
                padding: 12px;
            }
            
            .temp-phase h4 {
                font-size: 13px;
            }
            
            .photo-options {
                flex-direction: column;
                gap: 8px;
            }
            
            .photo-options .btn {
                font-size: 13px;
                padding: 10px;
            }
            
            /* Ajustes específicos para formulários */
            textarea.form-control {
                min-height: 80px;
                resize: vertical;
            }
            
            /* Botões de ação principais */
            .btn-primary, .btn-success {
                font-size: 15px;
                padding: 13px;
                font-weight: 700;
            }
            
            /* Estilos específicos para selects em mobile */
            .supplier-dropdown select {
                padding: 12px 40px 12px 15px;
                font-size: 16px; /* Evita zoom automático no iOS */
                border-radius: 12px;
                max-width: 100%;
                /* overflow: hidden; REMOVIDO - permite nome completo */
                /* text-overflow: ellipsis; REMOVIDO - permite nome completo */
                /* white-space: nowrap; REMOVIDO - permite quebra de linha */
                line-height: 1.3;
                -webkit-appearance: none;
                appearance: none;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 18px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .supplier-dropdown select option {
                padding: 12px 15px;
                font-size: 16px;
                max-width: 100%;
                /* overflow: hidden; REMOVIDO - permite nome completo */
                /* text-overflow: ellipsis; REMOVIDO - permite nome completo */
                /* white-space: nowrap; REMOVIDO - permite quebra de linha */
                line-height: 1.4;
                background: white;
                color: #374151;
                word-wrap: break-word; /* Quebra palavras longas se necessário */
            }
            
            /* Específico para iOS - remove todos os estilos nativos */
            @supports (-webkit-touch-callout: none) {
                .supplier-dropdown select {
                    -webkit-appearance: none !important;
                    appearance: none !important;
                    background-color: white !important;
                    border: 2px solid #d1d5db !important;
                    border-radius: 12px !important;
                    padding: 14px 40px 14px 15px !important;
                    font-size: 16px !important;
                    color: #374151 !important;
                    box-shadow: 0 2px 12px rgba(0,0,0,0.15) !important;
                    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e") !important;
                    background-repeat: no-repeat !important;
                    background-position: right 12px center !important;
                    background-size: 18px !important;
                }
                
                .supplier-dropdown select:focus {
                    border-color: #2563eb !important;
                    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2), 0 4px 16px rgba(0,0,0,0.2) !important;
                    outline: none !important;
                }
            }
        }

        /* RESPONSIVIDADE TABLET */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                max-width: 500px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .sync-status {
                font-size: 11px;
                padding: 7px 11px;
            }
            
            .login-screen, .main-screen {
                padding: 25px;
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .loading-content {
            background: white;
            padding: 40px 50px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .loading-subtitle {
            font-size: 14px;
            color: #666;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">⏳ Salvando refeições...</div>
            <div class="loading-subtitle">Processando pedidos no banco de dados</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>🍽️ Sistema de Pedidos</h1>
            <p>Refeições Corporativas</p>
            
            <!-- Status de Sincronização -->
            <div class="sync-status" id="syncStatus">
                <span id="syncIcon">📶</span>
                <span id="syncText">Online</span>
            </div>
            
            <!-- Contador de Fila Offline -->
            <div id="offlineQueue" class="sync-status hidden" style="right: 15px; top: 50px; background: #f59e0b; animation: pulse-orange 2s infinite;">
                <span>📬</span>
                <span id="queueCount">0</span>
                <span>pendentes</span>
            </div>
            
            <!-- Contador de Fila Banco de Dados -->
            <div id="databaseQueue" class="sync-status hidden" style="right: 15px; top: 90px; background: #8b5cf6; animation: pulse-purple 2s infinite;">
                <span>💾</span>
                <span id="dbQueueCount">0</span>
                <span>banco</span>
            </div>
        </div>

        <!-- Tela de Login -->
        <div id="loginScreen" class="login-screen">
            <!-- Indicador de Login Salvo -->
            <div id="loginSalvoIndicador" style="display: none; background: #e7f3ff; border: 1px solid #b8daff; border-radius: 8px; padding: 12px; margin-bottom: 20px; text-align: center;">
                <div style="color: #0066cc; font-size: 14px; font-weight: 500;">
                    🔐 Login Salvo Encontrado
                </div>
                <div id="loginSalvoInfo" style="color: #0066cc; font-size: 12px; margin-top: 4px;">
                    Carregando automaticamente...
                </div>
            </div>
            
            <div class="form-group">
                <label for="equipeInput">Digite sua EQUIPE:</label>
                <input type="text" class="form-control" id="equipeInput" placeholder="Ex: 700TA" autocomplete="off" onkeypress="if(event.key==='Enter') loginEquipe()">
            </div>
            <button class="btn btn-primary" onclick="loginEquipe()">Entrar</button>
            
            <!-- Botão para limpar cache -->
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-outline-secondary btn-sm" onclick="limparCacheCompleto()" style="font-size: 12px; padding: 8px 16px;">
                    🧹 Limpar Cache
                </button>
                <p style="font-size: 11px; color: #666; margin-top: 5px; margin-bottom: 3px;">
                    Use se houver problemas de sincronização
                </p>
                <p style="font-size: 10px; color: #999; margin: 0;">
                    v<span id="appVersionDisplay">3.0.0</span> <!-- 🔥 ATUALIZAR AQUI TAMBÉM -->
                </p>
                
                <!-- 🆕 BOTÃO DE EMERGÊNCIA -->
                <button class="btn btn-outline-secondary btn-sm" onclick="forcarAtualizacaoTotal()" 
                        style="font-size: 11px; padding: 6px 12px; margin-top: 8px; background: #dc2626; color: white; border-color: #dc2626;">
                    🔥 Forçar Atualização v3.0
                </button>
            </div>
        </div>

        <!-- Tela Principal -->
        <div id="mainScreen" class="main-screen hidden">
            <div class="welcome-section">
                <h2>Bem-vindo!</h2>
                <p id="nomeUsuario"></p>
                <button class="logout-btn" onclick="fazerLogout()">
                    🚪 Sair
                </button>
            </div>

            <!-- Botões principais -->
            <div class="main-buttons-grid">
                <div class="main-button-card" onclick="doShowNewOrder()">
                    <div class="button-icon">➕</div>
                    <div class="button-content">
                        <h3>Novo Pedido</h3>
                        <p>Criar um novo pedido de refeição</p>
                    </div>
                    <div class="button-arrow">→</div>
                </div>
                
                <div class="main-button-card update-card" onclick="atualizarTodosDados()" id="btn-atualizar-dados">
                    <div class="button-icon">🔄</div>
                    <div class="button-content">
                        <h3>Atualizar Dados</h3>
                        <p>Sincronizar informações do servidor</p>
                    </div>
                    <div class="button-arrow">→</div>
                </div>
                
                <div class="main-button-card problem-card" onclick="abrirPopupProblema()">
                    <div class="button-icon">🚨</div>
                    <div class="button-content">
                        <h3>Problema</h3>
                        <p>Reportar problema com refeição</p>
                    </div>
                    <div class="button-arrow">→</div>
                </div>
            </div>

            <!-- Pendências de Temperatura -->
            <div id="pendingTemperatures">
                <div class="pending-header" style="display: none;" id="pendingHeader">
                    <h3>🌡️ Pendências de Temperatura</h3>
                    <span class="pending-count blinking" id="pendingCount">0</span>
                </div>
                <div id="pendingList"></div>
            </div>
        </div>

        <!-- Tela de Novo Pedido -->
        <div id="orderScreen" class="main-screen hidden">
            <button class="back-btn" onclick="doShowMain()">← Voltar</button>
            
            <h2>Novo Pedido</h2>

            <!-- Data Retirada -->
            <div class="form-group">
                <label for="withdrawalDateInput">📅 Data da Retirada</label>
                <input type="date" class="form-control" id="withdrawalDateInput" required>
            </div>

            <!-- Campo da Cidade -->
            <div class="form-group">
                <label for="serviceCityInput">🌍 Cidade de Prestação do Serviço</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" class="form-control" id="serviceCityInput" 
                           placeholder="Detectando localização..." readonly>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="detectLocationBtn" 
                            onclick="detectLocation()" title="Detectar localização automaticamente">
                        📍
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="editCityBtn" 
                            onclick="editCity()" title="Editar cidade manualmente">
                        ✏️
                    </button>
                </div>
                <small class="text-muted">A localização será detectada automaticamente. Clique em ✏️ para editar manualmente.</small>
            </div>

            <!-- Nome Solicitante -->
            <div class="form-group">
                <label for="requestorNameInput">👤 Nome do Solicitante</label>
                <input type="text" class="form-control" id="requestorNameInput" 
                       placeholder="Digite o nome de quem está solicitando" required>
                <small class="text-muted">Preenchido automaticamente com o nome do líder. Pode ser editado conforme necessário.</small>
            </div>

            <!-- Fazenda -->
            <div class="form-group">
                <label for="farmNameInput">🏠 Fazenda</label>
                <input type="text" class="form-control" id="farmNameInput" 
                       placeholder="Digite o nome da fazenda" required>
            </div>

            <!-- Tipos de Refeição -->
            <div class="form-group">
                <h4 style="margin-bottom: 20px;">Tipos de Refeições Disponíveis</h4>
                
                <!-- Café da Manhã -->
                <div class="meal-item">
                    <button type="button" class="meal-button" data-meal="cafe" onclick="toggleMealSelection('cafe')">
                        <span class="meal-icon">☕</span>
                        <span class="meal-text">Café da<br>Manhã</span>
                    </button>
                    <div class="supplier-dropdown" id="supplier-cafe" style="display: none;">
                        <div class="supplier-row">
                            <div class="supplier-section">
                                <select class="form-control supplier-select" data-meal="cafe" onchange="handleSupplierChange('cafe')">
                                    <option value="">Escolha o fornecedor</option>
                                    <option value="padaria_central">Padaria Central</option>
                                    <option value="cafe_da_esquina">Café da Esquina</option>
                                    <option value="panificadora_bom_dia">Panificadora Bom Dia</option>
                                    <option value="__custom__">✏️ Outro fornecedor</option>
                                </select>
                                <input type="text" class="form-control supplier-input" id="supplier-input-cafe" 
                                       placeholder="📝 Digite o nome do fornecedor" style="display: none;">
                            </div>
                            <div class="price-section">
                                <input type="number" class="form-control price-input" id="price-cafe" 
                                       placeholder="💰 Valor R$" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Almoço Marmitex -->
                <div class="meal-item">
                    <button type="button" class="meal-button" data-meal="almoco_marmitex" onclick="toggleMealSelection('almoco_marmitex')">
                        <span class="meal-icon">🍱</span>
                        <span class="meal-text">Almoço<br>Marmitex</span>
                    </button>
                    <div class="supplier-dropdown" id="supplier-almoco_marmitex" style="display: none;">
                        <div class="supplier-row">
                            <div class="supplier-section">
                                <select class="form-control supplier-select" data-meal="almoco_marmitex" onchange="handleSupplierChange('almoco_marmitex')">
                                    <option value="">Escolha o fornecedor</option>
                                    <option value="restaurante_do_joao">Restaurante do João</option>
                                    <option value="cantina_dona_maria">Cantina Dona Maria</option>
                                    <option value="marmitex_express">Marmitex Express</option>
                                    <option value="__custom__">✏️ Outro fornecedor</option>
                                </select>
                                <input type="text" class="form-control supplier-input" id="supplier-input-almoco_marmitex" 
                                       placeholder="📝 Digite o nome do fornecedor" style="display: none;">
                            </div>
                            <div class="price-section">
                                <input type="number" class="form-control price-input" id="price-almoco_marmitex" 
                                       placeholder="💰 Valor R$" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Almoço Local -->
                <div class="meal-item">
                    <button type="button" class="meal-button" data-meal="almoco_local" onclick="toggleMealSelection('almoco_local')">
                        <span class="meal-icon">🍽️</span>
                        <span class="meal-text">Almoço<br>Local</span>
                    </button>
                    <div class="supplier-dropdown" id="supplier-almoco_local" style="display: none;">
                        <div class="supplier-row">
                            <div class="supplier-section">
                                <select class="form-control supplier-select" data-meal="almoco_local" onchange="handleSupplierChange('almoco_local')">
                                    <option value="">Escolha o fornecedor</option>
                                    <option value="restaurante_bom_sabor">Restaurante Bom Sabor</option>
                                    <option value="buffet_executivo">Buffet Executivo</option>
                                    <option value="self_service_premium">Self Service Premium</option>
                                    <option value="__custom__">✏️ Outro fornecedor</option>
                                </select>
                                <input type="text" class="form-control supplier-input" id="supplier-input-almoco_local" 
                                       placeholder="📝 Digite o nome do fornecedor" style="display: none;">
                            </div>
                            <div class="price-section">
                                <input type="number" class="form-control price-input" id="price-almoco_local" 
                                       placeholder="💰 Valor R$" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Janta Marmitex -->
                <div class="meal-item">
                    <button type="button" class="meal-button" data-meal="janta_marmitex" onclick="toggleMealSelection('janta_marmitex')">
                        <span class="meal-icon">🥡</span>
                        <span class="meal-text">Janta<br>Marmitex</span>
                    </button>
                    <div class="supplier-dropdown" id="supplier-janta_marmitex" style="display: none;">
                        <div class="supplier-row">
                            <div class="supplier-section">
                                <select class="form-control supplier-select" data-meal="janta_marmitex" onchange="handleSupplierChange('janta_marmitex')">
                                    <option value="">Escolha o fornecedor</option>
                                    <option value="cozinha_da_vila">Cozinha da Vila</option>
                                    <option value="janta_express">Janta Express</option>
                                    <option value="marmitas_caseiras">Marmitas Caseiras</option>
                                    <option value="__custom__">✏️ Outro fornecedor</option>
                                </select>
                                <input type="text" class="form-control supplier-input" id="supplier-input-janta_marmitex" 
                                       placeholder="📝 Digite o nome do fornecedor" style="display: none;">
                            </div>
                            <div class="price-section">
                                <input type="number" class="form-control price-input" id="price-janta_marmitex" 
                                       placeholder="💰 Valor R$" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Janta Local -->
                <div class="meal-item">
                    <button type="button" class="meal-button" data-meal="janta_local" onclick="toggleMealSelection('janta_local')">
                        <span class="meal-icon">🌙</span>
                        <span class="meal-text">Janta<br>Local</span>
                    </button>
                    <div class="supplier-dropdown" id="supplier-janta_local" style="display: none;">
                        <div class="supplier-row">
                            <div class="supplier-section">
                                <select class="form-control supplier-select" data-meal="janta_local" onchange="handleSupplierChange('janta_local')">
                                    <option value="">Escolha o fornecedor</option>
                                    <option value="restaurante_noturno">Restaurante Noturno</option>
                                    <option value="bistrô_da_praça">Bistrô da Praça</option>
                                    <option value="jantar_gourmet">Jantar Gourmet</option>
                                    <option value="__custom__">✏️ Outro fornecedor</option>
                                </select>
                                <input type="text" class="form-control supplier-input" id="supplier-input-janta_local" 
                                       placeholder="📝 Digite o nome do fornecedor" style="display: none;">
                            </div>
                            <div class="price-section">
                                <input type="number" class="form-control price-input" id="price-janta_local" 
                                       placeholder="💰 Valor R$" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colaboradores -->
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label id="colaboradores-label">Selecione os Colaboradores (0 disponíveis)</label>
                    <button type="button" id="btn-selecionar-todos" onclick="toggleSelecionarTodos()" 
                            style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; 
                                   border-radius: 6px; padding: 8px 16px; font-size: 12px; font-weight: 600; 
                                   cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                        Selecionar Todos
                    </button>
                </div>
                <div class="employees-list" id="employees-list">
                    <!-- Colaboradores serão carregados dinamicamente aqui -->
                </div>
                
                <!-- Botão A Contratar -->
                <div style="margin-top: 15px; text-align: center;">
                    <button type="button" class="btn btn-primary" onclick="abrirPopupAContratar()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; padding: 12px 24px; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">
                        👷‍♀️ A CONTRATAR
                    </button>
                    <div id="naoContratadosInfo" style="margin-top: 8px; font-size: 14px; color: #666; display: none;">
                        <span id="naoContratadosTexto">0 não contratados adicionados</span>
                    </div>
                </div>
            </div>

            <!-- Outros Participantes -->
            <div class="form-group">
                <label>👥 Outros Participantes</label>
                <div id="otherParticipants">
                    <!-- Campos dinâmicos serão adicionados aqui -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="addOtherParticipant()">
                    ➕ Adicionar Outro Participante
                </button>
                <small class="text-muted">Adicione pessoas que não estão na empresa mas vão participar da refeição.</small>
            </div>

            <!-- Hospedado -->
            <div class="form-group">
                <label>🏨 Hospedado?</label>
                <div style="display: flex; gap: 15px; margin-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="isHosted" value="nao" checked onchange="toggleHostedFields()">
                        <span>❌ Não</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="isHosted" value="sim" onchange="toggleHostedFields()">
                        <span>✅ Sim</span>
                    </label>
                </div>
            </div>

            <!-- Campos de Hotel (aparecem apenas se hospedado = Sim) -->
            <div id="hotelFields" style="display: none;">
                <div class="form-group">
                    <label for="hotelNameInput">🏨 Nome do Hotel</label>
                    <input type="text" class="form-control" id="hotelNameInput" 
                           placeholder="Digite o nome do hotel">
                </div>
                <div class="form-group">
                    <label for="dailyRateInput">💰 Valor da Diária</label>
                    <input type="number" class="form-control" id="dailyRateInput" 
                           placeholder="R$ 0,00" step="0.01" min="0">
                </div>
            </div>

            <!-- Responsável pelo Cartão -->
            <div class="form-group">
                <label for="cardResponsibleInput">💳 Responsável pelo Cartão</label>
                <input type="text" class="form-control" id="cardResponsibleInput" 
                       placeholder="Digite o nome do responsável pelo cartão"
                       onchange="buscarPagcorpPorResponsavel(this.value)"
                       onblur="buscarPagcorpPorResponsavel(this.value)">
                <small class="text-muted">Preenchido automaticamente com o nome do líder. Pode ser editado ou deixado em branco.</small>
            </div>

            <!-- PAGCORP -->
            <div class="form-group">
                <label for="pagcorpInput">🏢 PAGCORP</label>
                <input type="text" class="form-control" id="pagcorpInput" 
                       placeholder="Digite o código/identificação PAGCORP">
                <small class="text-muted">Buscado automaticamente pelo nome do responsável. Pode ser editado ou deixado em branco.</small>
            </div>

            <!-- Resumo do Pedido -->
            <div class="summary" id="orderSummary" style="display: none;">
                <h3>📋 Resumo do Pedido</h3>
                <div id="summaryContent"></div>
            </div>

            <button class="btn btn-success" onclick="doSubmitOrder()">Finalizar Pedido</button>
        </div>

        <!-- Popup de Sucesso -->
        <div id="successPopup" class="popup-overlay hidden">
            <div class="popup-content">
                <div class="popup-header">
                    <h3>✅ Pedido Enviado com Sucesso!</h3>
                </div>
                <div class="popup-body">
                    <p id="successMessage">Seu pedido foi enviado para a base de dados.</p>
                    <p id="tempMessage" style="display: none;">⚠️ Você tem pendências de temperatura para aferir.</p>
                </div>
                <div class="popup-actions">
                    <button class="btn btn-whatsapp" onclick="sendToWhatsAppAndClose()">
                        📱 Enviar via WhatsApp
                    </button>
                    <button class="btn btn-secondary" onclick="closeSuccessPopup()">
                        Fechar
                    </button>
                </div>
            </div>
        </div>

        <!-- Popup de Problema com Refeição -->
        <div id="problemPopup" class="popup-overlay hidden">
            <div class="popup-content">
                <div class="popup-header" style="background: #dc2626;">
                    <h3>🚨 PROBLEMA COM REFEIÇÃO</h3>
                </div>
                <div class="popup-body" style="text-align: left; padding: 25px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #374151;">📅 Data do Problema:</label>
                        <input type="date" id="dataProblemaPopup" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #374151;">🏪 Fornecedor:</label>
                        <select id="fornecedorProblemaPopup" onchange="handleFornecedorProblemaChange()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: white;">
                            <option value="">Escolha o fornecedor</option>
                            <option value="__custom__">✏️ Outro fornecedor</option>
                        </select>
                        <input type="text" id="fornecedorProblemaPopupCustom" placeholder="📝 Digite o nome do fornecedor" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px; display: none;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #374151;">📝 Descrição do Problema:</label>
                        <textarea id="observacaoProblemaPopup" rows="3" placeholder="Descreva o problema..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; font-family: inherit;"></textarea>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #374151;">📸 Fotos:</label>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" onclick="document.getElementById('foto1Popup').click()" style="flex: 1; padding: 20px; border: 2px dashed #ccc; border-radius: 5px; background: #f9f9f9; cursor: pointer; text-align: center;">
                                <div>📷 Foto 1</div>
                                <div id="foto1Status" style="font-size: 12px; color: #666; margin-top: 5px;">Clique para selecionar</div>
                            </button>
                            <button type="button" onclick="document.getElementById('foto2Popup').click()" style="flex: 1; padding: 20px; border: 2px dashed #ccc; border-radius: 5px; background: #f9f9f9; cursor: pointer; text-align: center;">
                                <div>📷 Foto 2</div>
                                <div id="foto2Status" style="font-size: 12px; color: #666; margin-top: 5px;">Clique para selecionar</div>
                            </button>
                        </div>
                        <input type="file" id="foto1Popup" accept="image/*" style="display: none;" onchange="atualizarStatusFoto(1)">
                        <input type="file" id="foto2Popup" accept="image/*" style="display: none;" onchange="atualizarStatusFoto(2)">
                    </div>
                </div>
                <div class="popup-actions">
                    <button class="btn btn-danger" onclick="enviarProblemaPopup()" style="flex: 1;">
                        📧 ENVIAR RELATÓRIO
                    </button>
                    <button class="btn btn-secondary" onclick="fecharProblemaPopup()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Popup A Contratar -->
        <div id="aContratarPopup" class="popup-overlay hidden">
            <div class="popup-content" style="max-width: 400px; text-align: center;">
                <h3 style="margin-bottom: 20px; color: #333; font-size: 20px;">👷‍♀️ PESSOAS A CONTRATAR</h3>
                
                <div class="form-group">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #555;">
                        QUANTOS NÃO CONTRATADOS?
                    </label>
                    <input type="number" id="quantidadeNaoContratados" min="0" max="50" 
                           style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; text-align: center; font-weight: bold;"
                           placeholder="0" onkeypress="if(event.key==='Enter') confirmarNaoContratados()">
                </div>
                
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    <i>💡 Essas pessoas serão incluídas no total de refeições</i>
                </div>
                
                <div class="popup-actions" style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="confirmarNaoContratados()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        ✅ CONFIRMAR
                    </button>
                    <button class="btn btn-secondary" onclick="fecharPopupAContratar()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Tela de Aferição de Temperatura -->
        <div id="temperatureScreen" class="main-screen hidden">
            <button class="back-btn" onclick="doShowMain()">← Voltar</button>
            
            <h2>🌡️ Aferição de Temperatura</h2>
            
            <div class="temp-info">
                <h3 id="tempMealInfo">Almoço Marmitex - 10/08/2025</h3>
            </div>

            <!-- Container das Fases em coluna -->
            <div class="temp-phases-container">
            <!-- Fase 1: Retirada -->
            <div class="temp-phase-card">
                <h4>📦 Retirada</h4>
                
                <div class="form-group">
                    <label>🌡️ Temperatura (°C)</label>
                    <input type="number" class="form-control" id="temperatureRetirada" placeholder="65" step="0.1">
                </div>

                <div class="form-group">
                    <label>� Hora da Retirada</label>
                    <input type="time" class="form-control" id="horaRetirada" style="font-size: 16px; padding: 12px; border-radius: 8px; border: 2px solid #ddd; background: #f8f9fa;">
                    <small class="text-muted">Informe o horário exato em que a refeição foi retirada</small>
                </div>

                <div class="form-group">
                    <label>�📷 Foto da Retirada</label>
                    <!-- Input para câmera -->
                    <input type="file" class="form-control hidden" id="fileRetiradaCamera" accept="image/*" capture="environment">
                    <!-- Input para galeria -->
                    <input type="file" class="form-control hidden" id="fileRetirada" accept="image/*">
                    <div class="photo-options">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileRetiradaCamera').click()">📷 Tirar Foto</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('fileRetirada').click()">📎 Anexar</button>
                        <button type="button" class="btn btn-info btn-sm" onclick="debugFileInput('fileRetirada')" style="margin-left: 10px;">🔍 Debug</button>
                    </div>
                    <div id="previewRetirada" class="file-preview">
                        <span>📷 Nenhuma foto capturada</span>
                        <canvas id="canvasRetirada" style="display:none; max-width: 100%; height: auto;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Fase 2: Consumo -->
            <div class="temp-phase-card">
                <h4>🍽️ Consumo</h4>
                
                <div class="form-group">
                    <label>🌡️ Temperatura (°C)</label>
                    <input type="number" class="form-control" id="temperatureConsumo" placeholder="Ex: 58" step="0.1">
                </div>

                <div class="form-group">
                    <label>🕐 Hora do Consumo</label>
                    <input type="time" class="form-control" id="horaConsumo" style="font-size: 16px; padding: 12px; border-radius: 8px; border: 2px solid #ddd; background: #f8f9fa;">
                    <small class="text-muted">Informe o horário exato em que a refeição foi consumida</small>
                </div>

                <div class="form-group">
                    <label>📷 Foto do Consumo</label>
                    <!-- Input para câmera -->
                    <input type="file" class="form-control hidden" id="fileConsumoCamera" accept="image/*" capture="environment">
                    <!-- Input para galeria -->
                    <input type="file" class="form-control hidden" id="fileConsumo" accept="image/*">
                    <div class="photo-options">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileConsumoCamera').click()">📷 Tirar Foto</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('fileConsumo').click()">📎 Anexar</button>
                        <button type="button" class="btn btn-info btn-sm" onclick="debugFileInput('fileConsumo')" style="margin-left: 10px;">🔍 Debug</button>
                    </div>
                    <div id="previewConsumo" class="file-preview">
                        <span>📷 Nenhuma foto capturada</span>
                        <canvas id="canvasConsumo" style="display:none; max-width: 100%; height: auto;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Observações Gerais -->
            <div class="form-group observations-section">
                <label>📝 Observações Gerais (Opcional)</label>
                <textarea class="form-control temp-textarea" id="observacoesGerais" placeholder="Observações sobre a aferição de temperatura..."></textarea>
            </div>

            <button class="btn btn-success" onclick="doSaveTemperatureComplete()">✅ Finalizar Aferição Completa</button>
        </div>

        <!-- Tela de Problema com Refeição -->
        <div id="problemScreen" class="main-screen hidden">
            <button class="back-btn" onclick="voltarTelaInicial()">← Voltar</button>
            
            <h2 style="color: #dc2626; margin-bottom: 20px;">🚨 PROBLEMA COM REFEIÇÃO</h2>
            
            <div class="form-group">
                <label>📅 Data do Problema</label>
                <input type="date" class="form-control" id="dataProblema">
            </div>

            <div class="form-group">
                <label>🏪 Fornecedor</label>
                <input type="text" class="form-control" id="fornecedorProblema" placeholder="Nome do fornecedor">
            </div>

            <div class="form-group">
                <label>📝 Descrição do Problema</label>
                <textarea class="form-control" id="observacaoProblema" rows="4" placeholder="Descreva detalhadamente o problema encontrado..."></textarea>
            </div>

            <div class="form-group">
                <label>📸 Fotos do Problema</label>
                <div class="foto-container">
                    <div class="foto-area" onclick="document.getElementById('foto1').click()">
                        <input type="file" id="foto1" accept="image/*" style="display: none;" onchange="mostrarFoto(1)">
                        <div id="area1">
                            <div style="font-size: 30px; margin-bottom: 10px;">📷</div>
                            <div style="color: #666;">Foto 1</div>
                        </div>
                    </div>
                    <div class="foto-area" onclick="document.getElementById('foto2').click()">
                        <input type="file" id="foto2" accept="image/*" style="display: none;" onchange="mostrarFoto(2)">
                        <div id="area2">
                            <div style="font-size: 30px; margin-bottom: 10px;">📷</div>
                            <div style="color: #666;">Foto 2</div>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="enviarProblema()" class="btn btn-danger" style="width: 100%; font-size: 16px; margin-top: 20px;">
                📧 ENVIAR RELATÓRIO
            </button>
        </div>

    </div>

    <script>
        // 🎯 COMPATIBILIDADE COM CÓDIGO LEGADO (getters/setters para AppState)
        Object.defineProperty(window, 'selectedMeals', {
            get() { return AppState.order.selectedMeals; },
            set(value) { AppState.order.selectedMeals = value; }
        });

        Object.defineProperty(window, 'selectedEmployees', {
            get() { return AppState.order.selectedEmployees; },
            set(value) { AppState.order.selectedEmployees = value; }
        });

        Object.defineProperty(window, 'pendingTemperatures', {
            get() { return AppState.temperature.pending; },
            set(value) { AppState.temperature.pending = value; }
        });

        Object.defineProperty(window, 'isOnline', {
            get() { return AppState.network.isOnline; },
            set(value) { AppState.network.isOnline = value; }
        });

        Object.defineProperty(window, 'currentTempData', {
            get() { return AppState.temperature.current; },
            set(value) { AppState.temperature.current = value; }
        });

        Object.defineProperty(window, 'globalImageRetirada', {
            get() { return AppState.temperature.images.retirada; },
            set(value) { AppState.temperature.images.retirada = value; }
        });

        Object.defineProperty(window, 'globalImageConsumo', {
            get() { return AppState.temperature.images.consumo; },
            set(value) { AppState.temperature.images.consumo = value; }
        });

        Object.defineProperty(window, 'imageTimestamps', {
            get() { return AppState.temperature.images.timestamps; }
        });

        Object.defineProperty(window, 'imagemFoto1Capturada', {
            get() { return AppState.problem.foto1; },
            set(value) { AppState.problem.foto1 = value; }
        });

        Object.defineProperty(window, 'imagemFoto2Capturada', {
            get() { return AppState.problem.foto2; },
            set(value) { AppState.problem.foto2 = value; }
        });

        // Variáveis que continuam como antes (por enquanto)
        var otherParticipants = [];
        window.otherParticipants = [];
        var naoContratadosCount = 0;
        window.naoContratadosCount = 0;
        var isOnlineGlobal = navigator.onLine;
        
        // Função para detectar URL base do servidor
        function getServerBaseUrl() {
            const currentHost = window.location.hostname;
            const currentProtocol = window.location.protocol;
            
            // Se estamos no Railway (detecta por domínio .railway.app)
            if (currentHost.includes('railway.app') || currentHost.includes('.up.railway.app')) {
                return `${currentProtocol}//${currentHost}`;
            }
            
            // Se estamos acessando via ngrok
            if (currentHost.includes('ngrok') || currentHost.includes('.app')) {
                return `${currentProtocol}//${currentHost}`;
            }
            
            // Se estamos acessando via IP da rede local
            if (currentHost !== 'localhost' && currentHost !== '127.0.0.1' && currentHost !== '') {
                return `http://${currentHost}:8082`;
            }
            
            // Caso contrário, usar localhost
            return 'http://localhost:8082';
        }
        
        var mealPrices = {
            'cafe': 5.00,
            'almoco_marmitex': 18.00,
            'almoco_local': 25.00,
            'janta_marmitex': 15.00,
            'janta_local': 22.00
        };

        var employeeNames = {
            'eduardo': 'Eduardo', 'ana': 'Ana Silva', 'carlos': 'Carlos Souza', 
            'maria': 'Maria Costa', 'joao': 'João Santos', 'lucia': 'Lúcia Ferreira',
            'pedro': 'Pedro Lima', 'julia': 'Júlia Alves', 'rafael': 'Rafael Mendes',
            'camila': 'Camila Rocha', 'bruno': 'Bruno Oliveira'
        };

        var mealNames = {
            'cafe': 'CAFÉ', 'almoco_marmitex': 'ALMOÇO MARMITEX', 'almoco_local': 'ALMOÇO LOCAL',
            'janta_marmitex': 'JANTA MARMITEX', 'janta_local': 'JANTA LOCAL'
        };

        // ========== FUNÇÃO DE LOGIN POR EQUIPE ==========
        
        async function loginEquipe() {
            var equipe = document.getElementById('equipeInput').value.trim().toUpperCase();
            if (!equipe) {
                alert('Digite sua equipe!');
                return;
            }
            
            // Mostrar loading
            var botaoLogin = document.querySelector('#loginScreen button');
            var textoOriginal = botaoLogin.textContent;
            botaoLogin.textContent = 'Carregando...';
            botaoLogin.disabled = true;
            
            try {
                // Extrai projeto (números)
                var projeto = equipe.replace(/[^0-9]/g, '');
                
                // 🧹 LIMPAR DADOS ANTERIORES COMPLETAMENTE
                console.log('🧹 Limpando todos os dados anteriores...');
                limparDadosAnteriores();
                
                // Busca dados das APIs do Azure SQL
                var sucesso = await buscarDadosPorProjetoEquipe(projeto, equipe);
                
                // ✅ SEMPRE PERMITIR LOGIN - INDEPENDENTE DO RESULTADO
                console.log('✅ Forçando login para qualquer equipe');
                
                // Salvar login para persistir após refresh
                salvarLogin(projeto, equipe);
                
                // Login bem-sucedido
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                loadPendingTemperatures();
                updateSyncStatus();
                
            } catch (error) {
                console.error('Erro no login:', error);
                
                // ✅ MESMO COM ERRO - PERMITIR LOGIN
                console.log('⚠️ Erro na API, mas permitindo login...');
                var projeto = equipe.replace(/[^0-9]/g, '');
                salvarLogin(projeto, equipe);
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                loadPendingTemperatures();
                updateSyncStatus();
            } finally {
                // Restaurar botão
                botaoLogin.textContent = textoOriginal;
                botaoLogin.disabled = false;
            }
        }

        // Funções principais
        function doLogin() {
            var password = document.getElementById('leaderPassword').value;
            if (password && password.length > 0) {
                console.log('Login realizado com sucesso');
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                loadPendingTemperatures();
                updateSyncStatus();
                
                // Limpar campo de senha após login
                document.getElementById('leaderPassword').value = '';
            } else {
                alert('Digite sua senha!');
            }
        }

        function doShowMain() {
            // Ocultar todas as outras telas
            document.getElementById('orderScreen').classList.add('hidden');
            document.getElementById('temperatureScreen').classList.add('hidden');
            document.getElementById('problemScreen').classList.add('hidden');
            
            // Mostrar tela principal
            document.getElementById('mainScreen').classList.remove('hidden');
            
            loadPendingTemperatures();
            resetOrder();
        }

        function toggleMealSelection(mealType) {
            const button = document.querySelector(`button[data-meal="${mealType}"]`);
            const supplierDiv = document.getElementById(`supplier-${mealType}`);
            const isCurrentlySelected = button.classList.contains('selected');
            
            if (isCurrentlySelected) {
                // Desselecionar
                button.classList.remove('selected');
                supplierDiv.style.display = 'none';
                supplierDiv.querySelector('select').value = '';
                
                // Remover da lista de refeições selecionadas
                const index = selectedMeals.indexOf(mealType);
                if (index > -1) {
                    selectedMeals.splice(index, 1);
                }
            } else {
                // Selecionar
                button.classList.add('selected');
                supplierDiv.style.display = 'block';
                
                // Carregar fornecedores filtrados para este tipo de refeição
                carregarFornecedoresPorTipo(mealType);
                
                // Adicionar à lista de refeições selecionadas
                if (selectedMeals.indexOf(mealType) === -1) {
                    selectedMeals.push(mealType);
                }
                
                // Foca no select para facilitar a seleção
                setTimeout(() => {
                    supplierDiv.querySelector('select').focus();
                }, 300);
            }
            
            updateSummary();
        }

        function handleSupplierChange(mealType) {
            const select = document.querySelector(`select[data-meal="${mealType}"]`);
            const input = document.getElementById(`supplier-input-${mealType}`);
            const priceSection = document.querySelector(`#supplier-${mealType} .price-section`);
            const priceInput = document.getElementById(`price-${mealType}`);
            
            if (select.value === '__custom__') {
                // Mostrar campo de input personalizado e o campo de preço
                input.style.display = 'block';
                input.focus();
                priceSection.classList.add('show');
                // Limpar o input se havia algo
                input.value = '';
                // Limpar o preço para digitação manual
                if (priceInput) priceInput.value = '';
            } else if (select.value === '') {
                // Opção vazia selecionada
                input.style.display = 'none';
                input.value = '';
                priceSection.classList.remove('show');
                if (priceInput) priceInput.value = '';
            } else {
                // Fornecedor específico selecionado
                input.style.display = 'none';
                input.value = '';
                priceSection.classList.remove('show');
                
                // Preencher automaticamente o preço do fornecedor selecionado
                const selectedOption = select.options[select.selectedIndex];
                if (selectedOption && selectedOption.dataset.preco) {
                    if (priceInput) priceInput.value = parseFloat(selectedOption.dataset.preco).toFixed(2);
                }
            }
            
            updateSummary();
        }

        // 🎯 USAR SUPPLIERMANAGER (mantendo compatibilidade)
        function getSelectedSupplier(mealType) {
            return SupplierManager.getName(mealType);
        }

        // 🎯 USAR SUPPLIERMANAGER (mantendo compatibilidade)
        function getCustomPrice(mealType) {
            return SupplierManager.getPrice(mealType);
        }

        async function doSubmitOrder() {
            if (selectedMeals.length === 0) {
                alert('Selecione pelo menos um tipo de refeição!');
                return;
            }

            // Verificar se é pedido avulso (sem equipe/colaboradores selecionados)
            const equipeLogada = localStorage.getItem('equipe_logada') || '';
            const isPedidoAvulso = selectedEmployees.length === 0 && otherParticipants.length === 0 && naoContratadosCount === 0;
            
            if (isPedidoAvulso) {
                console.log('🎯 Pedido AVULSO detectado - incluindo solicitante automaticamente');
                
                // Buscar dados do usuário logado
                const loginData = localStorage.getItem('loginData');
                if (loginData) {
                    try {
                        const dados = JSON.parse(loginData);
                        const nomeSolicitante = dados.nome || dados.user || 'Usuário';
                        
                        // Adicionar o solicitante como participante automaticamente
                        if (!otherParticipants.find(p => p.nome === nomeSolicitante)) {
                            otherParticipants.push({
                                nome: nomeSolicitante,
                                tipo: 'SOLICITANTE_AVULSO'
                            });
                            window.otherParticipants = otherParticipants; // Sincronizar global
                            console.log(`✅ Solicitante "${nomeSolicitante}" adicionado automaticamente ao pedido avulso`);
                        }
                    } catch (e) {
                        console.error('❌ Erro ao buscar dados do usuário logado:', e);
                    }
                }
                
                // Re-verificar se agora temos participantes
                if (selectedEmployees.length === 0 && otherParticipants.length === 0 && naoContratadosCount === 0) {
                    alert('Não foi possível identificar o solicitante para o pedido avulso. Tente fazer login novamente.');
                    return;
                }
            }

            // Validar campos obrigatórios
            var withdrawalDate = document.getElementById('withdrawalDateInput').value;
            if (!withdrawalDate) {
                alert('Por favor, informe a data da retirada!');
                document.getElementById('withdrawalDateInput').focus();
                return;
            }

            // Validar cidade
            var cityInput = document.getElementById('serviceCityInput');
            if (!cityInput.value.trim()) {
                alert('Por favor, informe a cidade de prestação do serviço!');
                cityInput.focus();
                return;
            }

            // Validar nome do solicitante
            var requestorName = document.getElementById('requestorNameInput').value.trim();
            if (!requestorName) {
                alert('Por favor, informe o nome do solicitante!');
                document.getElementById('requestorNameInput').focus();
                return;
            }

            // Validar fazenda
            var farmName = document.getElementById('farmNameInput').value.trim();
            if (!farmName) {
                alert('Por favor, informe o nome da fazenda!');
                document.getElementById('farmNameInput').focus();
                return;
            }

            // Validar campos de hotel se hospedado = sim
            var isHosted = document.querySelector('input[name="isHosted"]:checked').value;
            if (isHosted === 'sim') {
                var hotelName = document.getElementById('hotelNameInput').value.trim();
                var dailyRate = document.getElementById('dailyRateInput').value;
                
                if (!hotelName) {
                    alert('Por favor, informe o nome do hotel!');
                    document.getElementById('hotelNameInput').focus();
                    return;
                }
                
                if (!dailyRate || parseFloat(dailyRate) <= 0) {
                    alert('Por favor, informe o valor da diária!');
                    document.getElementById('dailyRateInput').focus();
                    return;
                }
            }

            // Responsável pelo cartão é opcional - pode ficar em branco
            var cardResponsible = document.getElementById('cardResponsibleInput').value.trim();

            // PAGCORP é opcional - pode ficar em branco  
            var pagcorp = document.getElementById('pagcorpInput').value.trim();

            // Validar se cada refeição selecionada tem um fornecedor
            var missingSuppliers = [];
            for (var i = 0; i < selectedMeals.length; i++) {
                var meal = selectedMeals[i];
                var supplierValue = getSelectedSupplier(meal);
                if (!supplierValue) {
                    var mealName = mealNames[meal] || meal;
                    missingSuppliers.push(mealName);
                }
            }

            if (missingSuppliers.length > 0) {
                alert('Selecione o fornecedor para: ' + missingSuppliers.join(', '));
                return;
            }

            console.log('=== DADOS PARA ENVIO AO BANCO ===');
            
            // Coletar todos os dados do formulário
            var withdrawalDate = document.getElementById('withdrawalDateInput').value;
            var serviceCity = document.getElementById('serviceCityInput').value.trim();
            var requestorName = document.getElementById('requestorNameInput').value.trim();
            var farmName = document.getElementById('farmNameInput').value.trim();
            var cardResponsible = document.getElementById('cardResponsibleInput').value.trim();
            var pagcorp = document.getElementById('pagcorpInput').value.trim();
            
            var isHosted = document.querySelector('input[name="isHosted"]:checked').value;
            var hotelName = isHosted === 'sim' ? document.getElementById('hotelNameInput').value.trim() : '';
            var dailyRate = isHosted === 'sim' ? document.getElementById('dailyRateInput').value : '';
            
            var selectedEmployeeNames = selectedEmployees.map(function(emp) {
                return employeeNames[emp];
            });
            
            var otherParticipantNames = otherParticipants.map(function(p) {
                return p.nome || p.name; // Aceitar ambos os formatos
            });
            
            var allParticipants = selectedEmployeeNames.concat(otherParticipantNames);
            var participantsText = allParticipants.join(', ');
            var totalParticipants = allParticipants.length + (naoContratadosCount || 0);
            
            // Garantir que pedidos avulsos sempre tenham pelo menos 1 participante
            if (totalParticipants === 0 && selectedMeals.length > 0) {
                totalParticipants = 1;
                console.log('🎯 Pedido avulso detectado - ajustando totalParticipants para 1');
            }
            
            console.log('📋 DADOS GERAIS:');
            console.log('Data Retirada: ' + withdrawalDate);
            console.log('Cidade: ' + serviceCity);
            console.log('Solicitante: ' + requestorName);
            console.log('Fazenda: ' + farmName);
            console.log('Hospedado: ' + (isHosted === 'sim' ? 'SIM' : 'NÃO'));
            if (isHosted === 'sim') {
                console.log('Hotel: ' + hotelName + ' - Diária: R$ ' + parseFloat(dailyRate).toFixed(2));
            }
            console.log('Responsável Cartão: ' + cardResponsible);
            console.log('PAGCORP: ' + pagcorp);
            console.log('Total Participantes: ' + totalParticipants + ' (' + participantsText + ')');
            console.log('');
            console.log('🍽️ REFEIÇÕES:');

            if (!Array.isArray(pendingTemperatures)) {
                pendingTemperatures = [];
            }

            for (var i = 0; i < selectedMeals.length; i++) {
                var meal = selectedMeals[i];
                var price = getCustomPrice(meal);
                var total = price * totalParticipants;
                var supplier = getSelectedSupplier(meal) || 'sem_fornecedor';
                
                var needsTemp = 'NAO_NECESSITA';
                if (meal === 'almoco_marmitex' || meal === 'janta_marmitex') {
                    needsTemp = 'NAO';
                    
                    // REMOVIDO: Não criar pendências fictícias mais
                    // As pendências serão carregadas diretamente do banco de dados
                    console.log('📋 Pedido criado - pendência será carregada do banco automaticamente');
                }
                
                console.log(withdrawalDate + ' ' + mealNames[meal] + ' ' + totalParticipants + ' pessoas R$' + price.toFixed(2) + ' unitário - TOTAL: R$' + total.toFixed(2) + ' | PARTICIPANTES: (' + participantsText + ') | FORNECEDOR: ' + supplier + ' | CIDADE: ' + serviceCity + ' | SOLICITANTE: ' + requestorName + ' | FAZENDA: ' + farmName + ' | TEMP: ' + needsTemp);
            }

            // Não salvar pendências no localStorage - usar dados do banco
            console.log('💾 Pedidos processados - pendências carregadas do banco automaticamente');

            var hasMarmitex = false;
            for (var i = 0; i < selectedMeals.length; i++) {
                if (selectedMeals[i] === 'almoco_marmitex' || selectedMeals[i] === 'janta_marmitex') {
                    hasMarmitex = true;
                    break;
                }
            }
            
            // ===== SALVAR NO BANCO DE DADOS =====
            console.log('💾 Salvando pedidos no banco de dados...');
            
            // Mostrar loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
            
            try {
                await salvarPedidosNoBanco(withdrawalDate, requestorName, totalParticipants);
                
                // Esconder loading overlay
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                
                // Mostrar popup de sucesso com opção WhatsApp
                showSuccessPopup(hasMarmitex);
            } catch (error) {
                console.error("❌ Erro ao salvar pedidos:", error);
                
                // Esconder loading overlay
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                
                alert("Erro ao salvar pedidos. Tente novamente.");
            }
        }
        
        function cleanOldProcessedIds() {
            try {
                const processedIdsData = localStorage.getItem('processedTemperatureIds_withTime');
                if (!processedIdsData) return;
                
                const data = JSON.parse(processedIdsData);
                const now = Date.now();
                const twentyFourHours = 24 * 60 * 60 * 1000; // 24 horas em ms
                
                // Filtrar apenas IDs processados nas últimas 24 horas
                const validIds = data.filter(item => (now - item.timestamp) < twentyFourHours);
                
                // Atualizar localStorage
                localStorage.setItem('processedTemperatureIds_withTime', JSON.stringify(validIds));
                
                // Também atualizar a lista simples de IDs para compatibilidade
                const simpleIds = validIds.map(item => item.id);
                localStorage.setItem('processedTemperatureIds', JSON.stringify(simpleIds));
                
                console.log(`🧹 Limpeza de IDs processados: ${data.length} → ${validIds.length} (removidos ${data.length - validIds.length} antigos)`);
            } catch (error) {
                console.error('❌ Erro ao limpar IDs processados antigos:', error);
            }
        }

        async function loadPendingTemperatures() {
            console.log('📋 Carregando pendências reais do banco de dados...');
            
            // Limpar IDs processados antigos (mais de 24 horas)
            cleanOldProcessedIds();
            
            try {
                // 🎯 BUSCAR APENAS PENDÊNCIAS DA EQUIPE LOGADA
                const equipeLogada = localStorage.getItem('equipe_logada') || 'SEM_EQUIPE';
                console.log('👥 Filtrando pendências para equipe:', equipeLogada);
                
                // Buscar pedidos reais que precisam de aferição de temperatura
                const baseUrl = getServerBaseUrl();
                console.log('🌐 URL do servidor:', baseUrl);
                
                const response = await fetch(`${baseUrl}/api/pedidos-pendentes-temperatura?equipe=${encodeURIComponent(equipeLogada)}`);
                console.log('📡 Resposta da API:', response.status);
                
                const result = await response.json();
                console.log('📊 Dados retornados:', result);
                
                if (result.error) {
                    console.error('❌ Erro ao carregar pendências do banco:', result.message);
                    // Em caso de erro, tentar usar cache offline
                    loadPendingFromCache();
                } else {
                    console.log(`✅ ${result.total} pendências carregadas do banco de dados`);
                    console.log('📋 Pendências detalhadas:', result.pendencias);
                    
                    // Filtrar IDs já processados para evitar que voltem
                    const processedIds = JSON.parse(localStorage.getItem('processedTemperatureIds') || '[]');
                    const filteredPendencias = result.pendencias.filter(item => !processedIds.includes(item.id));
                    
                    if (processedIds.length > 0) {
                        console.log('🔒 IDs processados filtrados:', processedIds);
                        console.log(`📊 Pendências antes do filtro: ${result.pendencias.length}`);
                        console.log(`📊 Pendências após o filtro: ${filteredPendencias.length}`);
                    }
                    
                    pendingTemperatures = filteredPendencias;
                    
                    // Salvar cache offline para uso quando estiver desconectado
                    localStorage.setItem('pendingTemperatures_cache', JSON.stringify(pendingTemperatures));
                    localStorage.setItem('pendingTemperatures_cache_time', Date.now().toString());
                    console.log('💾 Cache offline atualizado');
                }
                
            } catch (error) {
                console.error('❌ Erro de conexão ao carregar pendências:', error);
                // Usar dados do cache offline
                loadPendingFromCache();
            }
            
            // Garantir que pendingTemperatures é um array
            if (!Array.isArray(pendingTemperatures)) {
                pendingTemperatures = [];
            }
            
            console.log('📊 Pendências finais para exibir:', pendingTemperatures);
            
            // Atualizar interface
            updatePendingTemperaturesList();
        }

        function loadPendingFromCache() {
            console.log('📱 Carregando dados do cache offline...');
            try {
                const cachedData = localStorage.getItem('pendingTemperatures_cache');
                const cacheTime = localStorage.getItem('pendingTemperatures_cache_time');
                
                if (cachedData) {
                    let cachedPendencies = JSON.parse(cachedData);
                    
                    // Filtrar IDs já processados também no cache
                    const processedIds = JSON.parse(localStorage.getItem('processedTemperatureIds') || '[]');
                    cachedPendencies = cachedPendencies.filter(item => !processedIds.includes(item.id));
                    
                    pendingTemperatures = cachedPendencies;
                    console.log(`✅ ${pendingTemperatures.length} pendências carregadas do cache offline (após filtrar processados)`);
                    
                    if (processedIds.length > 0) {
                        console.log('🔒 IDs processados filtrados do cache:', processedIds);
                    }
                    
                    if (cacheTime) {
                        const cacheAge = Date.now() - parseInt(cacheTime);
                        const cacheAgeMinutes = Math.floor(cacheAge / (1000 * 60));
                        console.log(`🕐 Cache criado há ${cacheAgeMinutes} minutos`);
                    }
                } else {
                    console.log('❌ Nenhum cache offline encontrado');
                    pendingTemperatures = [];
                }
            } catch (error) {
                console.error('❌ Erro ao carregar cache offline:', error);
                pendingTemperatures = [];
            }
        }
        
        function updatePendingTemperaturesList() {
            
            var pendingHeader = document.getElementById('pendingHeader');
            var pendingList = document.getElementById('pendingList');
            var pendingCount = document.getElementById('pendingCount');
            
            if (!pendingHeader || !pendingList || !pendingCount) return;
            
            if (pendingTemperatures.length > 0) {
                pendingHeader.style.display = 'flex';
                pendingCount.textContent = pendingTemperatures.length;
                
                pendingList.innerHTML = pendingTemperatures.map(function(item) {
                    // Verificar se há aferição pendente de sincronização para este item
                    var isPendingSync = isPendingSyncronization(item.id);
                    var syncIndicator = isPendingSync ? ' 🔄' : '';
                    var itemClass = isPendingSync ? 'pending-item pending-sync' : 'pending-item';
                    
                    return '<div class="' + itemClass + '" onclick="openTemperatureCheck(' + item.id + ')">' +
                           '<h4>🌡️ ' + item.mealName + ' - ' + item.phase + syncIndicator + '</h4>' +
                           '<p><strong>Data:</strong> ' + item.date + '</p>' +
                           (isPendingSync ? '<p style="color: #FF6B35; font-size: 0.8em;">⏳ Pendente de sincronização</p>' : '') +
                           '</div>';
                }).join('');
            } else {
                pendingHeader.style.display = 'none';
                pendingList.innerHTML = '';
            }
        }

        // Função para verificar se há aferição pendente de sincronização
        function isPendingSyncronization(pedidoId) {
            try {
                var tempQueue = JSON.parse(localStorage.getItem('temperaturaQueue') || '[]');
                return tempQueue.some(function(item) {
                    return item.pedido_id == pedidoId || item.pedido_id === parseInt(pedidoId);
                });
            } catch (error) {
                console.error('❌ Erro ao verificar fila de sincronização:', error);
                return false;
            }
        }

        function openTemperatureCheck(pendingId) {
            console.log('Abrindo aferição para ID:', pendingId, 'Tipo:', typeof pendingId);
            
            var pending = null;
            for (var i = 0; i < pendingTemperatures.length; i++) {
                // Comparação flexível que funciona com string e number
                if (pendingTemperatures[i].id == pendingId || pendingTemperatures[i].id === parseInt(pendingId)) {
                    pending = pendingTemperatures[i];
                    console.log('✅ Pendência encontrada:', pending);
                    break;
                }
            }
            
            if (!pending) {
                console.log('❌ Pendência não encontrada para ID:', pendingId);
                console.log('📋 IDs disponíveis:', pendingTemperatures.map(p => p.id));
                return;
            }
            
            currentTempData = pending;
            
            // 🔄 RESET COMPLETO - LIMPAR DADOS ANTERIORES
            console.log('🧹 Fazendo reset completo da aferição anterior...');
            resetTemperatureForm();
            
            // Ocultar outras telas
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('orderScreen').classList.add('hidden');
            document.getElementById('problemScreen').classList.add('hidden');
            
            // Mostrar tela de temperatura
            document.getElementById('temperatureScreen').classList.remove('hidden');
            
            // Garantir que os canvas existem no DOM
            ensureCanvasElements();
            
            // Reconfigurar listeners de arquivo (garantir que estão ativos)
            setupFilePreview();
            
            // ✅ FORÇAR REINICIALIZAÇÃO DOS EVENT LISTENERS DE ARQUIVO
            setTimeout(() => {
                console.log('🔄 Reinicializando event listeners de arquivo após delay...');
                setupFilePreview();
            }, 100);
            
            document.getElementById('tempMealInfo').textContent = pending.mealName + ' - ' + pending.date;
        }
        
        // 🧹 FUNÇÃO DE RESET COMPLETO
        function resetTemperatureForm() {
            console.log('🧹 Resetando formulário de temperatura...');
            
            // Limpar campos de input
            document.getElementById('temperatureRetirada').value = '';
            document.getElementById('temperatureConsumo').value = '';
            document.getElementById('horaRetirada').value = '';
            document.getElementById('horaConsumo').value = '';
            document.getElementById('observacoesGerais').value = '';
            
            // Limpar campos de arquivo
            const fileRetirada = document.getElementById('fileRetirada');
            const fileConsumo = document.getElementById('fileConsumo');
            if (fileRetirada) fileRetirada.value = '';
            if (fileConsumo) fileConsumo.value = '';
            
            // Limpar previews de imagem
            const previewRetirada = document.getElementById('previewRetirada');
            const previewConsumo = document.getElementById('previewConsumo');
            
            if (previewRetirada) {
                previewRetirada.innerHTML = '<p class="text-muted">📷 Nenhuma foto selecionada</p>';
            }
            
            if (previewConsumo) {
                previewConsumo.innerHTML = '<p class="text-muted">📷 Nenhuma foto selecionada</p>';
            }
            
            // Limpar variáveis globais de imagem
            globalImageRetirada = null;
            globalImageConsumo = null;
            imageTimestamps = {
                retirada: null,
                consumo: null
            };
            
            console.log('✅ Reset completo finalizado - formulário limpo');
        }
        
        // ========== GARANTIR CANVAS ELEMENTS ==========
        function ensureCanvasElements() {
            console.log('🔧 Verificando e garantindo canvas no DOM...');
            
            // Verificar canvas de retirada
            let canvasRetirada = document.getElementById('canvasRetirada');
            let previewRetirada = document.getElementById('previewRetirada');
            
            if (!canvasRetirada && previewRetirada) {
                console.log('⚠️ Canvas de retirada não encontrado - criando...');
                canvasRetirada = document.createElement('canvas');
                canvasRetirada.id = 'canvasRetirada';
                canvasRetirada.style.cssText = 'display:none; max-width: 100%; height: auto;';
                previewRetirada.appendChild(canvasRetirada);
                console.log('✅ Canvas de retirada criado');
            }
            
            // Verificar canvas de consumo
            let canvasConsumo = document.getElementById('canvasConsumo');
            let previewConsumo = document.getElementById('previewConsumo');
            
            if (!canvasConsumo && previewConsumo) {
                console.log('⚠️ Canvas de consumo não encontrado - criando...');
                canvasConsumo = document.createElement('canvas');
                canvasConsumo.id = 'canvasConsumo';
                canvasConsumo.style.cssText = 'display:none; max-width: 100%; height: auto;';
                previewConsumo.appendChild(canvasConsumo);
                console.log('✅ Canvas de consumo criado');
            }
            
            // Debug final
            const allCanvas = document.querySelectorAll('canvas');
            console.log('🔍 Canvas no DOM após verificação:', Array.from(allCanvas).map(c => c.id));
        }
        
        // ========== CAPTURA DE IMAGENS PARA TEMPERATURA ==========
        // (Funcionalidade implementada em setupFilePreview())
        
        function getImageBase64(tipo) {
            console.log(`🔍 Buscando imagem: ${tipo}`);
            
            // USAR VARIÁVEIS GLOBAIS EM VEZ DE CANVAS
            if (tipo === 'Retirada') {
                if (globalImageRetirada) {
                    console.log(`✅ Imagem de RETIRADA encontrada nas variáveis globais (${globalImageRetirada.length} chars)`);
                    console.log(`⏰ Capturada em: ${imageTimestamps.retirada}`);
                    return globalImageRetirada;
                } else {
                    console.log(`❌ Imagem de RETIRADA não encontrada nas variáveis globais`);
                    return null;
                }
            }
            
            if (tipo === 'Consumo') {
                if (globalImageConsumo) {
                    console.log(`✅ Imagem de CONSUMO encontrada nas variáveis globais (${globalImageConsumo.length} chars)`);
                    console.log(`⏰ Capturada em: ${imageTimestamps.consumo}`);
                    return globalImageConsumo;
                } else {
                    console.log(`❌ Imagem de CONSUMO não encontrada nas variáveis globais`);
                    return null;
                }
            }
            
            console.log(`❌ Tipo de imagem inválido: ${tipo}`);
            return null;
        }

        async function doSaveTemperatureComplete() {
            console.log('🚀 Iniciando salvamento de temperatura...');
            
            // Mostrar loading overlay igual ao envio de pedidos
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.querySelector('.loading-text');
            const loadingSubtitle = document.querySelector('.loading-subtitle');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                if (loadingText) loadingText.textContent = '🌡️ Enviando aferição...';
                if (loadingSubtitle) loadingSubtitle.textContent = 'Processando dados de temperatura';
            }
            
            try {
                // DEBUG: Verificar estado das variáveis globais
                console.log('🔍 Estado das variáveis globais:');
                console.log('   - globalImageRetirada:', !!globalImageRetirada, globalImageRetirada ? `(${globalImageRetirada.length} chars)` : '');
                console.log('   - globalImageConsumo:', !!globalImageConsumo, globalImageConsumo ? `(${globalImageConsumo.length} chars)` : '');
                console.log('   - Timestamps:', imageTimestamps);
                
                const tempRetirada = document.getElementById('temperatureRetirada').value;
                const tempConsumo = document.getElementById('temperatureConsumo').value;
                const horaRetirada = document.getElementById('horaRetirada').value;
                const horaConsumo = document.getElementById('horaConsumo').value;
                const observacoesGerais = document.getElementById('observacoesGerais').value;
                
                // Validações (com esconder loading se falhar)
                if (!tempRetirada) {
                    alert('Por favor, informe a temperatura de retirada!');
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    return;
                }
                
                if (!tempConsumo) {
                    alert('Por favor, informe a temperatura de consumo!');
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    return;
                }

                if (!horaRetirada) {
                    alert('Por favor, informe a hora da retirada!');
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    return;
                }
                
                if (!horaConsumo) {
                    alert('Por favor, informe a hora do consumo!');
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    return;
                }
                
                // Obter imagens em base64
                console.log('🔍 Tentando capturar imagens...');
                const imgRetirada = getImageBase64('Retirada');
                const imgConsumo = getImageBase64('Consumo');
                
                console.log('📷 Resultado da captura:');
                console.log('   Retirada:', imgRetirada ? 'CAPTURADA' : 'NÃO CAPTURADA');
                console.log('   Consumo:', imgConsumo ? 'CAPTURADA' : 'NÃO CAPTURADA');
                
                if (!imgRetirada) {
                    alert('❌ Por favor, tire uma foto da retirada!\n\nDica: Clique em "📷 Tirar Foto" e selecione uma imagem.');
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    return;
                }
                
                if (!imgConsumo) {
                    alert('❌ Por favor, tire uma foto do consumo!\n\nDica: Clique em "📷 Tirar Foto" e selecione uma imagem.');
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    return;
                }
            
            // Usar ID real do banco de dados (não precisa converter)
            const pedidoIdReal = currentTempData.id; // ID real da tabela PEDIDOS
            console.log('🆔 Usando ID real do banco:', pedidoIdReal);
            
            // Preparar dados para envio
            const aferição = {
                pedido_id: pedidoIdReal, // ID real da tabela PEDIDOS
                temperatura_retirada: parseFloat(tempRetirada),
                temperatura_consumo: parseFloat(tempConsumo),
                hora_retirada: horaRetirada, // NOVO: Hora da retirada
                hora_consumo: horaConsumo,   // NOVO: Hora do consumo
                img_retirada: imgRetirada,
                img_consumo: imgConsumo,
                observacoes: observacoesGerais,
                aferiu_temperatura: "SIM", // IMPORTANTE: Marcar como aferido
                AFERIU_TEMPERATURA: "SIM", // Backup caso a API espere maiúsculo
                status_temperatura: "SIM", // Backup caso o campo tenha outro nome
                temperatura_aferida: "SIM", // Mais uma variação
                aferimento_concluido: "SIM", // Mais uma variação
                status_aferimento: "SIM", // Mais uma variação
                concluido: "SIM", // Variação simples
                timestamp: new Date().toISOString()
            };
            
            console.log('📋 Aferição preparada:', {
                pedido_id: aferição.pedido_id,
                temp_retirada: aferição.temperatura_retirada,
                temp_consumo: aferição.temperatura_consumo,
                hora_retirada: aferição.hora_retirada,   // NOVO LOG
                hora_consumo: aferição.hora_consumo,     // NOVO LOG
                aferiu_temperatura: aferição.aferiu_temperatura, // LOG DO CAMPO CRÍTICO
                has_img_retirada: !!aferição.img_retirada,
                has_img_consumo: !!aferição.img_consumo
            });
            
            // Tentar enviar online primeiro
            if (isOnlineGlobal) {
                try {
                    console.log('🚀 ENVIANDO PARA API /api/afericao-temperatura:');
                    console.log('📤 Dados completos sendo enviados:', JSON.stringify(aferição, null, 2));
                    
                    const response = await fetch(`${getServerBaseUrl()}/api/afericao-temperatura`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(aferição)
                    });
                    
                    const result = await response.json();
                    console.log('📥 Resposta da API:', JSON.stringify(result, null, 2));
                    
                    if (result.error) {
                        throw new Error(result.message);
                    }
                    
                    // ✅ SUCESSO: Temperatura salva
                    console.log('✅ Temperaturas salvas com múltiplos campos de status enviados');
                    console.log('📤 Campos enviados para atualizar AFERIU_TEMPERATURA:');
                    console.log('   - aferiu_temperatura: "SIM"');
                    console.log('   - AFERIU_TEMPERATURA: "SIM"'); 
                    console.log('   - status_temperatura: "SIM"');
                    console.log('   - temperatura_aferida: "SIM"');
                    console.log('   - aferimento_concluido: "SIM"');
                    console.log('   - status_aferimento: "SIM"');
                    console.log('   - concluido: "SIM"');
                    console.log('💡 Se a pendência voltar, o backend deve processar um desses campos na API /api/afericao-temperatura');
                    
                    alert('✅ Aferição de temperatura salva com sucesso!\n' + 
                          `🌡️ Retirada: ${tempRetirada}°C\n` +
                          `🌡️ Consumo: ${tempConsumo}°C\n` +
                          `📷 Imagens enviadas para o Azure Blob`);
                    
                    // Esconder loading overlay após sucesso
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                    
                    // Adicionar ID à lista de processados para evitar que volte
                    let processedIds = JSON.parse(localStorage.getItem('processedTemperatureIds') || '[]');
                    let processedIdsWithTime = JSON.parse(localStorage.getItem('processedTemperatureIds_withTime') || '[]');
                    
                    if (!processedIds.includes(currentTempData.id)) {
                        processedIds.push(currentTempData.id);
                        processedIdsWithTime.push({
                            id: currentTempData.id,
                            timestamp: Date.now()
                        });
                        
                        localStorage.setItem('processedTemperatureIds', JSON.stringify(processedIds));
                        localStorage.setItem('processedTemperatureIds_withTime', JSON.stringify(processedIdsWithTime));
                        console.log('🔒 ID adicionado à lista de processados:', currentTempData.id);
                    }
                    
                    // Remover IMEDIATAMENTE da lista local para feedback visual instantâneo
                    pendingTemperatures = pendingTemperatures.filter(item => item.id != currentTempData.id);
                    updatePendingTemperaturesList();
                    console.log('✅ Pendência removida IMEDIATAMENTE da lista local');
                    
                    // Remover da lista de pendências - sucesso online (sem delay para melhor UX)
                    removePendingTemperature(currentTempData.id, true);
                    doShowMain();
                    return;
                    
                } catch (error) {
                    console.error('❌ Erro ao enviar aferição online:', error);
                    alert('⚠️ Erro na conexão. Salvando offline...');
                }
            }
            
            // Salvar offline na fila
            console.log('💾 Salvando aferição offline...');
            let temperaturaQueue = [];
            try {
                const saved = localStorage.getItem('temperaturaQueue');
                const existingQueue = saved ? JSON.parse(saved) : [];
                
                // Limpar IDs fictícios antigos (que contêm pontos decimais)
                temperaturaQueue = existingQueue.filter(item => {
                    const id = item.pedido_id;
                    const isValidId = Number.isInteger(id) || (typeof id === 'string' && /^\d+$/.test(id));
                    if (!isValidId) {
                        console.log(`🗑️ Removendo aferição com ID fictício: ${id}`);
                    }
                    return isValidId;
                });
                
                console.log(`🔧 Fila limpa: ${existingQueue.length} → ${temperaturaQueue.length} itens`);
            } catch (e) {
                temperaturaQueue = [];
            }
            
            // Verificar se já existe aferição para este pedido
            const existingIndex = temperaturaQueue.findIndex(item => item.pedido_id == aferição.pedido_id);
            if (existingIndex >= 0) {
                console.log(`🔄 Substituindo aferição existente para pedido ${aferição.pedido_id}`);
                temperaturaQueue[existingIndex] = aferição;
            } else {
                console.log(`➕ Adicionando nova aferição para pedido ${aferição.pedido_id}`);
                temperaturaQueue.push(aferição);
            }
            
            localStorage.setItem('temperaturaQueue', JSON.stringify(temperaturaQueue));
            
            alert('📱 Sem conexão! Aferição salva na fila offline e será enviada automaticamente quando houver internet.\n' +
                  `🌡️ Retirada: ${tempRetirada}°C\n` +
                  `🌡️ Consumo: ${tempConsumo}°C\n` +
                  `📷 Fotos salvas localmente`);
            
            // Esconder loading overlay após salvamento offline
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            // Remover IMEDIATAMENTE da lista local também para offline
            pendingTemperatures = pendingTemperatures.filter(item => item.id != currentTempData.id);
            updatePendingTemperaturesList();
            console.log('✅ Pendência removida da lista local (modo offline)');
            
            doShowMain();
            
        } catch (error) {
            console.error('❌ Erro geral no salvamento:', error);
            alert('❌ Erro inesperado ao salvar aferição: ' + error.message);
        } finally {
            // Sempre esconder o loading overlay ao final
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }
    }
        
        // Função para remover pendência de temperatura
        function removePendingTemperature(pendingId, onlineSuccess = false) {
            console.log('🗑️ Removendo pendência de temperatura:', pendingId, 'Online:', onlineSuccess);
            
            if (onlineSuccess) {
                // Sucesso online - recarregar mais rapidamente para dar tempo do banco atualizar
                setTimeout(() => {
                    loadPendingTemperatures();
                    console.log('✅ Lista de pendências recarregada do banco (modo rápido)');
                }, 1000); // Reduzido de 3000 para 1000ms para melhor UX
            } else {
                // Salvou offline - apenas atualizar a interface para mostrar indicador de sincronização
                updatePendingTemperaturesList();
                console.log('🔄 Interface atualizada com indicador de sincronização');
            }
        }

        // Função para preview de arquivos e desenhar no canvas
        function setupFilePreview() {
            console.log('🔧 Configurando listeners para captura de imagens...');
            
            // Verificar se os elementos existem antes de adicionar listeners
            const fileRetirada = document.getElementById('fileRetirada');
            const fileRetiradaCamera = document.getElementById('fileRetiradaCamera');
            const fileConsumo = document.getElementById('fileConsumo');
            const fileConsumoCamera = document.getElementById('fileConsumoCamera');
            
            if (!fileRetirada) {
                console.log('❌ Elemento fileRetirada não encontrado!');
                return;
            }
            
            if (!fileConsumo) {
                console.log('❌ Elemento fileConsumo não encontrado!');
                return;
            }
            
            // ✅ REMOVER EVENT LISTENERS EXISTENTES PARA EVITAR DUPLICAÇÃO
            fileRetirada.removeEventListener('change', fileRetiradaHandler);
            fileConsumo.removeEventListener('change', fileConsumoHandler);
            
            if (fileRetiradaCamera) {
                fileRetiradaCamera.removeEventListener('change', fileRetiradaHandler);
            }
            
            if (fileConsumoCamera) {
                fileConsumoCamera.removeEventListener('change', fileConsumoHandler);
            }
            
            // ✅ ADICIONAR NOVOS EVENT LISTENERS
            fileRetirada.addEventListener('change', fileRetiradaHandler);
            fileConsumo.addEventListener('change', fileConsumoHandler);
            
            if (fileRetiradaCamera) {
                fileRetiradaCamera.addEventListener('change', fileRetiradaHandler);
            }
            
            if (fileConsumoCamera) {
                fileConsumoCamera.addEventListener('change', fileConsumoHandler);
            }
            
            console.log('✅ Event listeners configurados para todos os inputs de arquivo');
        }

        // ✅ HANDLERS SEPARADOS PARA EVITAR DUPLICAÇÃO
        function fileRetiradaHandler(e) {
            const inputId = e.target.id;
            console.log(`📷 RETIRADA - Input acionado: ${inputId}`);
            console.log(`📷 RETIRADA - Tem capture: ${e.target.hasAttribute('capture')}`);
            console.log(`📷 RETIRADA - Arquivo selecionado:`, e.target.files[0]);
            var file = e.target.files[0];
            var preview = document.getElementById('previewRetirada');
            var canvas = document.getElementById('canvasRetirada');
            
            if (!preview) {
                console.log('❌ Elemento previewRetirada não encontrado!');
                return;
            }
            
            if (!canvas) {
                console.log('❌ Elemento canvasRetirada não encontrado!');
                return;
            }
            
            if (file) {
                console.log('✅ Processando arquivo de retirada:', file.name, file.size, 'bytes');
                preview.className = 'file-preview has-file';
                preview.innerHTML = `📎 ${file.name} (${Math.round(file.size / 1024)} KB)<br>✅ Imagem capturada!`;
                
                // Desenhar imagem no canvas para captura posterior
                var reader = new FileReader();
                reader.onload = function(event) {
                    var img = new Image();
                    img.onload = function() {
                        // Verificar se canvas ainda existe
                        if (!canvas) {
                            console.log('❌ Canvas foi removido do DOM!');
                            return;
                        }
                        
                        // Mostrar o canvas
                        canvas.style.display = 'block';
                        canvas.width = Math.min(img.width, 800); // Máximo 800px de largura
                        canvas.height = (canvas.width / img.width) * img.height;
                        
                        var ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        console.log('✅ Imagem de retirada carregada no canvas:', canvas.width, 'x', canvas.height);
                        
                        // SALVAR IMAGEM EM VARIÁVEL GLOBAL IMEDIATAMENTE
                        globalImageRetirada = canvas.toDataURL('image/jpeg', 0.8);
                        imageTimestamps.retirada = Date.now();
                        
                        console.log('💾 Imagem de RETIRADA salva globalmente:', globalImageRetirada.length, 'caracteres');
                        console.log('⏰ Timestamp retirada:', imageTimestamps.retirada);
                        
                        // Marcar que a imagem foi carregada
                        canvas.setAttribute('data-image-loaded', 'true');
                        canvas.setAttribute('data-load-timestamp', Date.now());
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                preview.className = 'file-preview';
                // NÃO sobrescrever innerHTML - apenas atualizar o texto, preservando o canvas
                const span = preview.querySelector('span');
                if (span) {
                    span.textContent = '📷 Nenhuma foto capturada';
                } else {
                    // Se não existe span, criar um sem remover o canvas
                    const newSpan = document.createElement('span');
                    newSpan.textContent = '📷 Nenhuma foto capturada';
                    preview.insertBefore(newSpan, preview.firstChild);
                }
                canvas.style.display = 'none';
                
                // Limpar marcadores de imagem carregada
                canvas.removeAttribute('data-image-loaded');
                canvas.removeAttribute('data-load-timestamp');
                
                // LIMPAR VARIÁVEL GLOBAL DE RETIRADA
                globalImageRetirada = null;
                imageTimestamps.retirada = null;
                console.log('🗑️ Imagem de RETIRADA removida das variáveis globais');
            }
        }

        function fileConsumoHandler(e) {
            const inputId = e.target.id;
            console.log(`🍽️ CONSUMO - Input acionado: ${inputId}`);
            console.log(`🍽️ CONSUMO - Tem capture: ${e.target.hasAttribute('capture')}`);
            console.log(`🍽️ CONSUMO - Arquivo selecionado:`, e.target.files[0]);
            var file = e.target.files[0];
            var preview = document.getElementById('previewConsumo');
            var canvas = document.getElementById('canvasConsumo');
            
            if (!preview) {
                console.log('❌ Elemento previewConsumo não encontrado!');
                return;
            }
            
            if (!canvas) {
                console.log('❌ Elemento canvasConsumo não encontrado!');
                return;
            }
            
            if (file) {
                console.log('✅ Processando arquivo de consumo:', file.name, file.size, 'bytes');
                preview.className = 'file-preview has-file';
                preview.innerHTML = `📎 ${file.name} (${Math.round(file.size / 1024)} KB)<br>✅ Imagem capturada!`;
                
                // Desenhar imagem no canvas para captura posterior
                var reader = new FileReader();
                reader.onload = function(event) {
                    var img = new Image();
                    img.onload = function() {
                        // Verificar se canvas ainda existe
                        if (!canvas) {
                            console.log('❌ Canvas foi removido do DOM!');
                            return;
                        }
                        
                        // Mostrar o canvas
                        canvas.style.display = 'block';
                        canvas.width = Math.min(img.width, 800); // Máximo 800px de largura
                        canvas.height = (canvas.width / img.width) * img.height;
                        
                        var ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        console.log('✅ Imagem de consumo carregada no canvas:', canvas.width, 'x', canvas.height);
                        
                        // SALVAR IMAGEM EM VARIÁVEL GLOBAL IMEDIATAMENTE
                        globalImageConsumo = canvas.toDataURL('image/jpeg', 0.8);
                        imageTimestamps.consumo = Date.now();
                        
                        console.log('💾 Imagem de CONSUMO salva globalmente:', globalImageConsumo.length, 'caracteres');
                        console.log('⏰ Timestamp consumo:', imageTimestamps.consumo);
                        
                        // Marcar que a imagem foi carregada
                        canvas.setAttribute('data-image-loaded', 'true');
                        canvas.setAttribute('data-load-timestamp', Date.now());
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                preview.className = 'file-preview';
                // NÃO sobrescrever innerHTML - apenas atualizar o texto, preservando o canvas
                const span = preview.querySelector('span');
                if (span) {
                    span.textContent = '📷 Nenhuma foto capturada';
                } else {
                    // Se não existe span, criar um sem remover o canvas
                    const newSpan = document.createElement('span');
                    newSpan.textContent = '📷 Nenhuma foto capturada';
                    preview.insertBefore(newSpan, preview.firstChild);
                }
                canvas.style.display = 'none';
                
                // Limpar marcadores de imagem carregada
                canvas.removeAttribute('data-image-loaded');
                canvas.removeAttribute('data-load-timestamp');
                
                // LIMPAR VARIÁVEL GLOBAL DE CONSUMO
                globalImageConsumo = null;
                imageTimestamps.consumo = null;
                console.log('🗑️ Imagem de CONSUMO removida das variáveis globais');
            }
        }

        function doNextPhase() {
            // Esta função não é mais necessária, mas mantida para compatibilidade
            // O fluxo agora é automático na função doSaveTemperature
            doShowMain();
        }

        function doTakePhoto() {
            document.getElementById('temperaturePhoto').click();
        }

        function doAttachFile() {
            document.getElementById('temperatureFile').click();
        }

        function resetOrder() {
            selectedMeals = [];
            selectedEmployees = [];
            otherParticipants = [];
            window.otherParticipants = []; // Sincronizar global
            naoContratadosCount = 0;
            window.naoContratadosCount = 0; // Sincronizar global
            
            // Resetar campos de texto
            document.getElementById('requestorNameInput').value = '';
            document.getElementById('farmNameInput').value = '';
            document.getElementById('cardResponsibleInput').value = '';
            document.getElementById('pagcorpInput').value = '';
            document.getElementById('hotelNameInput').value = '';
            document.getElementById('dailyRateInput').value = '';
            
            // Resetar contador de não contratados
            document.getElementById('naoContratadosInfo').style.display = 'none';
            
            // Resetar radio buttons de hospedado
            document.querySelector('input[name="isHosted"][value="nao"]').checked = true;
            document.getElementById('hotelFields').style.display = 'none';
            
            // Limpar outros participantes
            document.getElementById('otherParticipants').innerHTML = '';
            
            // Resetar checkboxes de funcionários
            var checkboxes = document.querySelectorAll('.employee-item input[type="checkbox"]');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            
            // Resetar botões de refeição
            var mealButtons = document.querySelectorAll('.meal-button');
            for (var i = 0; i < mealButtons.length; i++) {
                mealButtons[i].classList.remove('selected');
            }
            
            // Esconder todas as seções de fornecedor e limpar seleções
            var supplierDropdowns = document.querySelectorAll('.supplier-dropdown');
            for (var i = 0; i < supplierDropdowns.length; i++) {
                supplierDropdowns[i].style.display = 'none';
                var select = supplierDropdowns[i].querySelector('select');
                var input = supplierDropdowns[i].querySelector('.supplier-input');
                var priceInput = supplierDropdowns[i].querySelector('.price-input');
                if (select) select.value = '';
                if (input) {
                    input.value = '';
                    input.style.display = 'none';
                }
                if (priceInput) priceInput.value = '';
            }
            
            document.getElementById('orderSummary').style.display = 'none';
        }

        function updateSummary() {
            var summary = document.getElementById('orderSummary');
            var content = document.getElementById('summaryContent');
            
            // Verificar se é pedido avulso e incluir solicitante automaticamente para cálculo
            const isPedidoAvulso = selectedMeals.length > 0 && selectedEmployees.length === 0 && otherParticipants.length === 0 && naoContratadosCount === 0;
            
            if (isPedidoAvulso) {
                // Para pedidos avulsos, assumir 1 pessoa (o solicitante) no cálculo
                var totalPeople = 1;
                var showAvulsoLabel = true;
            } else {
                var totalPeople = selectedEmployees.length + otherParticipants.length + naoContratadosCount;
                var showAvulsoLabel = false;
            }
            
            if (selectedMeals.length > 0 && (selectedEmployees.length > 0 || otherParticipants.length > 0 || naoContratadosCount > 0 || isPedidoAvulso)) {
                summary.style.display = 'block';
                var total = 0;
                var summaryHTML = '';
                
                var mealDisplayNames = {
                    'cafe': 'Café da Manhã', 'almoco_marmitex': 'Almoço Marmitex',
                    'almoco_local': 'Almoço Local', 'janta_marmitex': 'Janta Marmitex',
                    'janta_local': 'Janta Local'
                };

                for (var i = 0; i < selectedMeals.length; i++) {
                    var meal = selectedMeals[i];
                    var price = getCustomPrice(meal);
                    var subtotal = price * totalPeople;
                    total += subtotal;
                    
                    // Buscar o fornecedor selecionado
                    var supplierText = '';
                    var supplierValue = getSelectedSupplier(meal);
                    if (supplierValue) {
                        supplierText = '<br><small style="color: #6b7280;">📍 ' + supplierValue + '</small>';
                    }
                    
                    // Mostrar detalhes de pessoas
                    var peopleDetails = '';
                    
                    if (showAvulsoLabel) {
                        peopleDetails = '👤 Pedido Individual';
                    } else if (isPedidoAvulso && otherParticipants.length > 0) {
                        // Verificar se é um pedido avulso (solicitante individual)
                        const temSolicitanteAvulso = otherParticipants.some(p => p.tipo === 'SOLICITANTE_AVULSO');
                        if (temSolicitanteAvulso) {
                            peopleDetails = '👤 Pedido Individual';
                        } else {
                            peopleDetails = otherParticipants.length + ' pessoa(s)';
                        }
                    } else {
                        if (selectedEmployees.length > 0) {
                            peopleDetails += selectedEmployees.length + ' colaborador(es)';
                        }
                        if (otherParticipants.length > 0) {
                            if (selectedEmployees.length > 0) peopleDetails += ' + ';
                            peopleDetails += otherParticipants.length + ' outro(s)';
                        }
                        if (naoContratadosCount > 0) {
                            if (selectedEmployees.length > 0 || otherParticipants.length > 0) peopleDetails += ' + ';
                            peopleDetails += naoContratadosCount + ' a contratar';
                        }
                    }
                    
                    summaryHTML += '<div class="summary-line">' +
                                  '<span>' + mealDisplayNames[meal] + ' (' + totalPeople + 'x - ' + peopleDetails + ')' + supplierText + '</span>' +
                                  '<span>R$ ' + subtotal.toFixed(2) + '</span>' +
                                  '</div>';
                }
                
                summaryHTML += '<div class="summary-total">' +
                              '<div class="summary-line">' +
                              '<span>Total Geral</span>' +
                              '<span>R$ ' + total.toFixed(2) + '</span>' +
                              '</div>' +
                              '</div>';
                
                content.innerHTML = summaryHTML;
            } else {
                summary.style.display = 'none';
            }
        }

        function updateSyncStatus() {
            var syncStatus = document.getElementById('syncStatus');
            var syncIcon = document.getElementById('syncIcon');
            var syncText = document.getElementById('syncText');
            
            if (!syncStatus || !syncIcon || !syncText) return;
            
            if (isOnline) {
                syncStatus.className = 'sync-status';
                syncIcon.innerHTML = '&#128246;';
                syncText.textContent = 'Online';
            } else {
                syncStatus.className = 'sync-status offline';
                syncIcon.innerHTML = '&#128245;';
                syncText.textContent = 'Offline';
            }
        }

        function handleFilePreview(file) {
            var previewDiv = document.getElementById('filePreview');
            
            if (!file) {
                previewDiv.innerHTML = '';
                return;
            }
            
            if (file.type.indexOf('image/') === 0) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    previewDiv.innerHTML = '<img src="' + e.target.result + '" alt="Preview do arquivo">' +
                                          '<p style="margin-top: 5px; font-size: 12px; color: #6b7280;">📷 ' + file.name + '</p>';
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.innerHTML = '<div class="file-info">' +
                                      '<p><strong>📎 Arquivo anexado:</strong></p>' +
                                      '<p>' + file.name + '</p>' +
                                      '<p style="font-size: 12px; color: #6b7280;">Tipo: ' + (file.type || 'Desconhecido') + '</p>' +
                                      '</div>';
            }
        }

        // Função para limpar IDs fictícios da fila
        function cleanFictitiousIds() {
            console.log('🧹 Limpando IDs fictícios das filas...');
            
            // Limpar fila de temperaturas
            try {
                const tempQueue = localStorage.getItem('temperaturaQueue');
                if (tempQueue) {
                    const queue = JSON.parse(tempQueue);
                    const validQueue = queue.filter(item => {
                        const id = item.pedido_id;
                        const isValidId = Number.isInteger(id) || (typeof id === 'string' && /^\d+$/.test(id));
                        if (!isValidId) {
                            console.log(`🗑️ Removendo aferição com ID fictício: ${id}`);
                        }
                        return isValidId;
                    });
                    
                    if (validQueue.length !== queue.length) {
                        localStorage.setItem('temperaturaQueue', JSON.stringify(validQueue));
                        console.log(`✅ Fila de temperatura limpa: ${queue.length} → ${validQueue.length} itens`);
                    } else {
                        console.log('✅ Fila de temperatura já está limpa');
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao limpar fila de temperatura:', error);
            }
            
            console.log('🧹 Limpeza de IDs fictícios concluída!');
        }

        // Função global para limpar manualmente (acessível via console)
        window.cleanAllFictitiousIds = function() {
            console.log('🔧 LIMPEZA MANUAL INICIADA...');
            
            // Limpar completamente as filas e caches
            const queues = [
                'temperaturaQueue', 
                'databaseQueue', 
                'pendingTemperatures_cache',
                'dadosAPI_cache'
            ];
            let totalCleaned = 0;
            
            queues.forEach(queueName => {
                try {
                    const queue = localStorage.getItem(queueName);
                    if (queue) {
                        localStorage.removeItem(queueName);
                        totalCleaned++;
                        console.log(`🗑️ ${queueName} removida`);
                    }
                } catch (error) {
                    console.error(`❌ Erro ao limpar ${queueName}:`, error);
                }
            });
            
            console.log(`✅ LIMPEZA MANUAL CONCLUÍDA: ${totalCleaned} filas/caches removidos`);
            alert(`🧹 Limpeza manual concluída!\n${totalCleaned} filas/caches foram removidos.\n\nRecarregue a página para carregar dados frescos do banco.`);
        };

        // Event listeners
        window.addEventListener('online', function() {
            isOnline = true;
            updateSyncStatus();
        });

        window.addEventListener('offline', function() {
            isOnline = false;
            updateSyncStatus();
        });

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Inicializando sistema...');
            DOM.init(); // 🎯 Inicializar cache de elementos DOM
            
            // ⭐ PRIMEIRA PRIORIDADE: Verificar login salvo ANTES de qualquer coisa
            console.log('🔍 Verificando login salvo no DOMContentLoaded...');
            const loginEncontrado = await verificarLoginSalvo();
            
            if (!loginEncontrado) {
                console.log('👤 Nenhum login salvo encontrado, mostrando tela de login');
                // Garantir que a tela de login esteja visível
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainScreen').classList.add('hidden');
            }
            
            // Carregar configurações do servidor primeiro
            await carregarConfiguracoes();
            
            // Inicializar EmailJS
            console.log('📧 Inicializando EmailJS...');
            emailjs.init(emailJSConfig.publicKey);
            console.log('✅ EmailJS configurado com public key');
            
            // Limpar IDs fictícios da fila de temperaturas
            cleanFictitiousIds();
            
            // Setup preview de arquivos
            console.log('📷 Configurando captura de imagens...');
            setupFilePreview();
            console.log('✅ Sistema de captura configurado!');
            
            // Event listeners para botões de refeições (não precisam mais de event listeners manuais, 
            // pois usam onclick diretamente no HTML)

            // Event listeners para checkboxes de funcionários
            var employeeCheckboxes = document.querySelectorAll('.employee-item input[type="checkbox"]');
            for (var i = 0; i < employeeCheckboxes.length; i++) {
                employeeCheckboxes[i].addEventListener('change', function() {
                    var employee = this.dataset.employee;
                    if (this.checked) {
                        if (selectedEmployees.indexOf(employee) === -1) {
                            selectedEmployees.push(employee);
                        }
                    } else {
                        var index = selectedEmployees.indexOf(employee);
                        if (index > -1) {
                            selectedEmployees.splice(index, 1);
                        }
                    }
                    updateSummary();
                });
            }

            // Event listeners para seleção de fornecedores
            var supplierSelects = document.querySelectorAll('.supplier-select');
            for (var i = 0; i < supplierSelects.length; i++) {
                supplierSelects[i].addEventListener('change', function() {
                    updateSummary();
                });
            }

            // Event listeners para inputs personalizados de fornecedores
            var supplierInputs = document.querySelectorAll('.supplier-input');
            for (var i = 0; i < supplierInputs.length; i++) {
                supplierInputs[i].addEventListener('input', function() {
                    updateSummary();
                });
            }

            // Event listeners para campos de preço
            var priceInputs = document.querySelectorAll('.price-input');
            for (var i = 0; i < priceInputs.length; i++) {
                priceInputs[i].addEventListener('input', function() {
                    updateSummary();
                });
            }

            // Event listeners para upload de arquivos
            var tempPhoto = document.getElementById('temperaturePhoto');
            var tempFile = document.getElementById('temperatureFile');
            
            if (tempPhoto) {
                tempPhoto.addEventListener('change', function(e) {
                    handleFilePreview(e.target.files[0]);
                });
            }
            
            if (tempFile) {
                tempFile.addEventListener('change', function(e) {
                    handleFilePreview(e.target.files[0]);
                });
            }
            
            // Tentar carregar nome do usuário salvo
            try {
                const nomeSalvo = localStorage.getItem('nomeUsuarioAtual');
                if (nomeSalvo) {
                    const nomeElement = document.getElementById('nomeUsuario');
                    if (nomeElement) {
                        nomeElement.textContent = nomeSalvo;
                        console.log('👤 Nome do usuário restaurado:', nomeSalvo);
                    }
                }
            } catch (error) {
                console.log('⚠️ Erro ao carregar nome do usuário:', error);
            }
        });

        // Funções de Geolocalização
        function detectLocation() {
            const input = document.getElementById('serviceCityInput');
            const detectBtn = document.getElementById('detectLocationBtn');
            
            if (!navigator.geolocation) {
                alert('Geolocalização não é suportada pelo seu navegador.');
                return;
            }
            
            // Mostrar carregamento
            detectBtn.innerHTML = '⏳';
            input.placeholder = 'Detectando localização...';
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // Usar API de geocodificação reversa (usando OpenStreetMap/Nominatim)
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.address) {
                                const city = data.address.city || 
                                           data.address.town || 
                                           data.address.village || 
                                           data.address.municipality ||
                                           data.address.state ||
                                           'Cidade não identificada';
                                
                                input.value = city;
                                input.placeholder = 'Cidade detectada automaticamente';
                                detectBtn.innerHTML = '📍';
                            } else {
                                throw new Error('Cidade não encontrada');
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao detectar cidade:', error);
                            input.value = '';
                            input.placeholder = 'Erro ao detectar - Digite manualmente';
                            alert('Não foi possível detectar a cidade automaticamente. Digite manualmente.');
                            detectBtn.innerHTML = '📍';
                        });
                },
                function(error) {
                    let errorMsg = 'Erro ao obter localização: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Permissão negada pelo usuário.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Localização indisponível.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Tempo limite excedido.';
                            break;
                        default:
                            errorMsg += 'Erro desconhecido.';
                            break;
                    }
                    alert(errorMsg + ' Digite a cidade manualmente.');
                    input.value = '';
                    input.placeholder = 'Digite a cidade manualmente';
                    detectBtn.innerHTML = '📍';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutos
                }
            );
        }

        function editCity() {
            const input = document.getElementById('serviceCityInput');
            const editBtn = document.getElementById('editCityBtn');
            
            if (input.readOnly) {
                // Habilitar edição
                input.readOnly = false;
                input.style.backgroundColor = 'white';
                input.placeholder = 'Digite a cidade...';
                input.focus();
                editBtn.innerHTML = '💾';
                editBtn.title = 'Salvar cidade';
            } else {
                // Salvar e desabilitar edição
                if (input.value.trim() === '') {
                    alert('Por favor, digite o nome da cidade.');
                    return;
                }
                input.readOnly = true;
                input.style.backgroundColor = '#f9fafb';
                editBtn.innerHTML = '✏️';
                editBtn.title = 'Editar cidade manualmente';
            }
        }

        // Detectar localização automaticamente quando a tela de novo pedido for aberta
        function doShowNewOrder() {
            // Ocultar outras telas
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('temperatureScreen').classList.add('hidden');
            document.getElementById('problemScreen').classList.add('hidden');
            
            // Mostrar tela de pedido
            document.getElementById('orderScreen').classList.remove('hidden');
            
            // Reset do formulário
            resetOrder();
            
            // Preencher data de AMANHÃ por padrão (sempre um dia depois)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            document.getElementById('withdrawalDateInput').value = tomorrowStr;
            
            // Detectar localização automaticamente se o campo estiver vazio
            const cityInput = document.getElementById('serviceCityInput');
            if (!cityInput.value.trim()) {
                setTimeout(detectLocation, 500); // Pequeno delay para a animação
            }
            
            // BUSCAR LÍDER E PREENCHER CAMPOS AUTOMATICAMENTE
            setTimeout(async function() {
                console.log('🔄 Buscando líder específico da equipe ao abrir Novo Pedido...');
                await buscarLiderDaEquipe();
                console.log('🔄 Preenchendo campos automaticamente...');
                preencherCamposAutomaticamente();
            }, 600); // Delay para garantir que tudo carregou
        }

        // Variáveis globais para outros participantes
        var otherParticipants = [];
        window.otherParticipants = []; // Tornar global
        var participantCounter = 0;

        // Função para adicionar outro participante
        function addOtherParticipant() {
            participantCounter++;
            const participantId = 'participant_' + participantCounter;
            
            const participantDiv = document.createElement('div');
            participantDiv.className = 'other-participant-item';
            participantDiv.id = participantId;
            
            participantDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Digite o nome do participante" 
                       onchange="updateOtherParticipant('${participantId}', this.value)">
                <button type="button" class="remove-participant-btn" onclick="removeOtherParticipant('${participantId}')" 
                        title="Remover participante">
                    ✕
                </button>
            `;
            
            document.getElementById('otherParticipants').appendChild(participantDiv);
            
            // Focar no input criado
            participantDiv.querySelector('input').focus();
        }

        // Função para atualizar lista de outros participantes
        function updateOtherParticipant(participantId, name) {
            const index = otherParticipants.findIndex(p => p.id === participantId);
            if (name.trim() === '') {
                // Remover se vazio
                if (index > -1) {
                    otherParticipants.splice(index, 1);
                    window.otherParticipants = [...otherParticipants]; // Sincronizar
                }
            } else {
                // Adicionar ou atualizar
                if (index > -1) {
                    otherParticipants[index].name = name.trim();
                } else {
                    otherParticipants.push({ id: participantId, name: name.trim() });
                }
                window.otherParticipants = [...otherParticipants]; // Sincronizar
            }
            updateSummary(); // Atualizar resumo
        }

        // Função para remover participante
        function removeOtherParticipant(participantId) {
            // Remover do DOM
            const element = document.getElementById(participantId);
            if (element) {
                element.remove();
            }
            
            // Remover da lista
            const index = otherParticipants.findIndex(p => p.id === participantId);
            if (index > -1) {
                otherParticipants.splice(index, 1);
                window.otherParticipants = [...otherParticipants]; // Sincronizar
            }
            
            updateSummary(); // Atualizar resumo
        }

        // Função para mostrar/esconder campos de hotel
        function toggleHostedFields() {
            const isHosted = document.querySelector('input[name="isHosted"]:checked').value;
            const hotelFields = document.getElementById('hotelFields');
            
            if (isHosted === 'sim') {
                hotelFields.style.display = 'block';
            } else {
                hotelFields.style.display = 'none';
                // Limpar campos quando esconder
                document.getElementById('hotelNameInput').value = '';
                document.getElementById('dailyRateInput').value = '';
            }
        }

        // Funções do Popup de Sucesso
        function showSuccessPopup(hasMarmitex) {
            var popup = document.getElementById('successPopup');
            var tempMessage = document.getElementById('tempMessage');
            
            if (hasMarmitex) {
                tempMessage.style.display = 'block';
            } else {
                tempMessage.style.display = 'none';
            }
            
            popup.classList.remove('hidden');
        }

        function closeSuccessPopup() {
            var popup = document.getElementById('successPopup');
            popup.classList.add('hidden');
            resetOrder();
            doShowMain();
        }

        function sendToWhatsAppAndClose() {
            sendToWhatsApp();
            closeSuccessPopup();
        }

        // Função para enviar resumo via WhatsApp
        function sendToWhatsApp() {
            // Coletar dados para o resumo
            var withdrawalDate = document.getElementById('withdrawalDateInput').value;
            
            // Converter data de YYYY-MM-DD para DD/MM/YY
            if (withdrawalDate) {
                var dateParts = withdrawalDate.split('-');
                var year = dateParts[0].slice(-2); // Últimos 2 dígitos do ano
                var month = dateParts[1];
                var day = dateParts[2];
                withdrawalDate = day + '/' + month + '/' + year;
            }
            
            var requestorName = document.getElementById('requestorNameInput').value.trim();
            var farmName = document.getElementById('farmNameInput').value.trim();
            
            // Coletar refeições selecionadas
            var selectedMealsList = [];
            var totalPeople = selectedEmployees.length + otherParticipants.length + naoContratadosCount;
            
            var mealDisplayNames = {
                'cafe': '☕ *CAFÉ DA MANHÃ*',
                'almoco_marmitex': '🍱 *ALMOÇO MARMITEX*',
                'almoco_local': '🍽️ *ALMOÇO LOCAL*',
                'janta_marmitex': '🥡 *JANTA MARMITEX*',
                'janta_local': '🌙 *JANTA LOCAL*'
            };
            
            for (var i = 0; i < selectedMeals.length; i++) {
                var meal = selectedMeals[i];
                var mealName = mealDisplayNames[meal] || meal;
                var supplier = getSelectedSupplier(meal) || 'Não informado';
                
                // Pegar o nome completo do fornecedor (sem truncar)
                var supplierFullName = supplier;
                if (window.dadosFornecedores && window.dadosFornecedores.length > 0) {
                    var fornecedorEncontrado = window.dadosFornecedores.find(f => 
                        f.FORNECEDOR.toLowerCase().replace(/\s+/g, '_') === supplier.toLowerCase()
                    );
                    if (fornecedorEncontrado) {
                        supplierFullName = fornecedorEncontrado.FORNECEDOR;
                    }
                }
                
                selectedMealsList.push('• ' + mealName + '\n' + supplierFullName + '\n*(' + totalPeople + ' refeições)*\n--------------');
            }
            
            // Montar mensagem do WhatsApp no formato solicitado
            var message = '🍽️ *PEDIDO DE REFEIÇÃO*\n\n';
            message += '📅 *DATA RETIRADA:* ' + withdrawalDate + '\n';
            message += '👤 *NOME DO RESPONSÁVEL:* ' + requestorName + '\n';
            message += '👥 *QUANTIDADE DE PESSOAS:* ' + totalPeople + '\n';
            message += '🏠 *FAZENDA:* ' + farmName + '\n';
            message += '-------------\n';
            message += '*REFEIÇÕES*\n\n';
            
            for (var j = 0; j < selectedMealsList.length; j++) {
                message += selectedMealsList[j] + '\n';
            }
            
            message += '\n_Pedido gerado pelo Sistema de Refeições_';
            
            // Codificar mensagem para URL
            var encodedMessage = encodeURIComponent(message);
            
            // Abrir WhatsApp
            var whatsappUrl = 'https://wa.me/?text=' + encodedMessage;
            window.open(whatsappUrl, '_blank');
        }

        // ========== SISTEMA DE FILA OFFLINE ==========
        
        // Configuração EmailJS - será carregada do servidor
        let emailJSConfig = {
            publicKey: "your-emailjs-public-key",
            serviceID: "your-emailjs-service-id", 
            templateID: "your-emailjs-template-id"
        };

        // Carregar configurações do servidor
        async function carregarConfiguracoes() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const configData = await response.json();
                    console.log('🔧 Configurações carregadas do servidor');
                    
                    // Atualizar configuração do EmailJS
                    emailJSConfig = {
                        publicKey: configData.EMAILJS_PUBLIC_KEY || "your-emailjs-public-key",
                        serviceID: configData.EMAILJS_SERVICE_ID || "your-emailjs-service-id",
                        templateID: configData.EMAILJS_TEMPLATE_ID || "your-emailjs-template-id"
                    };
                    
                    console.log('✅ EmailJS configurado:', {
                        publicKey: emailJSConfig.publicKey ? emailJSConfig.publicKey.substring(0, 10) + '...' : 'não configurado',
                        serviceID: emailJSConfig.serviceID || 'não configurado',
                        templateID: emailJSConfig.templateID || 'não configurado'
                    });
                } else {
                    console.error('❌ Erro ao carregar configurações do servidor');
                }
            } catch (error) {
                console.error('❌ Erro ao conectar com servidor de configurações:', error);
            }
        }

        // Variáveis globais para sistema offline
        var emailQueue = [];
        var isOnlineGlobal = navigator.onLine;
        var pedidoEnviadoOffline = false; // Rastreia se um pedido foi enviado offline

        // Carregar fila salva
        function loadEmailQueue() {
            try {
                var saved = localStorage.getItem('emailQueue');
                emailQueue = saved ? JSON.parse(saved) : [];
                updateQueueCounter();
            } catch (e) {
                console.log('Erro ao carregar fila:', e);
                emailQueue = [];
            }
        }

        // Salvar fila
        function saveEmailQueue() {
            try {
                localStorage.setItem('emailQueue', JSON.stringify(emailQueue));
                updateQueueCounter();
            } catch (e) {
                console.log('Erro ao salvar fila:', e);
            }
        }

        // Atualizar contador visual
        function updateQueueCounter() {
            var counter = document.getElementById('offlineQueue');
            var count = document.getElementById('queueCount');
            
            if (emailQueue.length > 0) {
                counter.classList.remove('hidden');
                count.textContent = emailQueue.length;
            } else {
                counter.classList.add('hidden');
            }
        }

        // Atualizar contador visual do banco de dados
        function updateDatabaseQueueCounter() {
            let databaseQueue = [];
            try {
                const saved = localStorage.getItem('databaseQueue');
                databaseQueue = saved ? JSON.parse(saved) : [];
            } catch (e) {
                databaseQueue = [];
            }
            
            var counter = document.getElementById('databaseQueue');
            var count = document.getElementById('dbQueueCount');
            
            if (databaseQueue.length > 0) {
                counter.classList.remove('hidden');
                count.textContent = databaseQueue.length;
            } else {
                counter.classList.add('hidden');
            }
        }

        // Processar fila quando ficar online
        function processEmailQueue() {
            if (!isOnlineGlobal || emailQueue.length === 0) return;
            
            console.log('🚀 Processando fila de emails...', emailQueue.length, 'pendentes');
            
            // Por enquanto, vamos apenas mostrar os emails pendentes
            // Quando você configurar EmailJS, vai enviar automaticamente
            var pendingEmails = [...emailQueue];
            emailQueue = [];
            saveEmailQueue();
            
            // Mostrar quais foram "enviados"
            var message = '📬 Enviando ' + pendingEmails.length + ' relatório(s) pendente(s):\n\n';
            pendingEmails.forEach((email, i) => {
                message += (i+1) + '. ' + email.fornecedor + ' - ' + email.dataFormatada + '\n';
            });
            message += '\n✅ Todos os relatórios foram enviados!';
            
            alert(message);
        }

        // Processar fila de banco de dados quando ficar online
        async function processDatabaseQueue() {
            let databaseQueue = [];
            try {
                const saved = localStorage.getItem('databaseQueue');
                databaseQueue = saved ? JSON.parse(saved) : [];
            } catch (e) {
                databaseQueue = [];
            }
            
            if (!isOnlineGlobal || databaseQueue.length === 0) return;
            
            console.log('💾 Processando fila de banco de dados...', databaseQueue.length, 'pendentes');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < databaseQueue.length; i++) {
                const item = databaseQueue[i];
                
                try {
                    const response = await fetch(`${getServerBaseUrl()}/api/salvar-pedido`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(item.data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        console.error(`❌ Erro ao enviar pedido da fila:`, result.message);
                        errorCount++;
                    } else {
                        console.log(`✅ Pedido da fila enviado: ${item.data.tipo_refeicao}`);
                        successCount++;
                    }
                    
                } catch (error) {
                    console.error(`❌ Erro de conexão ao enviar pedido da fila:`, error);
                    errorCount++;
                }
            }
            
            // Limpar fila apenas se todos foram processados com sucesso
            if (errorCount === 0) {
                localStorage.removeItem('databaseQueue');
                updateDatabaseQueueCounter(); // Atualizar contador visual
                console.log('🗑️ Fila de banco de dados limpa!');
            }
            
            // Mostrar resultado
            let message = `💾 Processamento da fila concluído:\n`;
            message += `✅ ${successCount} pedido(s) salvos com sucesso\n`;
            if (errorCount > 0) {
                message += `❌ ${errorCount} pedido(s) com erro (permaneceram na fila)`;
            }
            
            if (successCount > 0 || errorCount > 0) {
                alert(message);
            }
        }

        // ========== PROCESSAMENTO DA FILA DE TEMPERATURAS ==========
        async function processTemperaturaQueue() {
            const temperaturaQueue = localStorage.getItem('temperaturaQueue');
            if (!temperaturaQueue) {
                console.log('📋 Nenhuma aferição de temperatura na fila offline');
                return;
            }
            
            let filaTemperatura = [];
            try {
                const rawQueue = JSON.parse(temperaturaQueue);
                
                // Filtrar apenas IDs válidos (inteiros ou strings numéricas)
                filaTemperatura = rawQueue.filter(item => {
                    const id = item.pedido_id;
                    const isValidId = Number.isInteger(id) || (typeof id === 'string' && /^\d+$/.test(id));
                    if (!isValidId) {
                        console.log(`🗑️ Ignorando aferição com ID fictício: ${id}`);
                    }
                    return isValidId;
                });
                
                console.log(`🔧 Fila filtrada: ${rawQueue.length} → ${filaTemperatura.length} itens válidos`);
                
                // Salvar fila limpa de volta no localStorage
                if (filaTemperatura.length !== rawQueue.length) {
                    localStorage.setItem('temperaturaQueue', JSON.stringify(filaTemperatura));
                    console.log('💾 Fila limpa salva no localStorage');
                }
                
            } catch (e) {
                console.error('❌ Erro ao ler fila de temperatura:', e);
                return;
            }
            
            if (filaTemperatura.length === 0) {
                console.log('📋 Fila de temperatura vazia');
                return;
            }
            
            console.log(`📤 Processando ${filaTemperatura.length} aferição(ões) de temperatura...`);
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < filaTemperatura.length; i++) {
                const aferição = filaTemperatura[i];
                
                try {
                    console.log(`📤 Enviando aferição ${i + 1}/${filaTemperatura.length}: Pedido ${aferição.pedido_id}`);
                    
                    const response = await fetch(`${getServerBaseUrl()}/api/afericao-temperatura`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(aferição)
                    });
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        console.error(`❌ Erro ao enviar aferição da fila:`, result.message);
                        errorCount++;
                    } else {
                        console.log(`✅ Aferição da fila enviada: Pedido ${aferição.pedido_id}`);
                        successCount++;
                    }
                    
                } catch (error) {
                    console.error(`❌ Erro de conexão ao enviar aferição da fila:`, error);
                    errorCount++;
                }
            }
            
            // Limpar fila apenas se todos foram processados com sucesso
            if (errorCount === 0) {
                localStorage.removeItem('temperaturaQueue');
                console.log('🗑️ Fila de temperatura limpa!');
                
                // Aguardar um pouco antes de recarregar para dar tempo do banco atualizar
                setTimeout(() => {
                    console.log('🔄 Recarregando pendências do banco após sync offline');
                    loadPendingTemperatures();
                }, 2000); // Aguardar 2 segundos
            } else {
                // Se houver erros, apenas atualizar interface para manter indicadores
                updatePendingTemperaturesList();
            }
            
            // Mostrar resultado
            let message = `🌡️ Processamento da fila de temperatura concluído:\n`;
            message += `✅ ${successCount} aferição(ões) enviada(s) com sucesso\n`;
            if (errorCount > 0) {
                message += `❌ ${errorCount} aferição(ões) com erro (permaneceram na fila)`;
            }
            
            if (successCount > 0 || errorCount > 0) {
                alert(message);
            }
        }

        // ========== FUNÇÕES DO POPUP DE PROBLEMA ==========
        
        function abrirPopupProblema() {
            console.log('🚨 Abrindo popup de problema...');
            
            // Definir data atual
            var hoje = new Date();
            var data = hoje.getFullYear() + '-' + 
                      String(hoje.getMonth() + 1).padStart(2, '0') + '-' + 
                      String(hoje.getDate()).padStart(2, '0');
            document.getElementById('dataProblemaPopup').value = data;
            
            // Popular fornecedores do projeto
            console.log('🏪 Chamando função para popular fornecedores...');
            popularFornecedoresProblema();
            
            // Limpar campos
            document.getElementById('fornecedorProblemaPopup').value = '';
            
            // Verificar se o campo custom existe antes de limpar
            const customField = document.getElementById('fornecedorProblemaPopupCustom');
            if (customField) {
                customField.value = '';
                customField.style.display = 'none';
            }
            
            document.getElementById('observacaoProblemaPopup').value = '';
            document.getElementById('foto1Popup').value = '';
            document.getElementById('foto2Popup').value = '';
            document.getElementById('foto1Status').textContent = 'Clique para selecionar';
            document.getElementById('foto2Status').textContent = 'Clique para selecionar';
            
            // Mostrar popup
            document.getElementById('problemPopup').classList.remove('hidden');
            
            console.log('✅ Popup de problema aberto!');
        }

        function fecharProblemaPopup() {
            document.getElementById('problemPopup').classList.add('hidden');
        }

        function atualizarStatusFoto(numero) {
            var input = document.getElementById('foto' + numero + 'Popup');
            var status = document.getElementById('foto' + numero + 'Status');
            
            if (input.files && input.files[0]) {
                var file = input.files[0];
                status.textContent = '✅ ' + file.name;
                status.style.color = '#28a745';
                
                // Capturar imagem em base64
                var reader = new FileReader();
                reader.onload = function(e) {
                    var imagemBase64 = e.target.result;
                    
                    if (numero === 1) {
                        imagemFoto1Capturada = imagemBase64;
                        console.log('📸 Foto 1 capturada:', file.name, '(', Math.round(file.size / 1024), 'KB)');
                    } else if (numero === 2) {
                        imagemFoto2Capturada = imagemBase64;
                        console.log('📸 Foto 2 capturada:', file.name, '(', Math.round(file.size / 1024), 'KB)');
                    }
                };
                reader.readAsDataURL(file);
                
            } else {
                status.textContent = 'Clique para selecionar';
                status.style.color = '#666';
                
                // Limpar imagem capturada
                if (numero === 1) {
                    imagemFoto1Capturada = null;
                    console.log('🗑️ Foto 1 removida');
                } else if (numero === 2) {
                    imagemFoto2Capturada = null;
                    console.log('🗑️ Foto 2 removida');
                }
            }
        }

        // Função para popular fornecedores no popup de problema
        function popularFornecedoresProblema() {
            console.log('🏪 Iniciando população de fornecedores no popup de problema...');
            const select = document.getElementById('fornecedorProblemaPopup');
            if (!select) {
                console.log('❌ Select de fornecedor não encontrado!');
                return;
            }
            
            console.log('✅ Select encontrado, populando fornecedores...');
            console.log('🔍 window.dadosFornecedores disponível:', !!window.dadosFornecedores);
            console.log('🔍 Tipo de dados:', typeof window.dadosFornecedores);
            console.log('🔍 É array?', Array.isArray(window.dadosFornecedores));
            console.log('🔍 Dados completos:', window.dadosFornecedores);
            
            // Limpar opções antigas (manter apenas as padrões)
            while (select.children.length > 2) {
                select.removeChild(select.lastChild);
            }
            
            // Adicionar fornecedores do projeto
            if (window.dadosFornecedores && window.dadosFornecedores.length > 0) {
                console.log(`🏪 Populando ${window.dadosFornecedores.length} fornecedores no popup de problema`);
                console.log('🏪 Fornecedores disponíveis:', window.dadosFornecedores);
                
                // 🎯 CRIAR LISTA ÚNICA DE FORNECEDORES (sem duplicatas)
                const fornecedoresUnicos = new Set();
                
                window.dadosFornecedores.forEach((fornecedor, index) => {
                    console.log(`🔍 Fornecedor ${index}:`, fornecedor);
                    
                    // 🎯 CORRETO: usar FORNECEDOR em vez de NOME
                    const nomeFornecedor = fornecedor.FORNECEDOR || fornecedor.NOME || fornecedor.nome || fornecedor;
                    
                    // Adicionar apenas se não existir (evita duplicatas)
                    if (nomeFornecedor && !fornecedoresUnicos.has(nomeFornecedor)) {
                        fornecedoresUnicos.add(nomeFornecedor);
                        
                        const option = document.createElement('option');
                        option.value = nomeFornecedor;
                        option.textContent = nomeFornecedor;
                        
                        // Inserir antes da opção "Outro fornecedor"
                        select.insertBefore(option, select.lastElementChild);
                        console.log(`➕ Adicionado fornecedor único: ${option.textContent}`);
                    } else {
                        console.log(`⏭️ Fornecedor duplicado ignorado: ${nomeFornecedor}`);
                    }
                });
                
                console.log(`✅ ${fornecedoresUnicos.size} fornecedores únicos adicionados com sucesso!`);
            } else {
                console.log('⚠️ Nenhum fornecedor disponível para popular no popup');
                console.log('🔍 window.dadosFornecedores atual:', window.dadosFornecedores);
                
                // Tentar buscar dados do cache
                try {
                    const cacheData = localStorage.getItem('dadosAPI_cache');
                    if (cacheData) {
                        const cache = JSON.parse(cacheData);
                        console.log('📦 Dados do cache encontrados:', cache);
                        console.log('🏪 Fornecedores no cache:', cache.fornecedores);
                        
                        if (cache.fornecedores && cache.fornecedores.length > 0) {
                            console.log('🚀 Usando fornecedores do cache...');
                            window.dadosFornecedores = cache.fornecedores;
                            
                            // 🎯 CRIAR LISTA ÚNICA DE FORNECEDORES DO CACHE (sem duplicatas)
                            const fornecedoresUnicos = new Set();
                            
                            cache.fornecedores.forEach((fornecedor, index) => {
                                // 🎯 CORRETO: usar FORNECEDOR em vez de NOME
                                const nomeFornecedor = fornecedor.FORNECEDOR || fornecedor.NOME || fornecedor.nome || fornecedor;
                                
                                // Adicionar apenas se não existir (evita duplicatas)
                                if (nomeFornecedor && !fornecedoresUnicos.has(nomeFornecedor)) {
                                    fornecedoresUnicos.add(nomeFornecedor);
                                    
                                    const option = document.createElement('option');
                                    option.value = nomeFornecedor;
                                    option.textContent = nomeFornecedor;
                                    select.insertBefore(option, select.lastElementChild);
                                    console.log(`➕ Adicionado do cache (único): ${option.textContent}`);
                                }
                            });
                        }
                    } else {
                        console.log('❌ Nenhum cache encontrado');
                    }
                } catch (e) {
                    console.log('❌ Erro ao ler cache:', e);
                }
            }
        }

        // Função para lidar com mudança do select de fornecedor no popup
        function handleFornecedorProblemaChange() {
            const select = document.getElementById('fornecedorProblemaPopup');
            const customInput = document.getElementById('fornecedorProblemaPopupCustom');
            
            if (select.value === '__custom__') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }

        function enviarProblemaPopup() {
            var data = document.getElementById('dataProblemaPopup').value;
            var fornecedorSelect = document.getElementById('fornecedorProblemaPopup').value;
            var fornecedorCustom = document.getElementById('fornecedorProblemaPopupCustom').value;
            var observacao = document.getElementById('observacaoProblemaPopup').value;
            
            // Determinar qual fornecedor usar
            var fornecedor = '';
            if (fornecedorSelect === '__custom__') {
                fornecedor = fornecedorCustom;
            } else {
                fornecedor = fornecedorSelect;
            }
            
            if (!data || !fornecedor || !observacao) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }

            // Formatar data para exibição
            var dataFormatada = data.split('-').reverse().join('/');

            // Criar objeto do email
            var emailData = {
                id: Date.now(), // ID único
                data: data,
                dataFormatada: dataFormatada,
                fornecedor: fornecedor,
                observacao: observacao,
                responsavel: 'Eduardo',
                timestamp: new Date().toLocaleString('pt-BR'),
                tentativas: 0
            };

            // Verificar se está online
            if (isOnlineGlobal && emailJSConfig.publicKey !== "SUA_PUBLIC_KEY") {
                // Tentar enviar via EmailJS
                enviarViaEmailJS(emailData);
            } else if (!isOnlineGlobal) {
                // Adicionar à fila offline
                emailQueue.push(emailData);
                saveEmailQueue();
                
                fecharProblemaPopup();
                alert('📡 Sem conexão!\n\n📬 Relatório salvo na fila para envio automático quando a internet voltar.\n\nPendentes: ' + emailQueue.length);
            } else {
                // EmailJS não configurado ainda - usar mailto
                enviarViaMailto(emailData);
            }
        }

        function enviarViaEmailJS(emailData) {
            console.log('📧 Iniciando envio via EmailJS:', emailData);
            
            // Mostrar loading
            var btnEnviar = document.querySelector('#problemPopup .btn-danger');
            var textoOriginal = btnEnviar ? btnEnviar.textContent : '📧 ENVIAR RELATÓRIO';
            
            if (btnEnviar) {
                btnEnviar.textContent = '📤 Enviando...';
                btnEnviar.disabled = true;
            }
            
            // 1. Primeiro fazer upload das imagens para o blob
            uploadImagensParaBlob()
                .then(function(linksImagens) {
                    console.log('🖼️ Imagens enviadas para blob:', linksImagens);
                    
                    // 2. Preparar template data para o EmailJS
                    // 2. Preparar template data para o EmailJS - CORRIGIDO
var templateParams = {
    to_email: 'klug.elaine@larsil.com.br',           // ✅ Email da Elaine
    to_name: 'Elaine Klug',                          // ✅ Nome da destinatária
    from_name: 'Sistema de Refeições',               // ✅ Remetente
    reply_to: 'ferreira.eduardo@larsil.com.br',      // ✅ Email de resposta
    
    // Dados do problema
    data_problema: emailData.dataFormatada,
    fornecedor: emailData.fornecedor,
    responsavel: emailData.responsavel,
    descricao_problema: emailData.observacao,
    timestamp: emailData.timestamp,
    report_id: emailData.id,
    
    // URLs das fotos individuais (limpas)
    foto1_url: linksImagens.length > 0 ? linksImagens[0].replace('📸 Foto 1: ', '') : '',
    foto2_url: linksImagens.length > 1 ? linksImagens[1].replace('📸 Foto 2: ', '') : ''
};
                    
                    // 3. Enviar email via EmailJS
                    return emailjs.send(
                        emailJSConfig.serviceID,
                        emailJSConfig.templateID,
                        templateParams,
                        emailJSConfig.publicKey
                    );
                })
                .then(function(result) {
                    console.log('✅ Email enviado com sucesso:', result);
                    
                    // Resetar botão
                    if (btnEnviar) {
                        btnEnviar.textContent = textoOriginal;
                        btnEnviar.disabled = false;
                    }
                    
                    // Fechar popup
                    fecharProblemaPopup();
                    
                    // Mostrar sucesso
                    alert('✅ Relatório enviado com sucesso!\n\n📧 Email: ' + emailData.fornecedor + '\n📅 Data: ' + emailData.dataFormatada + '\n📸 Fotos: Anexadas automaticamente');
                    
                    // Limpar imagens capturadas
                    imagemFoto1Capturada = null;
                    imagemFoto2Capturada = null;
                    atualizarVisualizacaoFotos();
                })
                .catch(function(error) {
                    console.error('❌ Erro ao enviar email:', error);
                    
                    // Resetar botão
                    if (btnEnviar) {
                        btnEnviar.textContent = textoOriginal;
                        btnEnviar.disabled = false;
                    }
                    
                    // Adicionar à fila offline como fallback
                    emailQueue.push(emailData);
                    saveEmailQueue();
                    
                    // Mostrar erro mas garantir que foi salvo
                    alert('⚠️ Erro no envio, mas relatório foi salvo!\n\n📡 Tentativa automática quando a conexão melhorar.\n\nErro: ' + (error.text || error.message || 'Erro desconhecido'));
                    
                    fecharProblemaPopup();
                });
        }

        function enviarViaMailto(emailData) {
            // Email de destino
            var email = 'problemas.refeicoes@empresa.com';
            var assunto = 'PROBLEMA COM REFEIÇÃO - ' + emailData.fornecedor + ' - ' + emailData.dataFormatada;
            var corpo = 'RELATÓRIO DE PROBLEMA COM REFEIÇÃO\n\n';
            corpo += 'Data: ' + emailData.dataFormatada + '\n';
            corpo += 'Fornecedor: ' + emailData.fornecedor + '\n';
            corpo += 'Responsável: ' + emailData.responsavel + '\n\n';
            corpo += 'DESCRIÇÃO DO PROBLEMA:\n' + emailData.observacao + '\n\n';
            corpo += '⚠️ IMPORTANTE: Anexe as fotos tiradas do problema.\n\n';
            corpo += 'Relatório gerado pelo Sistema de Refeições.';

            // Abrir email
            var linkEmail = 'mailto:' + email + '?subject=' + encodeURIComponent(assunto) + '&body=' + encodeURIComponent(corpo);
            window.location.href = linkEmail;

            console.log('📧 Email preparado via mailto');
            
            fecharProblemaPopup();
            alert('✅ Email preparado para envio!\n\n📎 Não esqueça de anexar as fotos selecionadas no email.');
        }

        // ========== FUNÇÃO DE UPLOAD DE IMAGENS PARA BLOB ==========
        
        async function uploadImagensParaBlob() {
            console.log('☁️ Iniciando upload das imagens para Azure Blob...');
            
            var linksImagens = [];
            
            try {
                // Upload da Foto 1 (se existe)
                if (imagemFoto1Capturada) {
                    console.log('📸 Fazendo upload da Foto 1...');
                    var linkFoto1 = await uploadImagemParaBlob(imagemFoto1Capturada, 'foto1_problema');
                    if (linkFoto1) {
                        linksImagens.push('📸 Foto 1: ' + linkFoto1);
                        console.log('✅ Foto 1 enviada:', linkFoto1);
                    }
                }
                
                // Upload da Foto 2 (se existe)
                if (imagemFoto2Capturada) {
                    console.log('📸 Fazendo upload da Foto 2...');
                    var linkFoto2 = await uploadImagemParaBlob(imagemFoto2Capturada, 'foto2_problema');
                    if (linkFoto2) {
                        linksImagens.push('📸 Foto 2: ' + linkFoto2);
                        console.log('✅ Foto 2 enviada:', linkFoto2);
                    }
                }
                
                console.log(`☁️ Upload concluído! ${linksImagens.length} imagem(ns) enviada(s)`);
                return linksImagens;
                
            } catch (error) {
                console.error('❌ Erro no upload das imagens:', error);
                return []; // Retornar array vazio em caso de erro
            }
        }
        
        async function uploadImagemParaBlob(imagemBase64, nomeArquivo) {
            try {
                // Converter base64 para blob
                var response = await fetch(imagemBase64);
                var blob = await response.blob();
                
                // Preparar dados para upload
                var formData = new FormData();
                var timestamp = Date.now();
                var nomeCompleto = `problema_${nomeArquivo}_${timestamp}.jpg`;
                formData.append('file', blob, nomeCompleto);
                
                console.log('📤 Enviando para blob:', nomeCompleto, '(', Math.round(blob.size / 1024), 'KB)');
                
                // Fazer upload para o servidor Python
                var uploadResponse = await fetch(`${getServerBaseUrl()}/upload-blob`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`Erro HTTP: ${uploadResponse.status}`);
                }
                
                var result = await uploadResponse.json();
                
                if (result.error) {
                    throw new Error(result.message);
                }
                
                console.log('✅ Upload realizado:', result.url);
                return result.url;
                
            } catch (error) {
                console.error('❌ Erro no upload da imagem:', error);
                throw error;
            }
        }
        
        function atualizarVisualizacaoFotos() {
            // Resetar status das fotos
            document.getElementById('foto1Status').textContent = 'Clique para selecionar';
            document.getElementById('foto1Status').style.color = '#666';
            document.getElementById('foto2Status').textContent = 'Clique para selecionar';
            document.getElementById('foto2Status').style.color = '#666';
            
            // Limpar inputs
            document.getElementById('foto1Popup').value = '';
            document.getElementById('foto2Popup').value = '';
            
            console.log('🔄 Visualização das fotos atualizada');
        }

        // ========== FUNÇÕES DO POPUP A CONTRATAR ==========
        
        var naoContratadosCount = 0;
        window.naoContratadosCount = 0; // Tornar global

        function abrirPopupAContratar() {
            console.log('👷‍♀️ Abrindo popup A Contratar...');
            
            // Limpar campo
            document.getElementById('quantidadeNaoContratados').value = naoContratadosCount;
            
            // Mostrar popup
            document.getElementById('aContratarPopup').classList.remove('hidden');
            
            // Focar no campo
            setTimeout(() => {
                document.getElementById('quantidadeNaoContratados').focus();
            }, 100);
            
            console.log('✅ Popup A Contratar aberto!');
        }

        function fecharPopupAContratar() {
            document.getElementById('aContratarPopup').classList.add('hidden');
        }

        function confirmarNaoContratados() {
            var quantidade = parseInt(document.getElementById('quantidadeNaoContratados').value) || 0;
            
            if (quantidade < 0) {
                alert('❌ A quantidade não pode ser negativa!');
                return;
            }
            
            if (quantidade > 50) {
                alert('❌ Quantidade muito alta! Máximo 50 pessoas.');
                return;
            }
            
            // Salvar quantidade
            naoContratadosCount = quantidade;
            window.naoContratadosCount = quantidade; // Sincronizar global
            
            // Atualizar interface
            var infoDiv = document.getElementById('naoContratadosInfo');
            var textoSpan = document.getElementById('naoContratadosTexto');
            
            if (quantidade > 0) {
                infoDiv.style.display = 'block';
                textoSpan.textContent = quantidade + ' não contratado' + (quantidade > 1 ? 's' : '') + ' adicionado' + (quantidade > 1 ? 's' : '');
                textoSpan.style.color = '#28a745';
                textoSpan.style.fontWeight = '600';
            } else {
                infoDiv.style.display = 'none';
            }
            
            // Fechar popup
            fecharPopupAContratar();
            
            console.log('✅ Não contratados definidos:', quantidade);
            
            alert('✅ ' + quantidade + ' pessoa' + (quantidade > 1 ? 's' : '') + ' não contratada' + (quantidade > 1 ? 's' : '') + ' adicionada' + (quantidade > 1 ? 's' : '') + ' ao pedido!');
        }

        // ========== NOVAS FUNÇÕES SIMPLES DE PROBLEMA ==========
        
        function abrirTelaProblema() {
            console.log('Abrindo tela de problema...');
            
            // Ocultar todas as outras telas
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('orderScreen').classList.add('hidden');
            document.getElementById('temperatureScreen').classList.add('hidden');
            
            // Mostrar tela de problema removendo a classe hidden
            var problemScreen = document.getElementById('problemScreen');
            problemScreen.classList.remove('hidden');
            
            console.log('Classe hidden removida do problemScreen');
            
            // Definir data atual
            var hoje = new Date();
            var data = hoje.getFullYear() + '-' + 
                      String(hoje.getMonth() + 1).padStart(2, '0') + '-' + 
                      String(hoje.getDate()).padStart(2, '0');
            document.getElementById('dataProblema').value = data;
            
            console.log('Tela de problema aberta com sucesso!');
        }

        function voltarTelaInicial() {
            console.log('Voltando para tela inicial...');
            
            // Ocultar tela de problema adicionando a classe hidden
            document.getElementById('problemScreen').classList.add('hidden');
            
            // Mostrar tela principal
            doShowMain();
            limparFormulario();
            console.log('Voltou para tela inicial');
        }

        function mostrarFoto(numero) {
            var input = document.getElementById('foto' + numero);
            var area = document.getElementById('area' + numero);
            
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    area.innerHTML = '<img src="' + e.target.result + '" style="width: 100%; height: 80px; object-fit: cover; border-radius: 5px;">';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function enviarProblema() {
            var data = document.getElementById('dataProblema').value;
            var fornecedor = document.getElementById('fornecedorProblema').value;
            var observacao = document.getElementById('observacaoProblema').value;
            
            if (!data || !fornecedor || !observacao) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }

            // Formatar data para exibição
            var dataFormatada = data.split('-').reverse().join('/');

            // Email de destino
            var email = 'problemas.refeicoes@empresa.com';
            var assunto = 'PROBLEMA COM REFEIÇÃO - ' + fornecedor + ' - ' + dataFormatada;
            var corpo = 'RELATÓRIO DE PROBLEMA COM REFEIÇÃO\n\n';
            corpo += 'Data: ' + dataFormatada + '\n';
            corpo += 'Fornecedor: ' + fornecedor + '\n';
            corpo += 'Responsável: Eduardo\n\n';
            corpo += 'DESCRIÇÃO DO PROBLEMA:\n' + observacao + '\n\n';
            corpo += '⚠️ IMPORTANTE: Anexe as fotos tiradas do problema.\n\n';
            corpo += 'Relatório gerado pelo Sistema de Refeições.';

            // Abrir email
            var linkEmail = 'mailto:' + email + '?subject=' + encodeURIComponent(assunto) + '&body=' + encodeURIComponent(corpo);
            window.location.href = linkEmail;

            console.log('Email preparado para envio');
            
            // Mostrar popup de sucesso
            showProblemaSuccessPopup();
        }

        function limparFormulario() {
            document.getElementById('dataProblema').value = '';
            document.getElementById('fornecedorProblema').value = '';
            document.getElementById('observacaoProblema').value = '';
            document.getElementById('foto1').value = '';
            document.getElementById('foto2').value = '';
            
            // Restaurar áreas de foto
            document.getElementById('area1').innerHTML = '<div style="font-size: 30px; margin-bottom: 10px;">📷</div><div style="color: #666;">Foto 1</div>';
            document.getElementById('area2').innerHTML = '<div style="font-size: 30px; margin-bottom: 10px;">📷</div><div style="color: #666;">Foto 2</div>';
        }

        // Função para mostrar popup de sucesso do problema
        function showProblemaSuccessPopup() {
            var popup = document.getElementById('successPopup');
            
            // Customizar o popup para problema
            popup.querySelector('.popup-header h3').innerHTML = '✅ Relatório Enviado!';
            popup.querySelector('.popup-body p').innerHTML = 'O relatório de problema foi preparado para envio.';
            popup.querySelector('.popup-body p:last-child').innerHTML = '<span style="font-size: 12px; color: #6b7280;">Não esqueça de anexar as fotos no email.</span>';
            popup.querySelector('.popup-actions button').setAttribute('onclick', 'fecharProblemaPopup()');
            
            popup.classList.remove('hidden');
        }

        // Detectar iOS e suas limitações
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }
        
        function isIOSPWA() {
            return window.navigator.standalone === true;
        }
        
        // Sistema alternativo para iOS (sem Service Worker)
        function setupIOSOfflineSystem() {
            if (!isIOS()) return;
            
            console.log('🍎 iOS detectado - configurando sistema offline alternativo');
            
            // Verificar se é PWA instalado no iOS
            if (isIOSPWA()) {
                console.log('📱 iOS PWA detectado - modo standalone');
            }
            
            // Para iOS: usar polling em vez de Service Worker
            setInterval(() => {
                checkAndProcessIOSQueue();
            }, 30000); // Verificar a cada 30 segundos
            
            // Salvar estado quando app vai para background (iOS)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    console.log('🍎 iOS app indo para background - salvando estado');
                    saveIOSState();
                }
            });
            
            // Restaurar estado quando app volta (iOS)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    console.log('🍎 iOS app voltando - verificando fila');
                    setTimeout(checkAndProcessIOSQueue, 1000);
                }
            });
        }
        
        // Processar fila offline específica para iOS
        async function checkAndProcessIOSQueue() {
            if (!isIOS()) return;
            
            let databaseQueue = [];
            try {
                const saved = localStorage.getItem('databaseQueue');
                databaseQueue = saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.error('❌ Erro ao ler fila iOS:', e);
                return;
            }
            
            if (databaseQueue.length === 0) return;
            
            console.log(`🍎 iOS: Processando ${databaseQueue.length} itens da fila`);
            
            // Verificar conectividade
            if (!navigator.onLine) {
                console.log('🍎 iOS: Sem conexão - aguardando');
                return;
            }
            
            // Processar fila
            const processedItems = [];
            const baseUrl = getServerBaseUrl();
            
            for (let i = 0; i < databaseQueue.length; i++) {
                const item = databaseQueue[i];
                
                try {
                    const response = await fetch(`${baseUrl}/api/salvar-pedido`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(item)
                    });
                    
                    if (response.ok) {
                        console.log(`✅ iOS: Item ${i+1} processado com sucesso`);
                        processedItems.push(i);
                        
                        // Notificação visual para iOS
                        showIOSNotification(`✅ Pedido enviado: ${item.tipoRefeicao}`);
                    } else {
                        console.log(`❌ iOS: Erro no item ${i+1}:`, response.status);
                    }
                } catch (error) {
                    console.log(`❌ iOS: Erro de rede no item ${i+1}:`, error);
                    break; // Para na primeira falha de rede
                }
            }
            
            // Remover itens processados
            if (processedItems.length > 0) {
                const newQueue = databaseQueue.filter((_, index) => !processedItems.includes(index));
                localStorage.setItem('databaseQueue', JSON.stringify(newQueue));
                updateDatabaseQueueCounter();
                
                console.log(`🍎 iOS: ${processedItems.length} itens processados e removidos da fila`);
                showIOSNotification(`🎉 ${processedItems.length} pedidos enviados com sucesso!`);
            }
        }
        
        // Notificação visual para iOS (já que push notifications não funcionam)
        function showIOSNotification(message) {
            if (!isIOS()) return;
            
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: bold;
                max-width: 80%;
                text-align: center;
                animation: slideDown 0.3s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remover após 4 segundos
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease-in forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        // Salvar estado do iOS
        function saveIOSState() {
            if (!isIOS()) return;
            
            const state = {
                timestamp: Date.now(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                queueLength: JSON.parse(localStorage.getItem('databaseQueue') || '[]').length
            };
            
            localStorage.setItem('iosAppState', JSON.stringify(state));
            console.log('🍎 Estado do iOS salvo:', state);
        }
        
        let swRegistration = null;
        
        // Registrar Service Worker
        async function registerServiceWorker() {
            // Verificar se estamos em um protocolo suportado (não file://)
            if (window.location.protocol === 'file:') {
                console.log('⚠️ Service Worker não suportado em file://. Use um servidor HTTP.');
                return;
            }
            
            if ('serviceWorker' in navigator) {
                try {
                    swRegistration = await navigator.serviceWorker.register('./sw.js', {
                        scope: '/',
                        updateViaCache: 'none'
                    });
                    console.log('✅ Service Worker registrado:', swRegistration);
                    
                    // Verificar se há atualizações disponíveis (sem forçar)
                    swRegistration.addEventListener('updatefound', () => {
                        console.log('🔄 Nova versão do Service Worker encontrada');
                        const newWorker = swRegistration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('✨ Nova versão instalada (será ativada na próxima abertura)');
                                }
                            });
                        }
                    });
                    
                    // Solicitar permissão para notificações
                    if ('Notification' in window) {
                        if (Notification.permission === 'default') {
                            const permission = await Notification.requestPermission();
                            if (permission === 'granted') {
                                console.log('🔔 Permissão para notificações concedida');
                                showWelcomeNotification();
                            } else {
                                console.log('❌ Permissão para notificações negada');
                            }
                        } else if (Notification.permission === 'granted') {
                            console.log('🔔 Permissões já concedidas');
                        }
                    }
                    
                    // Escutar mensagens do Service Worker
                    navigator.serviceWorker.addEventListener('message', event => {
                        console.log('📨 Mensagem do SW:', event.data);
                        
                        if (event.data.type === 'CLEAR_DATABASE_QUEUE') {
                            localStorage.removeItem('databaseQueue');
                            localStorage.removeItem('filaTemperatura');
                            updateDatabaseQueueCounter();
                            console.log('🗑️ Filas limpas pelo Service Worker');
                        } else if (event.data.type === 'PROCESS_QUEUE') {
                            console.log('🔄 Service Worker solicitou processamento da fila');
                            // Processar fila quando Service Worker solicitar
                            processarFilaCompleta();
                        }
                    });
                    
                    // Verificar se há updates
                    swRegistration.addEventListener('updatefound', () => {
                        console.log('🔄 Atualizando Service Worker...');
                    });
                    
                    // Registrar Periodic Background Sync (se suportado)
                    if ('periodicSync' in swRegistration) {
                        try {
                            await swRegistration.periodicSync.register('database-queue-periodic', {
                                minInterval: 5 * 60 * 1000 // 5 minutos
                            });
                            console.log('⏰ Sync periódico registrado');
                        } catch (syncError) {
                            console.log('⚠️ Sync periódico não suportado:', syncError);
                        }
                    }
                    
                    // Manter Service Worker ativo
                    setInterval(() => {
                        if (navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage({
                                type: 'KEEP_ALIVE',
                                timestamp: Date.now()
                            });
                        }
                    }, 30000); // Ping a cada 30 segundos
                    
                } catch (error) {
                    console.error('❌ Erro ao registrar Service Worker:', error);
                }
            } else {
                console.log('⚠️ Service Worker não suportado');
            }
        }
        
        // Agendar Background Sync
        async function scheduleBackgroundSync() {
            if (swRegistration && 'sync' in window.ServiceWorkerRegistration.prototype) {
                try {
                    await swRegistration.sync.register('database-sync');
                    console.log('⏰ Background Sync agendado para fila do banco');
                } catch (error) {
                    console.error('❌ Erro ao agendar Background Sync:', error);
                }
            }
        }
        
        // Solicitar permissão para notificações (forçado para mobile)
        async function requestNotificationPermission() {
            // Detectar se é mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            console.log('📱 Dispositivo detectado:', { isMobile, isIOS, isAndroid });
            
            if ('Notification' in window) {
                let permission = Notification.permission;
                console.log('🔔 Permissão atual de notificações:', permission);
                
                if (permission === 'default') {
                    // Para iOS/Android, mostrar explicação antes de pedir permissão
                    if (isMobile) {
                        const userWantsNotifications = confirm(
                            '📱 IMPORTANTE para funcionalidade offline!\n\n' +
                            '🔔 Este app precisa de permissão para NOTIFICAÇÕES para:\n' +
                            '• Processar pedidos automaticamente quando offline\n' +
                            '• Avisar quando pedidos foram enviados ao servidor\n' +
                            '• Funcionar em segundo plano (mesmo fechado)\n\n' +
                            '⚠️ SEM esta permissão, pedidos offline NÃO serão processados automaticamente!\n\n' +
                            'Deseja permitir notificações agora?'
                        );
                        
                        if (!userWantsNotifications) {
                            alert('⚠️ ATENÇÃO: Sem notificações, o app NÃO funcionará offline automaticamente!');
                            return false;
                        }
                    }
                    
                    // Solicitar permissão
                    permission = await Notification.requestPermission();
                    console.log('🔔 Nova permissão de notificações:', permission);
                }
                
                if (permission === 'granted') {
                    console.log('✅ Notificações permitidas');
                    
                    // Notificação inicial para iOS PWA
                    if (isIOS) {
                        new Notification('🍎 iOS PWA Ativo!', {
                            body: 'Background sync habilitado para pedidos offline',
                            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9IiM0Zjc5ZTUiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtOSAxMiAyIDIgNC00Ii8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjkiLz4KPC9zdmc+Cjwvc3ZnPg==',
                            tag: 'pwa-ready'
                        });
                    }
                    
                    return true;
                } else {
                    console.warn('❌ Notificações negadas');
                    if (isMobile) {
                        alert('❌ ERRO: Sem notificações, o background sync não funcionará!\n\nPara habilitar:\n• iOS: Configurações > Safari > Notificações\n• Android: Configurações > Apps > Notificações');
                    }
                    return false;
                }
            } else {
                console.warn('⚠️ Notificações não suportadas');
                return false;
            }
        }
        
        // Solicitar permissão de localização 
        async function requestLocationPermission() {
            if (!navigator.geolocation) {
                console.warn('⚠️ Geolocalização não suportada');
                return false;
            }
            
            return new Promise((resolve) => {
                // Solicitar localização silenciosamente
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('✅ Localização obtida:', position.coords);
                        resolve(true);
                    },
                    (error) => {
                        console.warn('❌ Erro ao obter localização:', error.message);
                        if (isMobile && error.code === 1) {
                            alert('❌ Localização negada!\n\nPara habilitar:\n• iOS: Configurações > Privacidade > Localização\n• Android: Configurações > Apps > Permissões');
                        }
                        resolve(false);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            });
        }
        
        // Sincronizar dados da fila com o Service Worker
        function syncQueueWithServiceWorker() {
            if (navigator.serviceWorker.controller) {
                let databaseQueue = [];
                try {
                    const saved = localStorage.getItem('databaseQueue');
                    databaseQueue = saved ? JSON.parse(saved) : [];
                } catch (e) {
                    databaseQueue = [];
                }
                
                navigator.serviceWorker.controller.postMessage({
                    type: 'UPDATE_DATABASE_QUEUE',
                    queue: databaseQueue
                });
            }
        }

        // ========== SISTEMA DE LOGIN PERSISTENTE ==========
        
        async function verificarLoginSalvo() {
            console.log('🔍 Verificando login salvo...');
            
            try {
                let loginSalvo = null;
                let fonte = '';
                
                // 🎯 BUSCAR LOGIN EM MÚLTIPLAS FONTES (iOS PWA)
                
                // 1. Tentar localStorage primeiro
                const loginLocalStorage = localStorage.getItem('loginData');
                if (loginLocalStorage) {
                    loginSalvo = loginLocalStorage;
                    fonte = 'localStorage';
                }
                
                // 2. Se não encontrou, tentar sessionStorage
                if (!loginSalvo) {
                    const loginSessionStorage = sessionStorage.getItem('loginData_backup');
                    if (loginSessionStorage) {
                        loginSalvo = loginSessionStorage;
                        fonte = 'sessionStorage';
                    }
                }
                
                // 3. Se não encontrou, tentar cookies
                if (!loginSalvo) {
                    const cookies = document.cookie.split(';');
                    const loginCookie = cookies.find(cookie => cookie.trim().startsWith('loginData='));
                    if (loginCookie) {
                        try {
                            const cookieValue = loginCookie.split('=')[1];
                            loginSalvo = decodeURIComponent(cookieValue);
                            fonte = 'cookie';
                        } catch (cookieError) {
                            console.log('⚠️ Erro ao ler cookie de login:', cookieError);
                        }
                    }
                }
                
                // 4. Se não encontrou, tentar Service Worker (iOS PWA última tentativa)
                if (!loginSalvo && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    try {
                        const channel = new MessageChannel();
                        const swLoginPromise = new Promise((resolve) => {
                            channel.port1.onmessage = (e) => {
                                if (e.data.type === 'LOGIN_DATA' && e.data.data) {
                                    resolve(JSON.stringify(e.data.data));
                                } else {
                                    resolve(null);
                                }
                            };
                            setTimeout(() => resolve(null), 1000); // Timeout de 1 segundo
                        });
                        
                        navigator.serviceWorker.controller.postMessage({
                            type: 'GET_LOGIN'
                        }, [channel.port2]);
                        
                        const swLogin = await swLoginPromise;
                        if (swLogin) {
                            loginSalvo = swLogin;
                            fonte = 'serviceWorker';
                        }
                    } catch (swError) {
                        console.log('⚠️ Erro ao buscar login no Service Worker:', swError);
                    }
                }
                
                if (loginSalvo) {
                    const dados = JSON.parse(loginSalvo);
                    const agora = Date.now();
                    const tempoExpiracao = 30 * 24 * 60 * 60 * 1000; // 30 dias para iOS PWA
                    
                    // Verificar se login não expirou
                    if (agora - dados.timestamp < tempoExpiracao) {
                        console.log(`✅ Login válido encontrado em ${fonte}, carregando automaticamente...`);
                        console.log(`👤 Usuário: ${dados.projeto}-${dados.equipe}`);
                        console.log(`🕐 Login salvo há: ${Math.round((agora - dados.timestamp) / (1000 * 60 * 60))} horas`);
                        
                        // 🔐 MOSTRAR INDICADOR DE LOGIN SALVO
                        const indicador = document.getElementById('loginSalvoIndicador');
                        const info = document.getElementById('loginSalvoInfo');
                        if (indicador && info) {
                            indicador.style.display = 'block';
                            info.textContent = `Equipe: ${dados.equipe} (${fonte})`;
                        }
                        
                        // Restaurar em TODAS as fontes de persistência
                        salvarLogin(dados.projeto, dados.equipe);
                        
                        // Preencher campos
                        if (document.getElementById('projetoInput')) {
                            document.getElementById('projetoInput').value = dados.projeto;
                        }
                        if (document.getElementById('equipeInput')) {
                            document.getElementById('equipeInput').value = dados.equipe;
                        }
                        
                        // Fazer login automático
                        await fazerLoginAutomatico(dados.projeto, dados.equipe);
                        return true;
                    } else {
                        console.log('⏰ Login expirado, removendo de todas as fontes...');
                        // Limpar todas as fontes
                        localStorage.removeItem('loginData');
                        sessionStorage.removeItem('loginData_backup');
                        document.cookie = 'loginData=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                        document.cookie = 'equipe_logada=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    }
                }
                
                console.log('❌ Nenhum login salvo encontrado em nenhuma fonte');
                return false;
                
            } catch (error) {
                console.error('❌ Erro ao verificar login salvo:', error);
                return false;
            }
        }
        
        function salvarLogin(projeto, equipe) {
            const loginData = {
                projeto: projeto,
                equipe: equipe,
                timestamp: Date.now(),
                persistentLogin: true // Flag para indicar login persistente
            };
            
            // 🎯 MÚLTIPLAS ESTRATÉGIAS DE PERSISTÊNCIA PARA iOS
            try {
                // 1. localStorage (padrão)
                localStorage.setItem('loginData', JSON.stringify(loginData));
                localStorage.setItem('equipe_logada', equipe);
                
                // 2. sessionStorage (backup)
                sessionStorage.setItem('loginData_backup', JSON.stringify(loginData));
                sessionStorage.setItem('equipe_logada_backup', equipe);
                
                // 3. Cookie persistente (para iOS PWA)
                const expirationDate = new Date();
                expirationDate.setTime(expirationDate.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 dias
                document.cookie = `loginData=${encodeURIComponent(JSON.stringify(loginData))}; expires=${expirationDate.toUTCString()}; path=/; SameSite=Strict`;
                document.cookie = `equipe_logada=${encodeURIComponent(equipe)}; expires=${expirationDate.toUTCString()}; path=/; SameSite=Strict`;
                
                // 4. Cache do Service Worker (através de postMessage)
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'SAVE_LOGIN',
                        data: loginData
                    });
                }
                
                console.log('💾 Login salvo com múltiplas estratégias (localStorage + sessionStorage + cookie + SW)');
                console.log('👥 Equipe salva para filtros:', equipe);
                console.log('🔒 Login persistente ativado para iOS PWA');
                
            } catch (error) {
                console.error('❌ Erro ao salvar login:', error);
                // Pelo menos tentar salvar no localStorage
                try {
                    localStorage.setItem('loginData', JSON.stringify(loginData));
                    localStorage.setItem('equipe_logada', equipe);
                } catch (fallbackError) {
                    console.error('❌ Erro crítico: não foi possível salvar login', fallbackError);
                }
            }
        }
        
        function fazerLogout() {
            console.log('🚪 Fazendo logout...');
            
            // 🎯 REMOVER LOGIN DE TODAS AS FONTES DE PERSISTÊNCIA
            try {
                // 1. localStorage
                localStorage.removeItem('loginData');
                localStorage.removeItem('equipe_logada');
                
                // 2. sessionStorage
                sessionStorage.removeItem('loginData_backup');
                sessionStorage.removeItem('equipe_logada_backup');
                
                // 3. Cookies
                document.cookie = 'loginData=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                document.cookie = 'equipe_logada=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                
                // 4. Service Worker
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'CLEAR_LOGIN'
                    });
                }
                
                console.log('🧹 Login removido de todas as fontes de persistência');
                
            } catch (error) {
                console.error('⚠️ Erro ao limpar dados de login:', error);
            }
            
            // Limpar dados da sessão (manter cache para próximo login)
            window.dadosFornecedores = [];
            window.dadosOrganograma = [];
            window.dadosColaboradores = [];
            window.dadosPagcorp = [];
            
            // Voltar para tela de login
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('orderScreen').classList.add('hidden');
            document.getElementById('temperatureScreen').classList.add('hidden');
            document.getElementById('problemScreen').classList.add('hidden');
            
            // Limpar campos
            document.getElementById('projetoInput').value = '';
            document.getElementById('equipeInput').value = '';
            
            alert('✅ Logout realizado com sucesso!');
            console.log('✅ Logout concluído');
        }
        
        async function fazerLoginAutomatico(projeto, equipe) {
            console.log('🔄 Fazendo login automático...');
            console.log(`👤 Projeto: ${projeto}, Equipe: ${equipe}`);
            
            try {
                // Mostrar tela principal
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                
                // Atualizar nome do usuário
                atualizarNomeUsuario(equipe);
                
                // Verificar se tem dados em cache primeiro (para modo offline)
                const dadosCache = localStorage.getItem('dadosApiCache');
                const isOnline = navigator.onLine;
                
                console.log(`📶 Status da rede: ${isOnline ? 'Online' : 'Offline'}`);
                
                if (!isOnline && dadosCache) {
                    console.log('📦 Usando dados em cache (modo offline)');
                    const cache = JSON.parse(dadosCache);
                    
                    // Usar dados do cache para interface
                    if (cache.fornecedores) {
                        carregarFornecedoresNaInterface(cache.fornecedores);
                    }
                    if (cache.colaboradores) {
                        carregarColaboradoresNaInterface(cache.colaboradores);
                    }
                    
                    // Carregar pendências do cache se disponível
                    const pendenciasCache = localStorage.getItem('temperaturePendenciasCache');
                    if (pendenciasCache) {
                        const pendencias = JSON.parse(pendenciasCache);
                        carregarPendenciasNaInterface(pendencias);
                        console.log('✅ Login automático concluído (modo offline)');
                    } else {
                        console.log('⚠️ Sem pendências em cache - aguardando conexão');
                    }
                    
                    // Carregar pendências de temperatura
                    await loadPendingTemperatures();
                    updateSyncStatus();
                    return true;
                }
                
                // Se online, buscar dados do servidor (comportamento normal)
                const sucesso = await buscarDadosPorProjetoEquipe(projeto, equipe);
                
                if (sucesso) {
                    // Carregar pendências de temperatura
                    await loadPendingTemperatures();
                    updateSyncStatus();
                    console.log('✅ Login automático concluído (online)');
                    return true;
                } else {
                    console.log('❌ Falha no login automático, mas mantendo acesso (modo gracioso)');
                    // Em vez de voltar para login, manter logado mas mostrar mensagem
                    await loadPendingTemperatures();
                    updateSyncStatus();
                    return true; // Manter logado mesmo com falha na API
                }
            } catch (error) {
                console.error('❌ Erro durante login automático:', error);
                console.log('⚠️ Mantendo usuário logado apesar do erro');
                // Carregar pelo menos as pendências locais
                await loadPendingTemperatures();
                updateSyncStatus();
                return true; // Manter logado mesmo com erro
            }
        }

        // Inicialização do sistema offline e login por equipe
        window.addEventListener('load', async function() {
            console.log('🌐 Window load completado');
            
            // CONFIGURAÇÃO ESPECÍFICA PARA iOS
            setupIOSOfflineSystem();
            
            // REGISTRO DO SERVICE WORKER PARA BACKGROUND SYNC (outros devices)
            registerServiceWorker();
            
            // Eventos para garantir background sync quando app fecha/minimiza
            window.addEventListener('beforeunload', function(event) {
                console.log('⚠️ App sendo fechado - ativando background sync');
                scheduleBackgroundSync();
                
                // 💾 FORÇAR PERSISTÊNCIA DO LOGIN ANTES DE FECHAR
                const equipeLogada = localStorage.getItem('equipe_logada');
                const loginData = localStorage.getItem('loginData');
                
                if (equipeLogada && loginData) {
                    console.log('💾 Garantindo persistência do login antes de fechar...');
                    try {
                        const dados = JSON.parse(loginData);
                        // Resalvar com timestamp atualizado
                        salvarLogin(dados.projeto, dados.equipe);
                        console.log('✅ Login persistido com sucesso');
                    } catch (error) {
                        console.error('❌ Erro ao persistir login:', error);
                    }
                }
                
                // Para PWAs, forçar sync imediato
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'FORCE_BACKGROUND_SYNC'
                    });
                }
            });
            
            // Evento para quando a página perde o foco (minimizada/fechada)
            window.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    console.log('👁️ App minimizado - ativando background sync');
                    scheduleBackgroundSync();
                    
                    // 💾 PERSISTIR LOGIN QUANDO APP VAI PARA BACKGROUND
                    const equipeLogada = localStorage.getItem('equipe_logada');
                    const loginData = localStorage.getItem('loginData');
                    
                    if (equipeLogada && loginData) {
                        console.log('💾 Persistindo login (app em background)...');
                        try {
                            const dados = JSON.parse(loginData);
                            salvarLogin(dados.projeto, dados.equipe);
                        } catch (error) {
                            console.error('❌ Erro ao persistir login (background):', error);
                        }
                    }
                }
            });
            
            // Evento para quando a página perde o foco (iOS/Safari)
            window.addEventListener('pagehide', function(event) {
                console.log('📱 App saindo de foco - ativando background sync');
                scheduleBackgroundSync();
                
                // 💾 PERSISTIR LOGIN PARA iOS/SAFARI PWA
                const equipeLogada = localStorage.getItem('equipe_logada');
                const loginData = localStorage.getItem('loginData');
                
                if (equipeLogada && loginData) {
                    console.log('💾 Persistindo login (iOS/Safari)...');
                    try {
                        const dados = JSON.parse(loginData);
                        salvarLogin(dados.projeto, dados.equipe);
                    } catch (error) {
                        console.error('❌ Erro ao persistir login (iOS):', error);
                    }
                }
            });
            
            // INICIALIZAÇÃO DO SISTEMA OFFLINE
            console.log('🚀 Inicializando sistema offline...');
            
            // Verificar se há dados em cache para modo offline
            const cacheOfflineData = localStorage.getItem('dadosApiCache');
            const loginSalvo = localStorage.getItem('loginData');
            
            if (cacheOfflineData && loginSalvo) {
                console.log('💾 Dados offline encontrados - sistema pode funcionar offline');
                // Sistema já tem dados cached, pode funcionar offline
            } else {
                console.log('⚠️ Sistema precisa de conexão inicial para cache de dados');
            }
            
            loadEmailQueue();
            updateDatabaseQueueCounter(); // Carregar contador do banco de dados
            
            // INICIALIZAÇÃO DA CAPTURA DE IMAGENS já feita no setupFilePreview()
            // initImageCapture(); // REMOVIDO - função duplicada
            
            window.addEventListener('online', function() {
                console.log('🌐 Conexão restaurada!');
                isOnlineGlobal = true;
                processEmailQueue();
                processDatabaseQueue(); // Processar fila do banco de dados também
                processTemperaturaQueue(); // Processar fila de temperatura também
                scheduleBackgroundSync(); // Agendar background sync
                
                // Se um pedido foi enviado offline, voltar para a tela principal
                if (pedidoEnviadoOffline) {
                    console.log('🏠 Retornando para tela principal após sincronização de pedido offline');
                    pedidoEnviadoOffline = false; // Resetar flag
                    
                    // Exibir confirmação para o usuário
                    setTimeout(function() {
                        // Aguardar processamento das filas
                        alert('✅ Conexão restaurada! Seus pedidos offline foram sincronizados com sucesso.');
                        doShowHome(); // Voltar para a tela principal
                    }, 1000);
                }
            });
            window.addEventListener('offline', function() {
                console.log('📡 Conexão perdida!');
                isOnlineGlobal = false;
            });
            isOnlineGlobal = navigator.onLine;
            console.log('📶 Status da rede:', isOnlineGlobal ? 'Online' : 'Offline');
        });

        // Função de login por equipe
        // Função para limpar cache completo (PWA)
        function limparCacheCompleto() {
            const opcoes = [
                '🧹 Limpar cache mas manter login salvo',
                '🚨 Limpar TUDO (incluindo login - precisará logar novamente)',
                '❌ Cancelar'
            ];
            
            const escolha = prompt(`Escolha uma opção:\n\n1 - ${opcoes[0]}\n2 - ${opcoes[1]}\n3 - ${opcoes[2]}\n\nDigite 1, 2 ou 3:`);
            
            if (escolha === '3' || escolha === null || escolha === '') {
                console.log('🚫 Limpeza cancelada pelo usuário');
                return;
            }
            
            const manterLogin = escolha === '1';
            
            try {
                console.log(`🧹 Iniciando limpeza ${manterLogin ? 'com preservação de login' : 'completa'} do cache...`);
                
                // 💾 SALVAR LOGIN ANTES DE LIMPAR (se escolheu manter)
                let loginBackup = null;
                let equipeBackup = null;
                
                if (manterLogin) {
                    console.log('💾 Fazendo backup do login...');
                    loginBackup = localStorage.getItem('loginData');
                    equipeBackup = localStorage.getItem('equipe_logada');
                }
                
                // Limpar localStorage
                console.log('🗑️ Limpando localStorage...');
                localStorage.clear();
                
                // Limpar sessionStorage
                console.log('🗑️ Limpando sessionStorage...');
                sessionStorage.clear();
                
                // 🔄 RESTAURAR LOGIN (se escolheu manter)
                if (manterLogin && loginBackup && equipeBackup) {
                    console.log('🔄 Restaurando login salvo...');
                    localStorage.setItem('loginData', loginBackup);
                    localStorage.setItem('equipe_logada', equipeBackup);
                    
                    // Resalvar com múltiplas estratégias
                    try {
                        const dados = JSON.parse(loginBackup);
                        salvarLogin(dados.projeto, dados.equipe);
                        console.log('✅ Login restaurado com sucesso');
                    } catch (error) {
                        console.error('⚠️ Erro ao restaurar login:', error);
                        localStorage.setItem('loginData', loginBackup);
                        localStorage.setItem('equipe_logada', equipeBackup);
                    }
                }
                
                // Limpar dados globais
                console.log('🗑️ Limpando variáveis globais...');
                window.dadosFornecedores = [];
                window.dadosOrganograma = [];
                window.dadosColaboradores = [];
                window.dadosPagcorp = [];
                
                // Limpar Service Worker cache
                if ('serviceWorker' in navigator && 'caches' in window) {
                    console.log('🗑️ Limpando cache do Service Worker...');
                    caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.map(cacheName => caches.delete(cacheName))
                        );
                    }).then(() => {
                        console.log('✅ Cache do Service Worker limpo');
                    });
                }
                
                console.log('✅ Limpeza concluída!');
                
                if (manterLogin) {
                    alert('✅ Cache limpo com sucesso!\n\n🔐 Seu login foi preservado.\nA página será recarregada.');
                } else {
                    alert('✅ Cache e login limpos com sucesso!\n\nVocê precisará fazer login novamente.\nA página será recarregada.');
                }
                
                // Recarregar página
                window.location.reload(true);
                
            } catch (error) {
                console.error('❌ Erro ao limpar cache:', error);
                alert('❌ Erro ao limpar cache. Tente recarregar a página manualmente.');
            }
        }

        // 🧹 FUNÇÃO PARA LIMPAR COMPLETAMENTE DADOS ANTERIORES
        function limparDadosAnteriores() {
            console.log('🧹 Limpando todos os dados anteriores...');
            
            // Limpar variáveis globais
            window.dadosFornecedores = [];
            window.dadosOrganograma = [];
            window.dadosColaboradores = [];
            window.dadosPagcorp = [];
            
            // Limpar campos de formulário
            const campos = [
                'requestorNameInput',
                'supplierSelect', 
                'mealTypeSelect',
                'pagcorpInput',
                'contractedCountInput',
                'nonContractedCountInput',
                'otherParticipantsInput'
            ];
            
            campos.forEach(campoId => {
                const campo = document.getElementById(campoId);
                if (campo) {
                    if (campo.tagName === 'SELECT') {
                        campo.selectedIndex = 0; // Reset select para primeira opção
                    } else {
                        campo.value = ''; // Limpar input
                    }
                }
            });
            
            // Limpar listas dinâmicas
            const colaboradoresList = document.getElementById('colaboradoresList');
            if (colaboradoresList) {
                colaboradoresList.innerHTML = '';
            }
            
            // Limpar cache localStorage se necessário
            try {
                localStorage.removeItem('dadosAPI_cache');
                console.log('🗑️ Cache localStorage removido');
            } catch (e) {
                console.log('⚠️ Erro ao limpar cache:', e);
            }
            
            console.log('✅ Limpeza completa finalizada');
        }

        // Função para atualizar o nome do usuário logado
        function atualizarNomeUsuario(equipe) {
            try {
                let nomeUsuario = 'Equipe ' + equipe;
                
                // Tentar buscar o nome do líder nos dados do organograma
                if (window.dadosOrganograma && window.dadosOrganograma.length > 0) {
                    const liderNome = window.dadosOrganograma[0].LIDER || '';
                    if (liderNome.trim()) {
                        nomeUsuario = `👤 ${liderNome} (${equipe})`;
                    }
                }
                
                // Atualizar o elemento na tela
                const nomeElement = document.getElementById('nomeUsuario');
                if (nomeElement) {
                    nomeElement.textContent = nomeUsuario;
                    console.log('👤 Nome do usuário atualizado:', nomeUsuario);
                } else {
                    console.log('⚠️ Elemento nomeUsuario não encontrado');
                }
                
                // Salvar no localStorage para persistir
                localStorage.setItem('nomeUsuarioAtual', nomeUsuario);
                
            } catch (error) {
                console.error('Erro ao atualizar nome do usuário:', error);
            }
        }

        // Função para preencher automaticamente os campos com dados do líder
        function preencherCamposAutomaticamente() {
            let liderNome = '';
            const equipeLogada = localStorage.getItem('equipe_logada') || '';
            
            console.log(`🎯 Preenchimento automático para equipe: "${equipeLogada}"`);
            console.log(`🎯 DEBUG - window.dadosOrganograma atual:`, window.dadosOrganograma);
            
            // 🎯 PRIORIDADE 1: Buscar líder no organograma específico da equipe digitada
            if (window.dadosOrganograma && window.dadosOrganograma.length > 0) {
                console.log(`🔍 Procurando equipe "${equipeLogada}" no organograma...`);
                
                // Buscar organograma exato da equipe logada
                const organogramaEquipe = window.dadosOrganograma.find(org => {
                    console.log(`🔍 Comparando: "${org.EQUIPE}" === "${equipeLogada}"`);
                    return org.EQUIPE === equipeLogada;
                });
                
                console.log(`🔍 Resultado da busca:`, organogramaEquipe);
                
                if (organogramaEquipe && organogramaEquipe.LIDER) {
                    liderNome = organogramaEquipe.LIDER;
                    console.log(`✅ Líder encontrado no organograma da equipe "${equipeLogada}": "${liderNome}"`);
                } else {
                    console.log(`⚠️ Equipe "${equipeLogada}" não encontrada no organograma ou sem líder definido`);
                    console.log(`⚠️ Dados disponíveis no organograma:`, window.dadosOrganograma);
                }
            } else {
                console.log(`⚠️ Nenhum dado de organograma disponível`);
            }
            
            // 🎯 FALLBACK: Buscar líder na lista de colaboradores da equipe específica
            if (!liderNome && window.dadosColaboradores && window.dadosColaboradores.length > 0) {
                const liderColaborador = window.dadosColaboradores.find(colab => 
                    colab.IS_LIDER === true || colab.CLASSE === 'LDF'
                );
                
                if (liderColaborador && liderColaborador.NOME) {
                    liderNome = liderColaborador.NOME;
                    console.log(`🔄 Fallback: Líder encontrado nos colaboradores da equipe: "${liderNome}"`);
                } else {
                    console.log(`⚠️ Nenhum líder encontrado nos colaboradores da equipe`);
                }
            }
            
            if (liderNome) {
                console.log(`✅ Preenchimento automático: líder encontrado: "${liderNome}"`);
                
                // Preencher Nome do Solicitante com o nome do líder (sempre preenche se vazio)
                const requestorInput = document.getElementById('requestorNameInput');
                if (requestorInput) {
                    if (!requestorInput.value.trim()) {
                        requestorInput.value = liderNome;
                        console.log(`✅ Nome do Solicitante preenchido com: "${liderNome}"`);
                    } else {
                        console.log(`ℹ️ Nome do Solicitante já preenchido: "${requestorInput.value}"`);
                    }
                }
                
                // Preencher Responsável pelo Cartão com o nome do líder (sempre preenche se vazio)
                const cardResponsibleInput = document.getElementById('cardResponsibleInput');
                if (cardResponsibleInput) {
                    if (!cardResponsibleInput.value.trim()) {
                        cardResponsibleInput.value = liderNome;
                        console.log(`✅ Responsável pelo Cartão preenchido com: "${liderNome}"`);
                        
                        // Buscar PAGCORP automaticamente quando preencher o responsável
                        setTimeout(() => {
                            buscarPagcorpPorResponsavel(liderNome);
                        }, 500);
                    } else {
                        console.log(`ℹ️ Responsável pelo Cartão já preenchido: "${cardResponsibleInput.value}"`);
                    }
                }
            } else {
                console.log(`⚠️ Nenhum líder encontrado para preenchimento automático`);
            }
                
            // Preencher PAGCORP se disponível e campo estiver vazio
            if (window.dadosPagcorp && window.dadosPagcorp.length > 0) {
                const pagcorpInput = document.getElementById('pagcorpInput');
                if (pagcorpInput && !pagcorpInput.value.trim()) {
                    // Buscar o valor na coluna CONTA
                    const pagcorpValue = window.dadosPagcorp[0].CONTA || window.dadosPagcorp[0].PAGCORP || window.dadosPagcorp[0].CODIGO || '';
                    if (pagcorpValue && pagcorpValue.toString().trim()) {
                        pagcorpInput.value = pagcorpValue;
                        console.log(`✅ PAGCORP preenchido automaticamente: ${pagcorpValue}`);
                    } else {
                        console.log('ℹ️ CONTA encontrada mas está vazia');
                    }
                } else if (pagcorpInput && pagcorpInput.value.trim()) {
                    console.log(`ℹ️ PAGCORP já preenchido: "${pagcorpInput.value}"`);
                }
            } else {
                console.log('ℹ️ Nenhum PAGCORP encontrado para preenchimento automático');
            }
        }

        // Função para buscar PAGCORP automaticamente quando o responsável pelo cartão é alterado
        async function buscarPagcorpPorResponsavel(nomeResponsavel) {
            // Limpar espaços e verificar se há nome
            nomeResponsavel = nomeResponsavel.trim();
            if (!nomeResponsavel) {
                console.log('ℹ️ Nome do responsável vazio, não buscando PAGCORP');
                return;
            }
            
            console.log(`🔍 Buscando PAGCORP para responsável: "${nomeResponsavel}"`);
            
            // Feedback visual de carregamento
            const pagcorpInput = document.getElementById('pagcorpInput');
            if (pagcorpInput) {
                pagcorpInput.placeholder = '🔍 Buscando PAGCORP...';
                pagcorpInput.style.backgroundColor = '#f3f4f6'; // Cinza claro
            }
            
            try {
                // Buscar PAGCORP na API usando o nome do responsável
                const response = await fetch(`${getServerBaseUrl()}/api/pagcorp?lider=${encodeURIComponent(nomeResponsavel)}`);
                
                if (!response.ok) {
                    console.log(`⚠️ Erro na busca PAGCORP: ${response.status}`);
                    if (pagcorpInput) {
                        pagcorpInput.placeholder = 'Digite o código/identificação PAGCORP';
                        pagcorpInput.style.backgroundColor = '';
                    }
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    console.log(`⚠️ Erro retornado pela API: ${data.message}`);
                    if (pagcorpInput) {
                        pagcorpInput.placeholder = 'Digite o código/identificação PAGCORP';
                        pagcorpInput.style.backgroundColor = '';
                    }
                    return;
                }
                
                const pagcorpData = data.pagcorp || [];
                console.log(`📊 PAGCORP encontrados: ${pagcorpData.length}`);
                
                // Preencher campo PAGCORP se encontrado
                if (pagcorpInput) {
                    if (pagcorpData.length > 0) {
                        // Buscar o valor na coluna CONTA
                        const pagcorpValue = pagcorpData[0].CONTA || pagcorpData[0].PAGCORP || pagcorpData[0].CODIGO || '';
                        console.log(`📋 Dados do PAGCORP:`, pagcorpData[0]);
                        console.log(`💰 Valor encontrado na coluna CONTA: "${pagcorpValue}"`);
                        
                        if (pagcorpValue && pagcorpValue.toString().trim()) {
                            pagcorpInput.value = pagcorpValue;
                            pagcorpInput.placeholder = 'Digite o código/identificação PAGCORP';
                            console.log(`✅ PAGCORP preenchido automaticamente: "${pagcorpValue}"`);
                            
                            // Feedback visual de sucesso
                            pagcorpInput.style.backgroundColor = '#d1fae5'; // Verde claro
                            setTimeout(() => {
                                pagcorpInput.style.backgroundColor = '';
                            }, 2000);
                        } else {
                            console.log('ℹ️ CONTA encontrada mas está vazia');
                            pagcorpInput.value = '';
                            pagcorpInput.placeholder = 'CONTA vazia para este responsável';
                            pagcorpInput.style.backgroundColor = '#fef3cd'; // Amarelo claro
                            setTimeout(() => {
                                pagcorpInput.placeholder = 'Digite o código/identificação PAGCORP';
                                pagcorpInput.style.backgroundColor = '';
                            }, 3000);
                        }
                    } else {
                        console.log(`ℹ️ Nenhum PAGCORP encontrado para "${nomeResponsavel}"`);
                        pagcorpInput.placeholder = 'PAGCORP não encontrado para este responsável';
                        pagcorpInput.style.backgroundColor = '#fef3cd'; // Amarelo claro
                        setTimeout(() => {
                            pagcorpInput.placeholder = 'Digite o código/identificação PAGCORP';
                            pagcorpInput.style.backgroundColor = '';
                        }, 3000);
                    }
                }
                
            } catch (error) {
                console.error('❌ Erro ao buscar PAGCORP:', error);
                if (pagcorpInput) {
                    pagcorpInput.placeholder = 'Erro ao buscar PAGCORP';
                    pagcorpInput.style.backgroundColor = '#fee2e2'; // Vermelho claro
                    setTimeout(() => {
                        pagcorpInput.placeholder = 'Digite o código/identificação PAGCORP';
                        pagcorpInput.style.backgroundColor = '';
                    }, 3000);
                }
            }
        }

        // Função para buscar líder específico da equipe quando abre Novo Pedido
        async function buscarLiderDaEquipe() {
            try {
                const equipeLogada = localStorage.getItem('equipe_logada') || '';
                if (!equipeLogada) {
                    console.log('❌ Nenhuma equipe logada encontrada');
                    return;
                }
                
                // 🚀 USAR DADOS JÁ CACHEADOS DO LOGIN
                if (window.dadosOrganograma && window.dadosOrganograma.length > 0) {
                    console.log('⚡ Usando dados do organograma já cacheados do login');
                    console.log(`🎯 Total de registros do organograma: ${window.dadosOrganograma.length}`);
                    
                    window.dadosOrganograma.forEach((org, index) => {
                        console.log(`🎯 Registro ${index}: EQUIPE=${org.EQUIPE}, LIDER=${org.LIDER}`);
                    });
                    
                    // PAGCORP também já está cacheado
                    if (window.dadosPagcorp && window.dadosPagcorp.length > 0) {
                        console.log(`⚡ PAGCORP também já cacheado: ${window.dadosPagcorp.length} registros`);
                    } else {
                        console.log('ℹ️ Nenhum PAGCORP cacheado encontrado');
                    }
                    
                    return; // ✅ Dados já disponíveis, não precisa buscar
                }
                
                // ⚠️ FALLBACK: Se por algum motivo não tem cache, buscar novamente
                console.log('⚠️ Dados não encontrados no cache, buscando do servidor...');
                
                // Extrair projeto da equipe (ex: 700AF -> 700)
                const projeto = equipeLogada.replace(/[^0-9]/g, '');
                
                console.log(`🎯 Buscando líder específico para projeto=${projeto}, equipe=${equipeLogada}`);
                
                // Buscar organograma específico da equipe
                const organogramaUrl = `${getServerBaseUrl()}/api/organograma?projeto=${projeto}&equipe=${equipeLogada}`;
                console.log(`🌐 URL do organograma específico: ${organogramaUrl}`);
                
                const response = await fetch(organogramaUrl);
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status}`);
                }
                
                const organogramaData = await response.json();
                if (organogramaData.error) {
                    throw new Error(organogramaData.message || 'Erro na API do organograma');
                }
                
                // Atualizar dados do organograma globalmente
                window.dadosOrganograma = organogramaData.organograma || [];
                
                console.log(`🎯 DEBUG ORGANOGRAMA ESPECÍFICO - Dados para equipe ${equipeLogada}:`, organogramaData);
                console.log(`🎯 Total de registros do organograma: ${window.dadosOrganograma.length}`);
                
                window.dadosOrganograma.forEach((org, index) => {
                    console.log(`🎯 Registro ${index}: EQUIPE=${org.EQUIPE}, LIDER=${org.LIDER}`);
                });
                
                // Buscar PAGCORP do líder encontrado
                if (window.dadosOrganograma.length > 0 && window.dadosOrganograma[0].LIDER) {
                    const lider = window.dadosOrganograma[0].LIDER;
                    console.log(`🔍 Buscando PAGCORP para líder: ${lider}`);
                    
                    try {
                        const pagcorpResponse = await fetch(`${getServerBaseUrl()}/api/pagcorp?lider=${encodeURIComponent(lider)}`);
                        if (pagcorpResponse.ok) {
                            const pagcorpData = await pagcorpResponse.json();
                            if (!pagcorpData.error) {
                                window.dadosPagcorp = pagcorpData.pagcorp || [];
                                console.log(`✅ PAGCORP encontrado: ${window.dadosPagcorp.length} registros`);
                            } else {
                                window.dadosPagcorp = [];
                                console.log('❌ Erro ao buscar PAGCORP:', pagcorpData.message);
                            }
                        } else {
                            window.dadosPagcorp = [];
                            console.log('❌ Erro na API do PAGCORP');
                        }
                    } catch (e) {
                        window.dadosPagcorp = [];
                        console.warn('❌ Erro ao buscar PAGCORP:', e);
                    }
                } else {
                    window.dadosPagcorp = [];
                    console.log('❌ Nenhum líder encontrado no organograma para buscar PAGCORP');
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Erro ao buscar líder da equipe:', error);
                return false;
            }
        }

        // Função para buscar dados reais das APIs do Azure SQL
        async function buscarDadosPorProjetoEquipe(projeto, equipe) {
            try {
                console.log(`🔍 Buscando dados para projeto: ${projeto}, equipe: ${equipe}`);
                
                // 🎯 CARREGAR TUDO NO LOGIN: fornecedores, colaboradores, organograma E PAGCORP
                console.log(`🌐 Buscando fornecedores, colaboradores, organograma e PAGCORP no login`);
                
                const [fornecedoresResponse, colaboradoresResponse, organogramaResponse] = await Promise.all([
                    fetch(`${getServerBaseUrl()}/api/fornecedores?projeto=${projeto}`),
                    fetch(`${getServerBaseUrl()}/api/colaboradores?equipe=${equipe}`),
                    fetch(`${getServerBaseUrl()}/api/organograma?projeto=${projeto}&equipe=${equipe}`)
                ]);
                
                // Verificar se as chamadas foram bem-sucedidas
                if (!fornecedoresResponse.ok || !colaboradoresResponse.ok || !organogramaResponse.ok) {
                    throw new Error('Erro em uma ou mais chamadas da API');
                }
                
                // Converter respostas para JSON
                const fornecedoresData = await fornecedoresResponse.json();
                const colaboradoresData = await colaboradoresResponse.json();
                const organogramaData = await organogramaResponse.json();
                
                // Verificar se há erros nas respostas
                if (fornecedoresData.error || colaboradoresData.error || organogramaData.error) {
                    throw new Error('Erro nos dados retornados pelas APIs');
                }
                
                // 🎯 USAR CACHEMANAGER INTELIGENTE
                const fornecedores = fornecedoresData.fornecedores || [];
                const colaboradores = colaboradoresData.colaboradores || [];
                const organograma = organogramaData.organograma || [];

                // Salvar no cache inteligente
                CacheManager.set('fornecedores', fornecedores);
                CacheManager.set('colaboradores', colaboradores);
                CacheManager.set('organograma', organograma);

                // Manter compatibilidade com código legado
                window.dadosFornecedores = fornecedores;
                window.dadosColaboradores = colaboradores;
                window.dadosOrganograma = organograma;

                console.log(`✅ Dados salvos no cache:`, {
                    fornecedores: fornecedores.length,
                    colaboradores: colaboradores.length,
                    organograma: organograma.length
                });
                
                // Debug do organograma carregado
                if (window.dadosOrganograma.length > 0) {
                    console.log(`🎯 Organograma carregado no login:`);
                    window.dadosOrganograma.forEach((org, index) => {
                        console.log(`   ${index}: EQUIPE=${org.EQUIPE}, COORDENADOR=${org.COORDENADOR}, SUPERVISOR=${org.SUPERVISOR}, LIDER=${org.LIDER}`);
                    });
                    
                    // 🚀 BUSCAR PAGCORP DO LÍDER JÁ NO LOGIN
                    const lider = window.dadosOrganograma[0]?.LIDER;
                    if (lider) {
                        console.log(`🔍 Buscando PAGCORP para líder "${lider}" no login...`);
                        try {
                            const pagcorpResponse = await fetch(`${getServerBaseUrl()}/api/pagcorp?lider=${encodeURIComponent(lider)}`);
                            if (pagcorpResponse.ok) {
                                const pagcorpData = await pagcorpResponse.json();
                                if (!pagcorpData.error) {
                                    window.dadosPagcorp = pagcorpData.pagcorp || [];
                                    console.log(`✅ PAGCORP carregado no login: ${window.dadosPagcorp.length} registros`);
                                } else {
                                    window.dadosPagcorp = [];
                                    console.log('❌ Erro ao buscar PAGCORP no login:', pagcorpData.message);
                                }
                            } else {
                                window.dadosPagcorp = [];
                                console.log('❌ Erro na API do PAGCORP no login');
                            }
                        } catch (e) {
                            window.dadosPagcorp = [];
                            console.warn('❌ Erro ao buscar PAGCORP no login:', e);
                        }
                    } else {
                        window.dadosPagcorp = [];
                        console.log('❌ Nenhum líder encontrado no organograma para buscar PAGCORP');
                    }
                } else {
                    window.dadosPagcorp = [];
                    console.log(`⚠️ Nenhum dado de organograma encontrado para projeto=${projeto}, equipe=${equipe}`);
                }
                
                // Salvar cache offline (INCLUINDO organograma e PAGCORP)
                const cacheData = {
                    fornecedores: window.dadosFornecedores,
                    organograma: window.dadosOrganograma, // ✅ Agora incluído no cache
                    colaboradores: window.dadosColaboradores,
                    pagcorp: window.dadosPagcorp, // ✅ Agora incluído no cache
                    projeto: projeto,
                    equipe: equipe,
                    timestamp: Date.now()
                };
                // 🎯 Cache agora gerenciado pelo CacheManager (já salvo acima)
                console.log('💾 Cache de dados completo gerenciado pelo CacheManager');
                
                // Popular colaboradores na interface
                popularColaboradores(window.dadosColaboradores);
                
                // 👤 ATUALIZAR NOME DO USUÁRIO COM DADOS DO ORGANOGRAMA
                const equipeAtual = localStorage.getItem('equipe_logada') || equipe;
                atualizarNomeUsuario(equipeAtual);
                
                // Mostrar dados no console
                console.log('Fornecedores:', window.dadosFornecedores);
                console.log('Colaboradores:', window.dadosColaboradores);
                console.log('Organograma:', window.dadosOrganograma);
                console.log('Pagcorp:', window.dadosPagcorp);
                
                return true;
                
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                
                // ✅ SEMPRE PERMITIR LOGIN - MESMO COM ERRO NAS APIs
                console.log('⚠️ Erro nas APIs, mas permitindo login com dados vazios...');
                
                // Tentar carregar dados do cache offline
                console.log('📱 Tentando carregar dados do cache offline...');
                const cacheSuccess = carregarDadosDoCache(projeto, equipe);
                
                if (cacheSuccess) {
                    console.log('✅ Dados carregados do cache offline');
                    return true;
                } else {
                    // ✅ FORÇAR LOGIN COM DADOS VAZIOS
                    console.log('⚠️ Sem cache, mas permitindo login com dados vazios');
                    window.dadosFornecedores = [];
                    window.dadosOrganograma = [];
                    window.dadosColaboradores = [];
                    window.dadosPagcorp = [];
                    
                    console.log('✅ Login permitido com dados vazios');
                    return true; // ← SEMPRE RETORNAR TRUE
                }
            }
        }

        // Função para carregar dados do cache offline
        function carregarDadosDoCache(projeto, equipe) {
            try {
                const cacheData = localStorage.getItem('dadosAPI_cache');
                if (!cacheData) {
                    console.log('❌ Nenhum cache encontrado');
                    return false;
                }
                
                const cache = JSON.parse(cacheData);
                
                // ✅ VERIFICAR SE CACHE É DA EQUIPE CORRETA ANTES DE USAR
                if (cache.projeto === projeto && cache.equipe === equipe) {
                    console.log('✅ Cache encontrado para a equipe correta - usando cache');
                    console.log(`📋 Cache: projeto=${cache.projeto}, equipe=${cache.equipe}`);
                    
                    // Carregar dados do cache (equipe correta)
                    window.dadosFornecedores = cache.fornecedores || [];
                    window.dadosOrganograma = cache.organograma || [];
                    window.dadosColaboradores = cache.colaboradores || [];
                    window.dadosPagcorp = cache.pagcorp || [];
                    
                    console.log(`🎯 DEBUG CACHE - Organograma carregado:`, window.dadosOrganograma);
                } else {
                    console.log('⚠️ Cache é de equipe diferente - não usando cache');
                    console.log(`📋 Cache: projeto=${cache.projeto}, equipe=${cache.equipe}`);
                    console.log(`📋 Solicitado: projeto=${projeto}, equipe=${equipe}`);
                    return false; // Não usar cache de equipe diferente
                }
                
                // Popular interface
                popularColaboradores(window.dadosColaboradores);
                
                // Mostrar idade do cache
                const cacheAge = Date.now() - (cache.timestamp || 0);
                const cacheAgeMinutes = Math.floor(cacheAge / (1000 * 60));
                console.log(`🕐 Cache carregado (${cacheAgeMinutes} minutos atrás)`);
                console.log('📊 Fornecedores do cache:', window.dadosFornecedores.length);
                console.log('📊 Organograma do cache:', window.dadosOrganograma.length);
                console.log('📊 Colaboradores do cache:', window.dadosColaboradores.length);
                console.log('📊 Pagcorp do cache:', window.dadosPagcorp.length);
                
                return true;
                
            } catch (error) {
                console.error('❌ Erro ao carregar cache:', error);
                return false;
            }
        }

        // Exibe fornecedores e tipos permitidos na interface
        function exibirFornecedores(fornecedores) {
            var lista = document.getElementById('fornecedoresLista');
            if (!lista) return;
            lista.innerHTML = '';
            fornecedores.forEach(f => {
                var tiposPermitidos = [];
                if (f.TIPO.includes('CAFE')) tiposPermitidos.push('Café da Manhã: R$ ' + (f.CAFE ? f.CAFE.toFixed(2) : '--'));
                if (f.TIPO.includes('ALMOCO_MARMITEX')) tiposPermitidos.push('Almoço Marmitex: R$ ' + (f.ALMOCO_MARMITEX ? f.ALMOCO_MARMITEX.toFixed(2) : '--'));
                if (f.TIPO.includes('ALMOCO_LOCAL')) tiposPermitidos.push('Almoço Local: R$ ' + (f.ALMOCO_LOCAL ? f.ALMOCO_LOCAL.toFixed(2) : '--'));
                if (f.TIPO.includes('JANTA_MARMITEX')) tiposPermitidos.push('Janta Marmitex: R$ ' + (f.JANTA_MARMITEX ? f.JANTA_MARMITEX.toFixed(2) : '--'));
                if (f.TIPO.includes('JANTA_LOCAL')) tiposPermitidos.push('Janta Local: R$ ' + (f.JANTA_LOCAL ? f.JANTA_LOCAL.toFixed(2) : '--'));
                var tiposHtml = tiposPermitidos.length ? tiposPermitidos.map(t => `<li>${t}</li>`).join('') : '<li style="color:#dc2626">Nenhum tipo permitido</li>';
                lista.innerHTML += `<div style="margin-bottom:18px;padding:12px;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb">
                    <strong>${f.FORNECEDOR}</strong><br>
                    <ul style="margin:8px 0 0 0;padding-left:18px">${tiposHtml}</ul>
                </div>`;
            });
        }

        // Função para popular colaboradores dinamicamente
        function popularColaboradores(colaboradores) {
            const employeesList = document.getElementById('employees-list');
            const colaboradoresLabel = document.getElementById('colaboradores-label');
            
            if (!employeesList || !colaboradores) return;
            
            // Limpar lista existente
            employeesList.innerHTML = '';
            
            // Atualizar label com contador
            colaboradoresLabel.textContent = `Selecione os Colaboradores (${colaboradores.length} disponíveis)`;
            
            // Criar item para cada colaborador
            colaboradores.forEach((colaborador, index) => {
                const isLider = colaborador.IS_LIDER || colaborador.CLASSE === 'LDF';
                const nomeCompleto = colaborador.NOME || '';
                const funcao = colaborador.FUNCAO || '';
                const id = colaborador.ID || index;
                
                // Criar elemento HTML
                const label = document.createElement('label');
                label.className = 'employee-item';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.setAttribute('data-employee', `colab_${id}`);
                input.setAttribute('data-nome', nomeCompleto);
                
                // Adicionar event listener para cada checkbox
                input.addEventListener('change', function() {
                    const employee = this.dataset.employee;
                    if (this.checked) {
                        if (selectedEmployees.indexOf(employee) === -1) {
                            selectedEmployees.push(employee);
                        }
                    } else {
                        const index = selectedEmployees.indexOf(employee);
                        if (index > -1) {
                            selectedEmployees.splice(index, 1);
                        }
                    }
                    updateSummary();
                });
                
                const span = document.createElement('span');
                if (isLider) {
                    span.innerHTML = `⭐ <strong>${nomeCompleto}</strong> - ${funcao} (Líder)`;
                    span.style.color = '#d97706'; // Cor dourada para líderes
                    span.style.fontWeight = 'bold';
                } else {
                    span.innerHTML = `👤 ${nomeCompleto} - ${funcao}`;
                }
                
                label.appendChild(input);
                label.appendChild(span);
                employeesList.appendChild(label);
            });
            
            console.log(`✅ ${colaboradores.length} colaboradores carregados na interface`);
        }

        // Função para selecionar/desselecionar todos os colaboradores
        function toggleSelecionarTodos() {
            const employeesList = document.getElementById('employees-list');
            const botao = document.getElementById('btn-selecionar-todos');
            
            if (!employeesList || !botao) return;
            
            const checkboxes = employeesList.querySelectorAll('input[type="checkbox"]');
            const todosSelecionados = Array.from(checkboxes).every(checkbox => checkbox.checked);
            
            // Se todos estão selecionados, desselecionar todos; senão, selecionar todos
            const novoEstado = !todosSelecionados;
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = novoEstado;
                // IMPORTANTE: Disparar o evento change para cada checkbox
                const event = new Event('change', { bubbles: true });
                checkbox.dispatchEvent(event);
            });
            
            // Atualizar texto do botão
            if (novoEstado) {
                botao.textContent = 'Desselecionar Todos';
                botao.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                botao.style.boxShadow = '0 2px 8px rgba(239, 68, 68, 0.3)';
            } else {
                botao.textContent = 'Selecionar Todos';
                botao.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                botao.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.3)';
            }
            
            console.log(`${novoEstado ? 'Selecionados' : 'Desmarcados'} todos os colaboradores (${checkboxes.length} total)`);
        }

        // Função para atualizar todos os dados (colaboradores, organograma, fornecedores, pedidos, etc.)
        async function atualizarTodosDados() {
            const botao = document.getElementById('btn-atualizar-dados');
            if (!botao) return;
            
            // Verificar se há conexão com internet
            if (!navigator.onLine) {
                alert('❌ Sem conexão com a internet!\n\nPor favor, verifique sua conexão e tente novamente.');
                return;
            }
            
            // Obter dados de login salvos
            const dadosLogin = JSON.parse(localStorage.getItem('loginData') || '{}');
            const equipe = dadosLogin.equipe;
            const projeto = dadosLogin.projeto;
            
            if (!equipe || !projeto) {
                alert('❌ Erro: Não foi possível identificar os dados de login');
                return;
            }
            
            // Mostrar loading no card
            const buttonContent = botao.querySelector('.button-content h3');
            const originalText = buttonContent ? buttonContent.textContent : 'Atualizar Dados';
            
            botao.classList.add('disabled', 'loading');
            if (buttonContent) buttonContent.textContent = 'Atualizando...';
            
            try {
                console.log('🔄 Atualizando todos os dados...');
                
                // Salvar seleções atuais dos colaboradores antes de atualizar
                const selecoesColaboradores = [];
                const checkboxes = document.querySelectorAll('#employees-list input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    selecoesColaboradores.push(checkbox.dataset.nome);
                });
                
                // Limpar apenas dados em memória (não o cache)
                console.log('🧹 Limpando dados em memória...');
                window.dadosFornecedores = [];
                window.dadosOrganograma = [];
                window.dadosColaboradores = [];
                window.dadosPagcorp = [];
                
                // Buscar todos os dados atualizados das APIs
                console.log('📡 Buscando dados atualizados...');
                const sucessoAPI = await buscarDadosPorProjetoEquipe(projeto, equipe);
                
                if (!sucessoAPI) {
                    throw new Error('Falha ao buscar dados das APIs');
                }
                
                // Recarregar pendências de temperatura
                console.log('🌡️ Atualizando pendências de temperatura...');
                await loadPendingTemperatures();
                
                // Restaurar seleções dos colaboradores (quando possível)
                let selecoesRestauradas = 0;
                if (selecoesColaboradores.length > 0) {
                    setTimeout(() => {
                        selecoesColaboradores.forEach(nomeColaborador => {
                            const checkbox = document.querySelector(`#employees-list input[data-nome="${nomeColaborador}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                                selecoesRestauradas++;
                            }
                        });
                    }, 200);
                }
                
                // Mostrar resultado
                console.log('✅ Todos os dados atualizados');
                
                let mensagem = `✅ Todos os dados foram atualizados!\n\n`;
                mensagem += `📊 Fornecedores: ${(window.dadosFornecedores || []).length}\n`;
                mensagem += `👥 Colaboradores: ${(window.dadosColaboradores || []).length}\n`;
                mensagem += `🏢 Organograma: ${(window.dadosOrganograma || []).length}\n`;
                mensagem += `💳 PAGCORP: ${(window.dadosPagcorp || []).length}\n`;
                mensagem += `🌡️ Pendências: ${(pendingTemperatures || []).length}`;
                
                if (selecoesColaboradores.length > 0) {
                    mensagem += `\n\n🔄 ${selecoesRestauradas}/${selecoesColaboradores.length} seleções de colaboradores restauradas`;
                }
                
                alert(mensagem);
                
            } catch (error) {
                console.error('❌ Erro ao atualizar dados:', error);
                alert('❌ Erro ao atualizar dados.\n\nVerifique sua conexão com a internet e tente novamente.\n\nDetalhes: ' + error.message);
            } finally {
                // Restaurar card
                botao.classList.remove('disabled', 'loading');
                if (buttonContent) buttonContent.textContent = originalText;
            }
        }

        // Função para carregar fornecedores filtrados por tipo de refeição
        function carregarFornecedoresPorTipo(mealType) {
            // 🎯 Buscar fornecedores do cache gerenciado
            const fornecedores = CacheManager.get('fornecedores') || [];
            
            // Mapear tipos de refeição do sistema para os tipos da tabela (TIPO_FORN)
            const mealTypeMapping = {
                'cafe': 'CAFÉ',
                'almoco_marmitex': 'ALMOÇO MARMITEX', 
                'almoco_local': 'ALMOÇO LOCAL',
                'janta_marmitex': 'JANTA MARMITEX',
                'janta_local': 'JANTA LOCAL'
            };
            
            const tipoRefeicao = mealTypeMapping[mealType];
            if (!tipoRefeicao) return;
            
            // Filtrar fornecedores por tipo de refeição (usando TIPO_FORN)
            const fornecedoresFiltrados = fornecedores.filter(f => f.TIPO_FORN === tipoRefeicao);
            
            // Obter o select correspondente
            const select = document.querySelector(`select[data-meal="${mealType}"]`);
            if (!select) return;
            
            // Limpar opções existentes (exceto a primeira e a última)
            while (select.children.length > 2) {
                select.removeChild(select.children[1]);
            }
            
            // Adicionar fornecedores filtrados
            fornecedoresFiltrados.forEach(fornecedor => {
                const option = document.createElement('option');
                option.value = fornecedor.FORNECEDOR.toLowerCase().replace(/\s+/g, '_');
                
                // Truncar texto longo para mobile
                let displayText = fornecedor.FORNECEDOR;
                if (window.innerWidth <= 480 && displayText.length > 35) {
                    displayText = displayText.substring(0, 32) + '...';
                }
                
                option.textContent = displayText;
                option.dataset.preco = fornecedor.VALOR;
                option.title = fornecedor.FORNECEDOR; // Tooltip com nome completo
                select.insertBefore(option, select.lastElementChild);
            });
            
            console.log(`Fornecedores para ${tipoRefeicao}:`, fornecedoresFiltrados);
        }

        // Função para salvar pedidos no banco de dados
        async function salvarPedidosNoBanco(dataRetirada, nomeLider, totalColaboradores) {
            console.log('💾 Iniciando salvamento no banco...');
            console.log(`🔍 DEBUG CRÍTICO: selectedMeals =`, selectedMeals);
            console.log(`🔍 DEBUG CRÍTICO: selectedMeals.length = ${selectedMeals.length}`);
            
            // VERIFICAR quais botões estão selecionados
            const botoesSelecionados = document.querySelectorAll('.meal-btn.selected');
            console.log(`🔍 DEBUG: Botões selecionados no DOM:`, Array.from(botoesSelecionados).map(btn => btn.textContent.trim()));
            
            // VERIFICAR se todas as refeições têm fornecedor selecionado
            botoesSelecionados.forEach(btn => {
                const mealType = btn.onclick.toString().match(/'([^']+)'/)?.[1];
                const select = document.querySelector(`select[data-meal="${mealType}"]`);
                console.log(`🔍 DEBUG: ${mealType} - fornecedor selecionado: ${select?.value || 'NENHUM'}`);
            });
            
            if (selectedMeals.length === 0) {
                console.error('❌ ERRO CRÍTICO: selectedMeals está vazio!');
                alert('Erro: Nenhuma refeição foi selecionada corretamente. Tente selecionar as refeições novamente.');
                return;
            }
            
            for (var i = 0; i < selectedMeals.length; i++) {
                const mealType = selectedMeals[i];
                console.log(`🔍 DEBUG: Processando refeição ${i + 1}/${selectedMeals.length}: ${mealType}`);
                
                const supplier = getSelectedSupplier(mealType);
                const price = getCustomPrice(mealType);
                const valorTotal = price * totalColaboradores;
                
                // Obter nome completo do fornecedor
                let nomeCompletoFornecedor = supplier;
                if (window.dadosFornecedores && window.dadosFornecedores.fornecedores) {
                    const fornecedor = window.dadosFornecedores.fornecedores.find(f => 
                        f.FORNECEDOR.toLowerCase().replace(/\s+/g, '_') === supplier
                    );
                    if (fornecedor) {
                        nomeCompletoFornecedor = fornecedor.FORNECEDOR;
                    }
                }
                
                // Mapear tipo de refeição para o formato do banco
                let tipoRefeicao = '';
                switch(mealType) {
                    case 'cafe': tipoRefeicao = 'CAFÉ DA MANHÃ'; break;
                    case 'almoco_marmitex': tipoRefeicao = 'ALMOÇO MARMITEX'; break;
                    case 'almoco_local': tipoRefeicao = 'ALMOÇO LOCAL'; break;
                    case 'janta_marmitex': tipoRefeicao = 'JANTA MARMITEX'; break;
                    case 'janta_local': tipoRefeicao = 'JANTA LOCAL'; break;
                    default: tipoRefeicao = mealType.toUpperCase();
                }
                
                // Coletar TODOS os dados do formulário - COM DEBUG
                const cidade = document.getElementById('serviceCityInput')?.value || '';
                const hospedado = document.querySelector('input[name="isHosted"]:checked')?.value || 'nao';
                const hospedadoFormatado = hospedado === 'sim' ? 'SIM' : 'NÃO';
                const nomeHotel = document.getElementById('hotelNameInput')?.value?.trim() || '';
                const valorDiaria = parseFloat(document.getElementById('dailyRateInput')?.value || 0);
                
                console.log(`🏨 HOSPEDAGEM DEBUG: hospedado="${hospedado}" (formatado="${hospedadoFormatado}"), hotel="${nomeHotel}", diaria="${valorDiaria}"`);
                
                // Obter dados do login (projeto, equipe, organograma)
                const dadosLogin = JSON.parse(localStorage.getItem('loginData') || '{}');
                const projeto = dadosLogin.projeto || '';
                const equipe = dadosLogin.equipe || '';
                
                // Buscar dados do organograma para coordenador/supervisor/NOME_LIDER
                let coordenador = '';
                let supervisor = '';
                let nomeLiderOrganograma = ''; // Nome do líder do organograma
                
                if (window.dadosOrganograma && window.dadosOrganograma.length > 0) {
                    console.log(`🔍 Buscando no organograma pela equipe: "${equipe}"`);
                    console.log(`📊 Total registros no organograma: ${window.dadosOrganograma.length}`);
                    
                    // Buscar especificamente pela equipe digitada
                    const orgData = window.dadosOrganograma.find(org => 
                        org.EQUIPE && org.EQUIPE.toString().trim() === equipe.toString().trim()
                    );
                    
                    if (orgData) {
                        coordenador = orgData.COORDENADOR || '';
                        supervisor = orgData.SUPERVISOR || '';
                        nomeLiderOrganograma = orgData.LIDER || '';
                        console.log(`✅ Organograma encontrado para equipe "${equipe}":`);
                        console.log(`   COORDENADOR: "${coordenador}"`);
                        console.log(`   SUPERVISOR: "${supervisor}"`);
                        console.log(`   NOME_LIDER: "${nomeLiderOrganograma}"`);
                    } else {
                        console.log(`⚠️ Organograma não encontrado para equipe "${equipe}"`);
                        console.log(`📋 Equipes disponíveis:`, window.dadosOrganograma.map(org => org.EQUIPE));
                        
                        // Fallback para o primeiro registro se não encontrar pela equipe
                        const orgDataFallback = window.dadosOrganograma[0];
                        coordenador = orgDataFallback.COORDENADOR || '';
                        supervisor = orgDataFallback.SUPERVISOR || '';
                        nomeLiderOrganograma = orgDataFallback.LIDER || '';
                        console.log(`🔄 Usando fallback (primeiro registro do organograma)`);
                    }
                } else {
                    console.log(`⚠️ Nenhum dado de organograma disponível`);
                }
                
                // 🎯 USAR SUPPLIERMANAGER INTELIGENTE PARA FECHAMENTO
                const supplierInfo = SupplierManager.getInfo(mealType);
                // supplier já foi declarado acima, apenas reutilizar
                let fazendaFornecedor = supplierInfo?.cached?.FAZENDA || supplierInfo?.cached?.LOCAL || '';
                let fechamentoFornecedor = SupplierManager.getFechamento(mealType);

                console.log(`🎯 FORNECEDOR INFO:`, {
                    nome: supplier,
                    customizado: supplierInfo?.isCustom,
                    noCache: supplierInfo?.inCache,
                    fazenda: fazendaFornecedor,
                    fechamento: fechamentoFornecedor
                });
                
                // Coletar apenas os nomes dos colaboradores selecionados (NÃO incluir A CONTRATAR aqui)
                const colaboradoresSelecionados = [];
                const checkboxes = document.querySelectorAll('#employees-list input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    let nomeCompleto = checkbox.parentElement.querySelector('span').textContent.trim();
                    // Remover ícones e caracteres Unicode problemáticos
                    nomeCompleto = nomeCompleto
                        .replace(/^[👤⭐🔧👨‍💼💼]\s*/, '') // Remover ícones conhecidos
                        .replace(/[\u{1F000}-\u{1F6FF}]/gu, '') // Remover emojis
                        .replace(/[\uD800-\uDFFF]/g, '') // Remover surrogates problemáticos
                        .replace(/[^\x00-\x7F\u00C0-\u017F\u0020-\u007E]/g, '') // Manter apenas ASCII + acentos
                        .trim();
                    if (nomeCompleto) {
                        colaboradoresSelecionados.push(nomeCompleto);
                    }
                });
                
                // A_CONTRATAR = apenas o número (não adicionar na lista de nomes)
                const naoContratadosCountAtual = window.naoContratadosCount || 0;
                
                // Adicionar "OUTROS PARTICIPANTES" do array dinâmico aos nomes
                if (window.otherParticipants && window.otherParticipants.length > 0) {
                    // Adicionar cada nome do array dinâmico (aceitar ambos os formatos)
                    const outrosNomes = window.otherParticipants.map(p => p.nome || p.name).filter(nome => nome && nome.trim());
                    colaboradoresSelecionados.push(...outrosNomes);
                    console.log(`📝 OUTROS PARTICIPANTES: ${outrosNomes.join(', ')}`);
                }
                
                const colaboradoresNomesLimpos = colaboradoresSelecionados.join(', ');
                
                // TOTAL COLABORADORES = selecionados + A_CONTRATAR + outros participantes
                const totalOutros = window.otherParticipants ? window.otherParticipants.length : 0;
                let totalColaboradoresFinal = colaboradoresSelecionados.length + naoContratadosCountAtual;
                
                // Garantir que pedidos avulsos sempre tenham pelo menos 1 colaborador
                if (totalColaboradoresFinal === 0) {
                    totalColaboradoresFinal = 1;
                    console.log('🎯 Pedido avulso detectado - ajustando totalColaboradoresFinal para 1');
                }
                
                console.log(`👥 COLABORADORES FINAIS: ${colaboradoresSelecionados.length - totalOutros} selecionados + ${totalOutros} outros + ${naoContratadosCountAtual} a contratar = ${totalColaboradoresFinal} total`);
                console.log(`📝 NOMES: "${colaboradoresNomesLimpos}"`);
                console.log(`🔢 A_CONTRATAR: ${naoContratadosCountAtual}`);
                const pagcorpDigitado = document.getElementById('pagcorpInput')?.value?.trim() || '';
                let pagcorpNumero = pagcorpDigitado;
                
                // Se não foi digitado, tentar buscar dos dados automáticos
                if (!pagcorpNumero && window.dadosPagcorp && window.dadosPagcorp.length > 0) {
                    pagcorpNumero = window.dadosPagcorp[0].CONTA || window.dadosPagcorp[0].PAGCORP || '';
                }
                
                console.log(`🔍 PAGCORP FINAL: digitado="${pagcorpDigitado}", automático="${window.dadosPagcorp?.[0]?.CONTA || 'nenhum'}", usado="${pagcorpNumero}"`);
                
                // FAZENDA = USAR APENAS O QUE FOI DIGITADO, NÃO DO FORNECEDOR
                const fazendaDigitada = document.getElementById('farmNameInput')?.value?.trim() || '';
                
                // Determinar status de aferição de temperatura baseado no tipo de refeição
                let aferiuTemperatura = 'NAO_NECESSITA'; // Padrão para CAFÉ, ALMOÇO LOCAL, JANTA LOCAL
                
                // MARMITEX precisa de aferição de temperatura
                if (tipoRefeicao === 'ALMOÇO MARMITEX' || tipoRefeicao === 'JANTA MARMITEX' || 
                    tipoRefeicao.includes('MARMITEX') || tipoRefeicao.includes('MARMITA')) {
                    aferiuTemperatura = 'NAO'; // Precisa aferir mas ainda não foi aferido
                }
                
                const pedidoData = {
                    // Dados básicos (valor_pago é UNITÁRIO, não total)
                    data_retirada: dataRetirada,
                    nome_lider: nomeLider,
                    tipo_refeicao: tipoRefeicao,
                    fornecedor: nomeCompletoFornecedor,
                    valor_pago: price, // VALOR UNITÁRIO por pessoa
                    total_colaboradores: totalColaboradoresFinal, // TOTAL REAL incluindo tudo
                    
                    // Dados completos do projeto
                    projeto: projeto,
                    coordenador: coordenador,
                    supervisor: supervisor,
                    
                    // CORREÇÕES ESPECÍFICAS:
                    equipe: equipe, // LIDER = equipe digitada (ex: 700AA)
                    nome_lider_organograma: nomeLiderOrganograma, // NOME_LIDER = nome do líder do organograma
                    fazenda_digitada: fazendaDigitada, // FAZENDA = SEMPRE o que foi digitado pelo usuário
                    fechamento_fornecedor: fechamentoFornecedor, // FECHAMENTO = da tabela fornecedores
                    
                    cidade_prestacao_servico: cidade,
                    
                    // Colaboradores LIMPOS (sem ícones)
                    colaboradores_nomes_limpos: colaboradoresNomesLimpos,
                    a_contratar: naoContratadosCountAtual || 0,
                    
                    // Dados financeiros - RESPONSÁVEL PELO CARTÃO digitado
                    responsavel_cartao: document.getElementById('cardResponsibleInput')?.value?.trim() || nomeLider,
                    pagcorp_numero: document.getElementById('pagcorpInput')?.value?.trim() || '', // PAGCORP digitado
                    
                    // Hospedagem CORRETA - pegar valores dos campos reais
                    hospedado_real: hospedadoFormatado,
                    nome_hotel_real: document.getElementById('hotelNameInput')?.value?.trim() || '',
                    valor_diaria_real: parseFloat(document.getElementById('dailyRateInput')?.value || 0),
                    
                    // Status de aferição de temperatura
                    aferiu_temperatura: aferiuTemperatura,
                    
                    // Observações
                    observacoes: `Pedido criado via app. Equipe: ${equipe}. Colaboradores: ${colaboradoresSelecionados.length} selecionados + ${naoContratadosCountAtual} a contratar = ${totalColaboradoresFinal} total.`
                };
                
                console.log(`📤 ENVIANDO DADOS COMPLETOS (CORRIGIDOS):`);
                console.log(`   🍽️ Refeição: ${tipoRefeicao}`);
                console.log(`   🏪 Fornecedor: ${nomeCompletoFornecedor}`);
                console.log(`   💰 Valor unitário: R$ ${price.toFixed(2)}`);
                console.log(`   👥 Colaboradores: ${totalColaboradores} pessoas`);
                console.log(`   �️ Aferição temperatura: ${aferiuTemperatura}`);
                console.log(`   �🏢 Projeto: ${projeto} | Equipe: ${equipe}`);
                console.log(`   👔 Coordenador: ${coordenador} | Supervisor: ${supervisor}`);
                console.log(`   🔧 CORREÇÕES:`);
                console.log(`      LIDER (equipe): ${equipe}`);
                console.log(`      NOME_LIDER (organograma): ${nomeLiderOrganograma}`);
                console.log(`      FAZENDA: ${fazendaDigitada} (IGNORANDO fornecedor: ${fazendaFornecedor})`);
                console.log(`      PAGCORP: ${pagcorpNumero}`);
                console.log(`      HOSPEDADO: ${hospedadoFormatado} (${hospedadoFormatado === 'SIM' ? `${nomeHotel}, R$ ${valorDiaria}` : 'sem hotel'})`);
                console.log(`      FECHAMENTO: ${fechamentoFornecedor}`);
                console.log(`   📄 Colaboradores (sem ícones): ${colaboradoresNomesLimpos || 'Nenhum'}`);
                console.log(pedidoData);
                
                // 🔄 INTEGRAÇÃO COM SISTEMA OFFLINE
                if (!navigator.onLine) {
                    // Se offline, adicionar à fila local
                    const pedidoOffline = {
                        tipo: 'database_save',
                        data: pedidoData,
                        timestamp: new Date().toISOString(),
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                    };
                    
                    // Carregar fila existente
                    let databaseQueue = [];
                    try {
                        const saved = localStorage.getItem('databaseQueue');
                        databaseQueue = saved ? JSON.parse(saved) : [];
                    } catch (e) {
                        databaseQueue = [];
                    }
                    
                    databaseQueue.push(pedidoOffline);
                    localStorage.setItem('databaseQueue', JSON.stringify(databaseQueue));
                    updateDatabaseQueueCounter(); // Atualizar contador visual
                    syncQueueWithServiceWorker(); // Sincronizar com Service Worker
                    scheduleBackgroundSync(); // Agendar processamento automático
                    
                    // Marcar que um pedido foi enviado offline
                    pedidoEnviadoOffline = true;
                    
                    console.log(`📱 OFFLINE: ${tipoRefeicao} adicionado à fila local (pedidoEnviadoOffline=true)`);
                    alert(`📱 Sem conexão! ${tipoRefeicao} foi salvo na fila offline e será enviado automaticamente quando houver internet.`);
                    continue;
                }
                
                try {
                    console.log(`🚀 ENVIANDO para o servidor: ${getServerBaseUrl()}/api/salvar-pedido`);
                    const response = await fetch(`${getServerBaseUrl()}/api/salvar-pedido`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(pedidoData)
                    });
                    
                    console.log(`📡 Resposta do servidor: status=${response.status}, ok=${response.ok}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log(`📥 Resultado recebido:`, result);
                    
                    if (result.error) {
                        console.error(`❌ Erro ao salvar ${tipoRefeicao}:`, result.message);
                        alert(`Erro ao salvar ${tipoRefeicao}: ${result.message}`);
                    } else {
                        console.log(`✅ ${tipoRefeicao} salvo com sucesso!`);
                    }
                    
                } catch (error) {
                    console.error(`❌ Erro de conexão ao salvar ${tipoRefeicao}:`, error);
                    
                    // Se erro de conexão, adicionar à fila offline
                    const pedidoOffline = {
                        tipo: 'database_save',
                        data: pedidoData,
                        timestamp: new Date().toISOString(),
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                    };
                    
                    let databaseQueue = [];
                    try {
                        const saved = localStorage.getItem('databaseQueue');
                        databaseQueue = saved ? JSON.parse(saved) : [];
                    } catch (e) {
                        databaseQueue = [];
                    }
                    
                    databaseQueue.push(pedidoOffline);
                    localStorage.setItem('databaseQueue', JSON.stringify(databaseQueue));
                    updateDatabaseQueueCounter(); // Atualizar contador visual
                    syncQueueWithServiceWorker(); // Sincronizar com Service Worker
                    scheduleBackgroundSync(); // Agendar processamento automático
                    
                    alert(`❌ Erro de conexão! ${tipoRefeicao} foi salvo na fila offline e será enviado automaticamente quando houver internet.`);
                }
            }
            
            console.log('💾 Processo de salvamento concluído!');
        }
        
        // Função para mostrar notificação de boas-vindas
        function showWelcomeNotification() {
            if ('serviceWorker' in navigator && swRegistration) {
                swRegistration.showNotification('🍽️ Sistema de Refeições Ativo!', {
                    body: 'Notificações habilitadas! Você receberá lembretes diários às 19:30 para fazer seus pedidos. 😊',
                    icon: '/icon-192x192.png',
                    badge: '/icon-192x192.png',
                    tag: 'welcome-notification',
                    requireInteraction: false,
                    actions: [
                        {
                            action: 'ok',
                            title: '👍 Entendi'
                        }
                    ]
                });
            }
        }
        
        // 🔄 FUNÇÃO DE ATUALIZAÇÃO FORÇADA (Emergência)
        // Pressionar Ctrl+Shift+U para forçar atualização
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'U') {
                e.preventDefault();
                const forceUpdate = confirm(
                    `🔧 ATUALIZAÇÃO FORÇADA\n\n` +
                    `Isso irá:\n` +
                    `• Limpar TODO o cache\n` +
                    `• Recarregar a página\n` +
                    `• Forçar nova versão\n\n` +
                    `Use apenas se estiver com problemas!\n\n` +
                    `Continuar?`
                );
                
                if (forceUpdate) {
                    // Limpar TUDO
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }
                    
                    // Recarregar com força total
                    window.location.href = window.location.href + '?v=' + Date.now();
                }
            }
        });
    </script>
</body>
</html>